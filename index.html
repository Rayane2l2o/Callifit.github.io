<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#0b0d12" />
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
  <title>CalisFit · Calisthénie</title>
  <style>
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:#0b0d12;color:#e7edf7;font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",Inter,Roboto,system-ui,Segoe UI,Helvetica,Arial,sans-serif;-webkit-font-smoothing:antialiased;overscroll-behavior-y:none;-webkit-tap-highlight-color:transparent}
    :root{
      --bg:#0b0d12;--card:#0f1424;--muted:#a9b2c3;--accent:#ffd54a;--accent2:#5eead4;--ok:#4ade80;--danger:#ff6b6b;--ring:0 0 0 .12rem rgba(255,213,74,.4);--shadow:0 12px 32px rgba(0,0,0,.35);--radius:18px;--safe-b:calc(env(safe-area-inset-bottom));--safe-t:calc(env(safe-area-inset-top));--maxw:430px
    }
    .app{min-height:calc(var(--vh,1vh)*100);display:flex;flex-direction:column}
    .container{width:100%;max-width:var(--maxw);margin:0 auto}
    .topbar{position:sticky;top:0;z-index:20;background:linear-gradient(180deg,rgba(11,13,18,.95),rgba(11,13,18,.6));backdrop-filter:blur(10px);padding:calc(8px + var(--safe-t)) 16px 10px;border-bottom:1px solid rgba(255,255,255,.06)}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .logo{width:34px;height:34px;border-radius:10px;background:radial-gradient(120% 120% at 10% 10%, var(--accent) 0%, #fffa 40%, transparent 60%),linear-gradient(135deg,#141a2b,#0f1321);box-shadow:inset 0 0 0 1px rgba(255,255,255,.08),0 10px 24px rgba(255,213,74,.25)}
    .title{font-weight:800;font-size:18px}
    .subtitle{color:var(--muted);font-size:12px}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);color:var(--muted);font-size:12px}
    .tabs{position:fixed;left:0;right:0;bottom:0;height:90px;padding-bottom:var(--safe-b);background:rgba(10,12,18,.92);backdrop-filter:blur(12px);border-top:1px solid rgba(255,255,255,.06);display:grid;grid-template-columns:repeat(5,1fr);z-index:50}
    .tab{position:relative;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;color:var(--muted);text-decoration:none;font-size:12px;cursor:pointer;transition:200ms transform;min-height:64px;padding-top:8px}
    .tab:active{transform:translateY(1px)}
    .ico{width:28px;height:28px;border-radius:10px;display:grid;place-items:center;background:transparent;box-shadow:none}
    .tab.active{color:#fff}
    .tab.active .ico{box-shadow:none}
    main{padding:12px 14px 110px}
    section{display:none;opacity:0;transform:translateY(8px);transition:opacity .25s ease,transform .25s ease}
    section.active{display:block;opacity:1;transform:none}
    section > *{max-width:var(--maxw);margin:0 auto 14px}
    .card{background:linear-gradient(180deg,#0f1424,#0c1120);border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
    .grid{display:grid;gap:14px}
    .grid.two{grid-template-columns:1fr 1fr}
    .grid.three{grid-template-columns:repeat(3,1fr)}
    .btn{appearance:none;border:0;padding:12px 14px;border-radius:14px;background:#1a2236;color:#eaf1ff;box-shadow:inset 0 0 0 1px rgba(255,255,255,.08);display:inline-flex;align-items:center;gap:10px;cursor:pointer}
    .btn.primary{background:linear-gradient(135deg,#1f2333,#1a1f2e);box-shadow:inset 0 0 0 1px rgba(255,255,255,.08),0 10px 24px rgba(255,213,74,.15)}
    .btn.ghost{background:transparent;box-shadow:inset 0 0 0 1px rgba(255,255,255,.15)}
    .h1{font-size:22px;font-weight:800}
    .h2{font-size:16px;font-weight:700}
    .label{font-size:12px;color:var(--muted)}
    .pill{font-size:11px;padding:6px 9px;border-radius:999px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08)}
    .workout-item{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;padding:10px;border-radius:14px;background:linear-gradient(180deg,#10162a,#0c1120);border:1px solid rgba(255,255,255,.06)}
    .workout-item.done{opacity:.6}
    .counter{display:flex;align-items:center;gap:6px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);padding:6px;border-radius:12px}
    .counter button{width:32px;height:32px;border-radius:10px;background:#192036;color:#fff;border:1px solid rgba(255,255,255,.08)}
    .timer{display:grid;place-items:center;padding:14px}
    .time{font-size:42px;font-weight:800;letter-spacing:1px}
    .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .day{aspect-ratio:1/1;display:grid;place-items:center;font-size:12px;color:var(--muted);border:1px dashed rgba(255,255,255,.08);border-radius:10px}
    .day.done{background:rgba(74,222,128,.15);color:#eafff3;border:1px solid rgba(74,222,128,.3)}
    .day.off{background:rgba(255,107,107,.12);color:#ffeaea;border:1px solid rgba(255,107,107,.28)}
    @media (orientation:landscape){
      main{padding-bottom:96px}
      .grid.two{grid-template-columns:1.2fr .8fr}
      .time{font-size:36px}
    }
    @media (max-width:430px){
      .grid.two{grid-template-columns:1fr}
      .grid.three{grid-template-columns:1fr 1fr}
      .time{font-size:clamp(28px,8vw,42px)}
      .h1{font-size:clamp(18px,5vw,22px)}
      .h2{font-size:clamp(14px,4.5vw,16px)}
    }
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}
    :focus-visible{outline:2px solid var(--accent);outline-offset:2px}
    @media print{
      body{background:#fff;color:#000}
      .tabs,.topbar{display:none !important}
      main{padding:0}
      .card{box-shadow:none;border:1px solid #ccc}
    }
  .tab.active::after{content:'';position:absolute;top:6px;width:28px;height:4px;border-radius:999px;background:linear-gradient(90deg,var(--accent),var(--accent2));box-shadow:0 2px 10px rgba(255,213,74,.25)}.tab:active{transform:translateY(1px)}</style>
</head>
<body>
  <div class="app" id="app">
    <header class="topbar" role="banner">
      <div class="container row">
        <div class="row" aria-label="CalisFit">
          <div class="logo" aria-hidden="true"></div>
          <div style="line-height:1.1">
            <div class="title">CalisFit</div>
            <div class="subtitle">Programmes · Chronos · Reps · Stats</div>
          </div>
        </div>
        <span class="badge" id="todayBadge" aria-live="polite">Semaine 1 • Jour 1</span>
      </div>
    </header>

    <main class="container" role="main">
      <section id="tab-today" class="active" aria-labelledby="tabTodayBtn" role="region">
        <div class="card" aria-live="polite">
          <div class="row">
            <div>
              <div class="label">Programme actif</div>
              <div class="h1" id="todayTitle">Jour 1 · Full Body</div>
            </div>
            <button class="btn primary" id="startSessionBtn" aria-label="Lancer la séance">▶ Lancer</button>
          </div>
          <div class="label" style="margin-top:6px">3 cycles (30 jours × 3 mois) · Swipe ⟷ pour changer de manche</div>
          <div class="badge" id="motivation">💡 « La progression est un voyage, pas une course. »</div>
        </div>

        <div class="card" id="workoutListCard">
          <div class="row" style="margin-bottom:8px">
            <div class="h2">Séance du jour</div>
            <div class="pill" id="roundChip" aria-live="polite">Manche 1/3</div>
          </div>
          <div class="grid" id="workoutList" style="gap:10px"></div>
          <div class="row" style="margin-top:10px">
            <button class="btn" id="prevRound" aria-label="Manche précédente">⟵ Manche</button>
            <button class="btn primary" id="nextRound" aria-label="Manche suivante">Manche suivante ⟶</button>
          </div>
        </div>

        <div class="grid two">
          <div class="card">
            <div class="label">Repos</div>
            <div class="row" style="margin-top:6px;gap:10px">
              <button class="btn" data-rest="30">30s</button>
              <button class="btn" data-rest="60">60s</button>
              <button class="btn" data-rest="90">90s</button>
              <button class="btn" data-rest="180">3min</button>
            </div>
            <div class="timer">
              <div class="time" id="restDisplay" aria-live="polite">00:00</div>
              <div class="row" style="margin-top:8px">
                <button class="btn" id="restStart">Démarrer</button>
                <button class="btn ghost" id="restReset">Réinitialiser</button>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="label">Chrono séance</div>
            <div class="timer">
              <div class="time" id="swDisplay" aria-live="polite">00:00.0</div>
              <div class="row" style="margin-top:8px">
                <button class="btn" id="swStart">Démarrer</button>
                <button class="btn ghost" id="swLap">Tour</button>
                <button class="btn ghost" id="swReset">Remise à zéro</button>
              </div>
              <div class="label" id="swLaps" style="margin-top:6px"></div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="row"><div class="h2">Notes</div><button class="btn ghost" id="saveNotes">💾 Enregistrer</button></div>
          <label class="sr-only" for="notes">Bloc-notes</label>
          <textarea id="notes" rows="3" style="width:100%;margin-top:8px;background:#0e1322;color:#eef4ff;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px" aria-label="Bloc-notes"></textarea>
        </div>
      </section>

      <section id="tab-programs" role="region" aria-labelledby="tabProgramsBtn">
        <div class="card">
          <div class="row">
            <div>
              <div class="label">Plan actif</div>
              <div class="h1">Calisthenics – 30 jours (x3 cycles)</div>
            </div>
            <button class="btn" id="duplicate3m">Générer 3 mois</button>
          </div>
          <div class="label">Jours OFF inclus. Swipe ⟷ sur le calendrier pour marquer un jour.</div>
        </div>

        <div class="card">
          <div class="row" style="margin-bottom:6px"><div class="h2">Calendrier d'entraînement</div>
            <div class="badge" id="streakChip">🔥 Série: 0</div>
          </div>
          <div class="calendar" id="calendar" role="grid" aria-label="Calendrier"></div>
        </div>

        <div class="card">
          <div class="row"><div class="h2">Importer / Exporter</div>
            <div class="row" style="gap:8px">
              <button class="btn" id="exportData">Exporter JSON</button>
              <label class="btn" for="importFile">Importer JSON</label>
              <input id="importFile" type="file" accept="application/json" style="display:none" />
            </div>
          </div>
        </div>

        <div class="card">
          <div class="row" style="margin-bottom:8px"><div class="h2">Jours & exercices</div>
            <div class="badge" id="daysCount">30 jours</div></div>
          <div id="daysList" class="grid" style="grid-template-columns:repeat(1,1fr)"></div>
        </div>

        <div class="card" id="freeModeCard">
          <div class="row" style="margin-bottom:8px"><div class="h2">Mode Libre – Crée ta séance</div>
            <button class="btn" id="freeAddExo">+ Ajouter exo</button>
          </div>
          <div id="freeList" class="grid"></div>
          <div class="row" style="margin-top:8px">
            <button class="btn primary" id="freeStart">▶ Démarrer séance libre</button>
            <button class="btn ghost" id="freeClear">Effacer</button>
          </div>
        </div>

        <div class="card" id="skillsCard">
          <div class="h2">Skills Tracker</div>
          <div class="label">Suis tes progrès sur les figures (0–10).</div>
          <div id="skillsList" class="grid"></div>
        </div>

        <div class="card" id="competitionCard">
          <div class="h2">Mode Compétition</div>
          <div class="label">Partage un code avec un ami et comparez vos stats (sans serveur).</div>
          <div class="row" style="margin-top:8px">
            <button class="btn" id="shareCode">Générer code</button>
            <button class="btn" id="importCode">Importer code</button>
          </div>
          <textarea id="codeArea" rows="2" style="width:100%;margin-top:8px;background:#0e1322;color:#eef4ff;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px" placeholder="Colle ici le code reçu"></textarea>
        </div>
      </section>

      <section id="tab-timer" role="region" aria-labelledby="tabTimerBtn">
        <div class="card">
          <div class="h2">Intervalles (Tabata / EMOM)</div>
          <div class="grid two" style="margin-top:8px">
            <div>
              <div class="label">Travail (s)</div>
              <input id="intWork" type="number" min="5" value="20" style="width:100%;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.1);background:#0e1322;color:#fff" />
            </div>
            <div>
              <div class="label">Repos (s)</div>
              <input id="intRest" type="number" min="5" value="10" style="width:100%;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.1);background:#0e1322;color:#fff" />
            </div>
          </div>
          <div class="grid two" style="margin-top:8px">
            <div>
              <div class="label">Cycles</div>
              <input id="intRounds" type="number" min="1" value="8" style="width:100%;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.1);background:#0e1322;color:#fff" />
            </div>
            <div>
              <div class="label">Préparation (s)</div>
              <input id="intPrep" type="number" min="0" value="5" style="width:100%;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.1);background:#0e1322;color:#fff" />
            </div>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn primary" id="intStart">▶ Démarrer</button>
            <button class="btn ghost" id="intStop">Stop</button>
            <div class="badge" id="intPhase">Prêt</div>
          </div>
          <div class="timer">
            <div class="time" id="intDisplay">00:00</div>
            <div class="label" id="intRoundInfo">Cycle 0/8</div>
          </div>
        </div>

        <div class="card" id="exerciseGuide">
          <div class="row" style="margin-bottom:8px"><div class="h2">Guide des exercices</div>
            <input id="exGuideSearch" type="search" placeholder="Rechercher un exercice..." aria-label="Recherche d'exercice" style="flex:1;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.1);background:#0e1322;color:#fff" />
          </div>
          <div id="exGuideList" class="grid"></div>
        </div>

        <div class="card">
          <div class="row"><div class="h2">Historique des séances</div>
            <div class="row" style="gap:8px">
              <button class="btn" id="exportPDF">Exporter PDF</button>
              <button class="btn" id="clearHistory">Effacer l'historique</button>
            </div>
          </div>
          <div id="historyList" class="grid"></div>
        </div>
      </section>

      <section id="tab-stats" role="region" aria-labelledby="tabStatsBtn">
        <div class="card">
          <div class="row"><div class="h2">Volume & PR</div><div class="badge" id="totalSessions">0 séances</div></div>
          <div class="grid three" style="margin-top:8px">
            <div class="card">
              <div class="label">Reps totales</div>
              <div class="h1" id="totalReps">0</div>
            </div>
            <div class="card">
              <div class="label">Temps d'entraînement</div>
              <div class="h1" id="totalTime">0:00:00</div>
            </div>
            <div class="card">
              <div class="label">Meilleur streak</div>
              <div class="h1" id="bestStreak">0</div>
            </div>
          </div>
        </div>
      </section>

      <section id="tab-settings" role="region" aria-labelledby="tabSettingsBtn">
        <div class="card">
          <div class="h2">Accessibilité</div>
          <div class="grid two" style="margin-top:8px">
            <label class="row"><span>Contraste renforcé</span><input id="a11yContrast" type="checkbox" /></label>
            <label class="row"><span>Taille de texte +</span><input id="a11yTextLg" type="checkbox" /></label>
          </div>
        </div>
        <div class="card">
          <div class="h2">Préférences</div>
          <div class="grid two" style="margin-top:8px">
            <label class="row"><span>Signal sonore</span><input id="beepToggle" type="checkbox" checked /></label>
            <label class="row"><span>Vibration (iPhone)</span><input id="hapticsToggle" type="checkbox" checked /></label>
          </div>
        </div>
        <div class="card">
          <div class="row"><div class="h2">Données</div>
            <div class="row" style="gap:8px">
              <button class="btn" id="resetData">Réinitialiser</button>
              <button class="btn" id="markRestDay">Marquer jour OFF</button>
            </div>
          </div>
          <div class="label">Astuce iPhone : Safari → Partager → « Ajouter à l’écran d’accueil ».</div>
        </div>
      </section>
    </main>

    <nav class="tabs" role="tablist" aria-label="Navigation principale">
      <button class="tab active" id="tabTodayBtn" role="tab" aria-controls="tab-today" aria-selected="true"><span class="ico">🏠</span>Aujourd’hui</button>
      <button class="tab" id="tabProgramsBtn" role="tab" aria-controls="tab-programs" aria-selected="false"><span class="ico">📅</span>Programmes</button>
      <button class="tab" id="tabTimerBtn" role="tab" aria-controls="tab-timer" aria-selected="false"><span class="ico">⏱️</span>Chronos</button>
      <button class="tab" id="tabStatsBtn" role="tab" aria-controls="tab-stats" aria-selected="false"><span class="ico">📊</span>Stats</button>
      <button class="tab" id="tabSettingsBtn" role="tab" aria-controls="tab-settings" aria-selected="false"><span class="ico">⚙️</span>Réglages</button>
    </nav>
  </div>

  <audio id="beep" preload="auto"><source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAAAAA/////wAA" type="audio/wav"></audio>

  <script>
  function setVH(){ document.documentElement.style.setProperty('--vh', (window.innerHeight*0.01)+'px'); }
  setVH(); window.addEventListener('resize', setVH); window.addEventListener('orientationchange', setVH);
  const $ = s=>document.querySelector(s); const $$ = s=>Array.from(document.querySelectorAll(s));

  // PWA: register service worker
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => navigator.serviceWorker.register('./service-worker.js'));
  }

  // IndexedDB wrapper
  const DB = (()=>{
    const name='calisfit_db', store='state'; let db;
    function open(){return new Promise((res,rej)=>{const r=indexedDB.open(name,1); r.onupgradeneeded=()=>r.result.createObjectStore(store); r.onsuccess=()=>{db=r.result;res()}; r.onerror=()=>rej(r.error)});}
    async function get(k){ if(!db) await open(); return new Promise((res,rej)=>{const tx=db.transaction(store,'readonly'); const os=tx.objectStore(store); const rq=os.get(k); rq.onsuccess=()=>res(rq.result); rq.onerror=()=>rej(rq.error);});}
    async function set(k,v){ if(!db) await open(); return new Promise((res,rej)=>{const tx=db.transaction(store,'readwrite'); const os=tx.objectStore(store); const rq=os.put(v,k); rq.onsuccess=()=>res(true); rq.onerror=()=>rej(rq.error);});}
    return {get,set};
  })();

  const storeLS={ load(){try{return JSON.parse(localStorage.getItem('calisfit'))||{}}catch{return {}}}, save(x){localStorage.setItem('calisfit',JSON.stringify(x)); DB.set('state',x).catch(()=>{});} };

  const state = Object.assign({
    currentDay:1,currentRound:1,notes:'',completed:{},repsLog:{},
    totals:{reps:0,time:0,sessions:0,streak:0,bestStreak:0},
    settings:{beep:true,haptics:true,contrast:false,textLg:false},
    calendar:{},history:[],free:[],skills:{'Muscle-up':0,'Handstand':0,'Front Lever':0,'Back Lever':0,'Planche':0,'Pistol Squat':0}
  }, storeLS.load());
  DB.get('state').then(s=>{ if(s && JSON.stringify(s).length>JSON.stringify(state).length){ Object.assign(state,s); init(); } });

  function persist(){ storeLS.save(state); }
  function haptics(){ if(!state.settings?.haptics) return; if(navigator.vibrate) navigator.vibrate(10); }
  function beep(){ if(!state.settings?.beep) return; const a=$('#beep'); try{ a.currentTime=0; a.play(); }catch{} }
  function fmtTime(sec){ sec=Math.max(0,Math.floor(sec)); const h=Math.floor(sec/3600),m=Math.floor((sec%3600)/60),s=sec%60; return `${h?h+':':''}${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}` }

  // Exercise DB (translations + cues)
  const EX_DB={
    'Push-ups':{fr:'Pompes',setup:'Mains sous les épaules, corps gainé.',cues:'Coudes ~45°, souffle en poussant.',errors:'Bassin qui tombe.'},
    'Diamond Push-ups':{fr:'Pompes diamant',setup:'Mains en losange sous poitrine.',cues:'Coudes près du corps.',errors:'Dos creusé.'},
    'Archer Push-up':{fr:'Pompes archer',setup:'Large, un bras fléchit, l’autre tendu.',cues:'Épaule basse.',errors:'Effondrement épaule.'},
    'Pike Push-up':{fr:'Pompes pike',setup:'V inversé, mains largeur épaules.',cues:'Sommet du crâne vers le sol.',errors:'Dos rond.'},
    'Decline Push-up':{fr:'Pompes déclinées',setup:'Pieds surélevés.',cues:'Corps aligné.',errors:'Bassin qui tombe.'},
    'Triangle Push-up':{fr:'Pompes serrées',setup:'Mains proches du buste.',cues:'Coudes serrés.',errors:'Évasement coudes.'},
    'Inverted Row':{fr:'Rowing inversé',setup:'Sous barre/table.',cues:'Poitrine à la barre.',errors:'Hanches qui tombent.'},
    'Elevated Inverted Rows':{fr:'Rowing inversé surélevé',setup:'Pieds surélevés.',cues:'Trajectoire poitrine‑barre.',errors:'À‑coups.'},
    'Pull-ups':{fr:'Tractions pronation',setup:'Prise plus large que épaules.',cues:'Épaules basses.',errors:'Balancement.'},
    'Chin-ups':{fr:'Tractions supination',setup:'Paumes vers toi.',cues:'Coudes vers côtes.',errors:'Cou tendu.'},
    'L Pull-ups':{fr:'Tractions en L',setup:'Jambes à 90°.',cues:'Gaine fort.',errors:'Perte d’angle.'},
    'Bar Dips':{fr:'Dips barres parallèles',setup:'Bras tendus.',cues:'Épaules sous coudes.',errors:'Épaules qui s’affalent.'},
    'Chair Dips':{fr:'Dips sur chaise',setup:'Mains sur banc.',cues:'Cage ouverte.',errors:'Épaules enroulées.'},
    'Squats':{fr:'Squats',setup:'Pieds largeur épaules.',cues:'Genoux suivent orteils.',errors:'Genoux rentrent.'},
    'Sissy Squats':{fr:'Squats sissy',setup:'Corps incliné.',cues:'Contrôle.',errors:'Genoux comprimés.'},
    'Bulgarian Split Squat':{fr:'Fentes bulgares',setup:'Pied arrière surélevé.',cues:'Tronc droit.',errors:'Genou rentre.'},
    'Reverse Lunge':{fr:'Fentes arrière',setup:'Grand pas arrière.',cues:'Genou au‑dessus du pied.',errors:'Buste s’écroule.'},
    'Back & Forth Lunges':{fr:'Fentes avant/arrière',setup:'Alterne avant/arr.',cues:'Stabilité.',errors:'Perte équilibre.'},
    'Curtsy Lunges':{fr:'Fentes croisées',setup:'Pied arrière croisé.',cues:'Hanches face.',errors:'Genou vrille.'},
    'Lateral Lunges':{fr:'Fentes latérales',setup:'Grand pas côté.',cues:'Hanche recule.',errors:'Genou dépasse.'},
    'Skater Squat':{fr:'Squat patineur',setup:'Une jambe.',cues:'Contrôle.',errors:'Bassin chute.'},
    'Pistol Squat':{fr:'Pistol squat',setup:'Une jambe tendue.',cues:'Gaine, contrôle.',errors:'Talons se décollent.'},
    'One-leg RDL':{fr:'Soulevé de terre une jambe',setup:'Charnière hanche.',cues:'Dos long.',errors:'Dos rond.'},
    'SL Elevated Bridge':{fr:'Pont surélevé une jambe',setup:'Pied surélevé.',cues:'Hanche haute.',errors:'Amplitude courte.'},
    'Glute Kickback':{fr:'Extension hanche quadrupédie',setup:'À quatre pattes.',cues:'Talons vers plafond.',errors:'Cambrure.'},
    'Superman Pull':{fr:'Tirage superman',setup:'Allongé ventral.',cues:'Coudes vers hanches.',errors:'Cou en extension.'},
    'Floor IYT':{fr:'Élévations I‑Y‑T au sol',setup:'Allongé ventral.',cues:'Omoplates serrées.',errors:'Haussement épaules.'},
    'Bird Dog':{fr:'Bird dog',setup:'Quadrupédie.',cues:'Bassin stable.',errors:'Oscillation.'},
    'Bird Dog Plank':{fr:'Planche bird dog',setup:'Plank + levers.',cues:'Gaine, respire.',errors:'Bassin bouge.'},
    'Plank':{fr:'Planche',setup:'Coudes sous épaules.',cues:'Nombril rentré.',errors:'Bassin haut/bas.'},
    'Side Plank':{fr:'Planche latérale',setup:'Épaule sur coude.',cues:'Hanche haute.',errors:'Épaule écrasée.'},
    'Side Plank Reach':{fr:'Planche latérale rotation',setup:'Ajoute rotation.',cues:'Contrôle.',errors:'Chute hanche.'},
    'L-Sit':{fr:'L‑Sit',setup:'Appui mains.',cues:'Épaules basses.',errors:'Dos arrondi.'},
    'Hollow Hold':{fr:'Gainage hollow',setup:'Dos plaqué.',cues:'Côtes rentrées.',errors:'Dos décolle.'},
    'Hollow Crunch':{fr:'Crunch hollow',setup:'Dynamique.',cues:'Bas du dos plaqué.',errors:'Tirer la nuque.'},
    'V-ups':{fr:'V‑ups',setup:'Mains/pieds se rejoignent.',cues:'Explosif.',errors:'Dos claque.'},
    'Leg Raises':{fr:'Relevés de jambes',setup:'Allongé/suspendu.',cues:'Dos plaqué.',errors:'Balançoire.'},
    'Hanging Knee Raises':{fr:'Relevés de genoux pendu',setup:'Suspendu.',cues:'Contrôle.',errors:'Balançoire.'},
    'Hanging Leg Raises':{fr:'Relevés de jambes pendu',setup:'Suspendu.',cues:'Rétroversion.',errors:'Dos creusé.'},
    'Hanging Wipers':{fr:'Essuie‑glaces pendu',setup:'Jambes hautes.',cues:'Tourne en bloc.',errors:'Élan.'},
    'Windshield Wipers':{fr:'Essuie‑glaces au sol',setup:'Allongé.',cues:'Épaules collées.',errors:'Arrachage épaules.'},
    'Mountain Climber':{fr:'Mountain climber',setup:'Planche.',cues:'Rythme constant.',errors:'Bassin saute.'},
    'Toes to Bar':{fr:'Orteils à la barre',setup:'Suspendu.',cues:'Creux/bosse.',errors:'Élan anarchique.'},
    'Handstand Push-ups':{fr:'Pompes en équilibre (HSPU)',setup:'Mur ok.',cues:'Gainage.',errors:'Cambrure.'},
    'Wall HSPU':{fr:'Pompes en équilibre au mur',setup:'Pieds au mur.',cues:'Amplitude contrôlée.',errors:'Cervicales.'},
    'Muscle-up (prog)':{fr:'Muscle‑up (progression)',setup:'Tirage explosif.',cues:'Transition rapide.',errors:'Coudes derrière.'},
    'Front Lever (tuck)':{fr:'Front lever (tuck)',setup:'Épaules basses.',cues:'Rétroversion bassin.',errors:'Épaules montées.'},
    'Planche Push-up (prog)':{fr:'Pompes planche (progression)',setup:'Épaules devant poignets.',cues:'Protraction.',errors:'Coudes évasés.'},
    'Shuttle Runs':{fr:'Allers‑retours sprint',setup:'Marques au sol.',cues:'Demi‑tour bas.',errors:'Talons lourds.'},
    'Step-up':{fr:'Montées sur banc',setup:'Pied entier sur appui.',cues:'Pousse le talon.',errors:'Genou rentre.'},
    'Calf Raises':{fr:'Extensions mollets',setup:'Appui avant‑pied.',cues:'Pause en haut.',errors:'Amplitude courte.'},
    'In & Out Jump':{fr:'Sauts écart‑ramener',setup:'Pieds joints → écartés.',cues:'Atterrissage doux.',errors:'Talons durs.'}
  };
  const PLAN_30=[
    {day:1,title:'Full Body',rounds:3,items:[
      ['Push-ups','20'],['Squats','20'],['Pike Push-up','10'],['Inverted Row','20'],['Lateral Lunges','10/side'],['Chair Dips','10']
    ]},
    {day:2,title:'Upper/Lower + Core',rounds:3,items:[
      ['Dive Bomber Push-ups','15'],['Chin-ups','AMRAP'],['Reverse Lunge','10/side'],['Shoulder Tap','20'],['Reverse Crunches','20'],['Step-up','10/side']
    ]},
    {day:3,title:'Pull • Core • Legs',rounds:3,items:[
      ['Squats','20'],['Pull-ups','AMRAP'],['Diamond Push-ups','20'],['Windshield Wipers','10/side'],['Curtsy Lunges','10/side'],['Bird Dog','5/side']
    ]},
    {day:4,title:'OFF / Récup',rounds:0,items:[]},
    {day:5,title:'Mix explosif',rounds:3,items:[
      ['Squat Jump','10'],['Push-ups','20'],['Superman Pull','10'],['Chin-ups','AMRAP'],['Wall HSPU','10'],['Hollow Crunch','10']
    ]},
    {day:6,title:'Push/Pull + Core',rounds:3,items:[
      ['Inverted Row','10'],['Archer Push-up','10/side'],['Reverse Lunge','10/side'],['Bar Dips','10'],['Mountain Climber','20s'],['Hanging Knee Raises','10']
    ]},
    {day:7,title:'OFF / Récup',rounds:0,items:[]},
    {day:8,title:'Core & Stability',rounds:3,items:[
      ['Burpees','10'],['Floor IYT','10'],['Wide Arm Push-up','10'],['L-Sit','Hold'],['Step-up','10'],['Calf Raises','20'],['Plank','45-60s'],['Side Plank','20s/side']
    ]},
    {day:9,title:'Push/Pull Mix',rounds:3,items:[
      ['Inverted Row','10'],['Decline Push-up','10'],['Bulgarian Split Squat','5/side'],['Chin-ups','10'],['Bird Dog Plank','5/side'],['Bar Dips','10'],['Pike Push-up','10'],['Leg Raises','10']
    ]},
    {day:10,title:'Legs · Push · Core',rounds:3,items:[
      ['Squat Jump','10'],['Archer Push-up','10/side'],['Reverse Lunge','10/side'],['Single-Leg Tuck-up','10/side'],['Lateral Lunges','10/side'],['Mountain Climber','20s'],['Hanging Knee Raises','10'],['Diamond Push-ups','10']
    ]},
    {day:11,title:'OFF / Récup',rounds:0,items:[]},
    {day:12,title:'Skills & Legs',rounds:3,items:[
      ['Wall HSPU','10'],['Shuttle Runs','20s'],['Pseudo Planche','10'],['Pistol Squat','8-10/side'],['Burpees','10'],['Hanging Leg Raises','10'],['Mountain Climber','20s'],['One-leg RDL','8-10/side']
    ]},
    {day:13,title:'Hamstrings & Pull',rounds:3,items:[
      ['Back & Forth Lunges','10'],['Dead Bug','10'],['Nordic Curl','10'],['Bird Dog Plank','20'],['Pull-ups','6+'],['Dragon Flag','6-10'],['Shoulder Tap','15-20s'],['Plank','1:00']
    ]},
    {day:14,title:'OFF / Récup',rounds:0,items:[]},
    {day:15,title:'Plyo + Pull',rounds:4,items:[
      ['In & Out Jump','10'],['Clap Push-up','10'],['L Pull-ups','10'],['Bar Dips','10'],['Dragon Flag','6-8'],['Side Plank Reach','20s'],['Chin-ups','8-12'],['Archer Push-up','6-8/side']
    ]},
    {day:16,title:'Skills Focus',rounds:4,items:[
      ['Toes to Bar','10'],['Skater Squat','10/side'],['Muscle-up (prog)','10'],['Planche Push-up (prog)','10'],['Hollow Hold','15s'],['Single-Leg Hamstring Bridge','10/side'],['Triangle Push-up','10'],['Side Plank','15s/side']
    ]},
    {day:17,title:'Mixed Strength',rounds:4,items:[
      ['Back & Forth Lunges','10'],['Inverted Row','10'],['Pike Push-up','10'],['Squats','20'],['Dragon Flag','6-10'],['Shoulder Tap','15-20s'],['Mountain Climber','20s'],['Plank','1:00']
    ]},
    {day:18,title:'OFF / Récup',rounds:0,items:[]},
    {day:19,title:'Pull & Posterior',rounds:4,items:[
      ['Chin-ups','10'],['Archer Push-up','10/side'],['Front Lever (tuck)','AMRAP'],['One-leg RDL','5/side'],['Superman Pull','10'],['Curtsy Lunges','10'],['Toes to Bar','10'],['SL Elevated Bridge','10']
    ]},
    {day:20,title:'HSPU & Core',rounds:4,items:[
      ['Pike Push-up','10'],['Back & Forth Lunges','10/side'],['Handstand Push-ups','AMRAP'],['Inverted Row','10'],['V-ups','10'],['Bar Dips','10'],['Skater Squat','10'],['Single-Leg Tuck-up','10']
    ]},
    {day:21,title:'OFF / Récup',rounds:0,items:[]},
    {day:22,title:'Skills + Legs',rounds:4,items:[
      ['Toes to Bar','10'],['Sissy Squats','10'],['Muscle-up (prog)','AMRAP'],['Planche Push-up (prog)','10'],['Pistol Squat','10/side'],['Dragon Flag','AMRAP'],['Triangle Push-up','10'],['Plank','60s']
    ]},
    {day:23,title:'Plyo + Split Legs',rounds:4,items:[
      ['In & Out Jump','10'],['Clap Push-up','10'],['L Pull-ups','10'],['Bulgarian Split Squat','10/side'],['Hanging Knee Raises','10'],['Knee Outside Elbow','10/side'],['Elevated Inverted Rows','8-12'],['Glute Kickback','10/side']
    ]},
    {day:24,title:'Mixed + Core',rounds:4,items:[
      ['Squat Jump','10'],['Pull-ups','10'],['Pike Push-up','10'],['Sissy Squats','20'],['Dragon Flag','6-10'],['Shoulder Tap','20s'],['Mountain Climber','20s'],['Hanging Wipers','10/side']
    ]},
    {day:25,title:'OFF / Récup',rounds:0,items:[]},
    {day:26,title:'Push Skills',rounds:4,items:[
      ['Dive Bomber Push-ups','10'],['Muscle-up (prog)','10'],['Triangle Push-up','10'],['One-leg RDL','10/side'],['Hollow Crunch','10'],['Skater Squat','10/side'],['Toes to Bar','10'],['Bird Dog','10/side']
    ]},
    {day:27,title:'Front Lever + Pistols',rounds:4,items:[
      ['Back & Forth Lunges','10'],['Front Lever (tuck)','10'],['Bar Dips','10'],['Pistol Squat','20'],['Pull-ups','6+'],['Dragon Flag','6-10'],['Shoulder Tap','20s'],['Plank','1:00']
    ]},
    {day:28,title:'OFF / Récup',rounds:0,items:[]},
    {day:29,title:'Full Mix Advanced',rounds:4,items:[
      ['Burpees','10'],['Pull-ups','10'],['V-ups','10'],['Muscle-up (prog)','10'],['Sissy Squats','10'],['Handstand Push-ups','10'],['Hanging Knee Raises','15'],['Bird Dog','10/side']
    ]},
    {day:30,title:'Finale',rounds:4,items:[
      ['In & Out Jump','10'],['Clap Push-up','10'],['L Pull-ups','10'],['Bulgarian Split Squat','10/side'],['Knee to Elbow','10'],['Knee Inside Elbow','10/side'],['Inverted Row','8-12'],['SL Elevated Bridge','10/side']
    ]}
  ];

  const tabs=[['today','tabTodayBtn'],['programs','tabProgramsBtn'],['timer','tabTimerBtn'],['stats','tabStatsBtn'],['settings','tabSettingsBtn']];
  tabs.forEach(([id,btn])=>{ $('#'+btn).addEventListener('click',()=>activateTab(id,btn)); });
  function activateTab(id,btn){ $$('.tab').forEach(t=>t.classList.remove('active')); $('#'+btn).classList.add('active'); $$('section').forEach(s=>s.classList.remove('active')); $('#tab-'+id).classList.add('active'); }

  function getDayData(d){ return PLAN_30.find(x=>x.day===d) || PLAN_30[0]; }
  function tName(name){ return (EX_DB[name] && EX_DB[name].fr) ? EX_DB[name].fr : name; }

  function updateToday(){
    if(!state._booted){ state.currentDay = Math.min(30, Math.max(1, state.currentDay||1)); state._booted=true; }
    const d = getDayData(state.currentDay);
    $('#todayTitle').textContent = `Jour ${d.day} · ${d.title}`;
    $('#todayBadge').textContent = `Semaine ${Math.ceil(d.day/7)} • Jour ${d.day}`;
    const rounds = d.rounds || (d.day<=15?3:4);
    state.currentRound = Math.min(Math.max(1,state.currentRound||1), rounds);
    $('#roundChip').textContent = `Manche ${state.currentRound}/${rounds}`;

    const list=$('#workoutList'); list.innerHTML='';
    d.items.forEach(([name,target],idx)=>{
      const key = `${d.day}:${state.currentRound}:${idx}`; const reps = state.repsLog[key]||0; const done = !!state.completed[key];
      const el=document.createElement('div'); el.className='workout-item'+(done?' done':'');
      el.innerHTML=`<div><div class="h2">${tName(name)}</div><div class="label">Cible: ${target}</div></div>
      <div class="row" style="gap:8px">
        <span class="pill" aria-live="polite">${reps} reps</span>
        <div class="counter" role="group" aria-label="Compteur de répétitions">
          <button data-act="-" aria-label="Moins">−</button>
          <button data-act="+" aria-label="Plus">+</button>
        </div>
        <button class="btn" data-done>✔</button>
      </div>`;
      el.querySelectorAll('.counter button').forEach(b=>b.addEventListener('click',()=>{ let v=state.repsLog[key]||0; v += (b.dataset.act==='+')?1:-1; v=Math.max(0,v); state.repsLog[key]=v; haptics(); updateToday(); persist(); updateStats(); }));
      el.querySelector('[data-done]').addEventListener('click',()=>{ state.completed[key] = !done; if(state.completed[key]){ beep(); haptics(); } persist(); updateToday(); updateStats(); });
      list.appendChild(el);
    });
  }

  function bindSwipes(el, onLeft, onRight){ let x0=null,t0=0; el.addEventListener('touchstart',e=>{ x0=e.touches[0].clientX; t0=Date.now(); }); el.addEventListener('touchend',e=>{ if(x0==null) return; const dx=(e.changedTouches[0].clientX-x0); const dt=Date.now()-t0; if(dt<500 && Math.abs(dx)>40){ if(dx<0) onLeft&&onLeft(); else onRight&&onRight(); } x0=null; }); }
  bindSwipes($('#workoutListCard'),()=>$('#nextRound').click(),()=>$('#prevRound').click());
  $('#prevRound').addEventListener('click',()=>{ const d=getDayData(state.currentDay); const rounds=d.rounds||(d.day<=15?3:4); state.currentRound=Math.max(1,state.currentRound-1); updateToday(); persist(); });
  $('#nextRound').addEventListener('click',()=>{ const d=getDayData(state.currentDay); const rounds=d.rounds||(d.day<=15?3:4); state.currentRound=Math.min(rounds,state.currentRound+1); updateToday(); persist(); });

  // Rest timer
  let restSel=60, restTimer=null, restLeft=0; $$('#tab-today [data-rest]').forEach(b=>b.addEventListener('click',()=>{ restSel=+b.dataset.rest; $('#restDisplay').textContent=fmtTime(restSel); }));
  $('#restStart').addEventListener('click',()=>{ if(restTimer){clearInterval(restTimer)}; restLeft=restSel; $('#restDisplay').textContent=fmtTime(restLeft); restTimer=setInterval(()=>{ restLeft--; $('#restDisplay').textContent=fmtTime(restLeft); if(restLeft<=0){ clearInterval(restTimer); restTimer=null; beep(); haptics(); } },1000); });
  $('#restReset').addEventListener('click',()=>{ if(restTimer){clearInterval(restTimer)}; restTimer=null; restLeft=0; $('#restDisplay').textContent='00:00'; });

  // Stopwatch
  let swTimer=null, swStartAt=0; function renderSW(){ const t=swTimer?(Date.now()-swStartAt)/1000:0; const ms=Math.floor((t%1)*10); const s=Math.floor(t)%60; const m=Math.floor(t/60)%60; const h=Math.floor(t/3600); $('#swDisplay').textContent=`${h?String(h).padStart(2,'0')+':':''}${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}.${ms}`; }
  $('#swStart').addEventListener('click',()=>{ if(swTimer){ clearInterval(swTimer); swTimer=null; $('#swStart').textContent='Démarrer'; const delta=Math.floor((Date.now()-swStartAt)/1000); state.totals.time+=delta; persist(); updateStats(); } else { swStartAt=Date.now(); swTimer=setInterval(renderSW,100); $('#swStart').textContent='Pause'; }});
  $('#swReset').addEventListener('click',()=>{ if(swTimer){clearInterval(swTimer); swTimer=null;} $('#swDisplay').textContent='00:00.0'; $('#swStart').textContent='Démarrer'; $('#swLaps').textContent=''; });
  $('#swLap').addEventListener('click',()=>{ const t=$('#swDisplay').textContent; const n=document.createElement('span'); n.textContent=( $('#swLaps').textContent? ' · ' : '' )+t; $('#swLaps').appendChild(n); haptics(); });

  $('#startSessionBtn').addEventListener('click',()=>{ state.sessionStart=Date.now(); $('#swReset').click(); $('#swStart').click(); haptics(); addHistory('start'); });

  // Intervals
  let intTimer=null,intPhase='prep',intLeft=0,intRound=0; function intRender(){ $('#intDisplay').textContent=fmtTime(intLeft); $('#intPhase').textContent=intPhase.toUpperCase(); $('#intRoundInfo').textContent=`Cycle ${intRound}/${+$('#intRounds').value}`; }
  function intTick(){ intLeft--; intRender(); if(intLeft<=0){ beep(); haptics(); if(intPhase==='prep'){ intPhase='work'; intLeft=+$('#intWork').value; } else if(intPhase==='work'){ intPhase='rest'; intLeft=+$('#intRest').value; } else if(intPhase==='rest'){ intRound++; if(intRound>+$('#intRounds').value){ clearInterval(intTimer); intTimer=null; intPhase='fini'; $('#intPhase').textContent='Terminé'; addHistory('interval_done'); return; } intPhase='work'; intLeft=+$('#intWork').value; } intRender(); } }
  $('#intStart').addEventListener('click',()=>{ if(intTimer){clearInterval(intTimer);} intPhase='prep'; intLeft=+$('#intPrep').value; intRound=1; intRender(); intTimer=setInterval(intTick,1000); });
  $('#intStop').addEventListener('click',()=>{ if(intTimer){clearInterval(intTimer); intTimer=null;} intPhase='stop'; intRender(); });

  // Programs list + calendar
  function buildDaysList(){ const box=$('#daysList'); box.innerHTML=''; PLAN_30.forEach(d=>{ const card=document.createElement('div'); card.className='workout-item'; const rounds=d.rounds||(d.day<=15?3:4); card.innerHTML=`<div><div class="h2">Jour ${d.day} · ${d.title}</div><div class="label">${rounds} manches • ${d.items.length} exos</div></div><div class="row"><button class='btn' data-go='${d.day}'>Aller</button></div>`; card.querySelector('[data-go]').addEventListener('click',()=>{ state.currentDay=d.day; state.currentRound=1; updateToday(); persist(); activateTab('today','tabTodayBtn'); }); box.appendChild(card); }); $('#daysCount').textContent=`${PLAN_30.length} jours`; }

  function buildCalendar(){ const cal=$('#calendar'); cal.innerHTML=''; const dt=new Date(); const y=dt.getFullYear(), m=dt.getMonth(); const first=new Date(y,m,1); const start=(first.getDay()||7); const days=new Date(y,m+1,0).getDate(); for(let i=1;i<start;i++){ cal.appendChild(document.createElement('div')); } for(let d=1; d<=days; d++){ const el=document.createElement('div'); el.className='day'; el.textContent=d; const key=`d${y}-${m+1}-${d}`; if(state.calendar[key]==='done') el.classList.add('done'); if(state.calendar[key]==='off') el.classList.add('off'); el.addEventListener('click',()=>{ state.calendar[key] = state.calendar[key]==='done' ? 'off' : state.calendar[key]==='off' ? undefined : 'done'; if(state.calendar[key]==='done'){ state.totals.sessions++; state.totals.streak++; state.totals.bestStreak=Math.max(state.totals.bestStreak,state.totals.streak); } else if(state.calendar[key]==='off'){ state.totals.streak=0; } persist(); buildCalendar(); updateStats(); }); cal.appendChild(el); } }

  // Free mode
  function renderFree(){ const box=$('#freeList'); box.innerHTML=''; (state.free||[]).forEach((x,i)=>{ const item=document.createElement('div'); item.className='workout-item'; item.innerHTML=`<div><div class='h2'>${x.name||'Exercice'}</div><div class='label'>Cible: ${x.target||'-'}</div></div><div class='row'><button class='btn' data-edit='${i}'>✎</button><button class='btn' data-del='${i}'>🗑️</button></div>`; item.querySelector('[data-del]').addEventListener('click',()=>{ state.free.splice(i,1); persist(); renderFree(); }); item.querySelector('[data-edit]').addEventListener('click',()=>{ const name=prompt('Nom',x.name||''); const target=prompt('Cible',x.target||''); if(name!==null){ state.free[i]={name,target}; persist(); renderFree(); } }); box.appendChild(item); }); }
  $('#freeAddExo').addEventListener('click',()=>{ const name=prompt('Nom de l\'exercice'); if(!name) return; const target=prompt('Cible (reps/temps)')||''; state.free=state.free||[]; state.free.push({name,target}); persist(); renderFree(); });
  $('#freeClear').addEventListener('click',()=>{ if(confirm('Effacer la séance libre ?')){ state.free=[]; persist(); renderFree(); }});
  $('#freeStart').addEventListener('click',()=>{ if(!state.free||!state.free.length){ alert('Ajoute au moins un exercice.'); return; } state.currentDay=0; state.currentRound=1; updateTodayFree(); activateTab('today','tabTodayBtn'); });
  function updateTodayFree(){ const list=$('#workoutList'); list.innerHTML=''; $('#todayTitle').textContent='Séance Libre'; $('#todayBadge').textContent='Libre'; $('#roundChip').textContent='Manche 1/1'; (state.free||[]).forEach((x,idx)=>{ const key=`F:${idx}`; const reps=state.repsLog[key]||0; const el=document.createElement('div'); el.className='workout-item'; el.innerHTML=`<div><div class='h2'>${x.name}</div><div class='label'>Cible: ${x.target||'-'}</div></div><div class='row'><span class='pill'>${reps} reps</span><div class='counter'><button data-k='${key}' data-a='-'>−</button><button data-k='${key}' data-a='+'>+</button></div></div>`; el.querySelectorAll('button[data-k]').forEach(b=>b.addEventListener('click',()=>{ const k=b.dataset.k; let v=state.repsLog[k]||0; v+=(b.dataset.a==='+')?1:-1; state.repsLog[k]=Math.max(0,v); persist(); updateTodayFree(); })); list.appendChild(el); }); }

  // Skills
  function renderSkills(){ const box=$('#skillsList'); box.innerHTML=''; Object.keys(state.skills).forEach(k=>{ const v=state.skills[k]; const row=document.createElement('div'); row.className='workout-item'; row.innerHTML=`<div><div class='h2'>${k}</div><div class='label'>Niveau: <strong>${v}</strong>/10</div></div><input type='range' min='0' max='10' value='${v}' style='width:160px' aria-label='Niveau ${k}'>`; const slider=row.querySelector('input'); slider.addEventListener('input',()=>{ state.skills[k]=+slider.value; persist(); renderSkills(); }); box.appendChild(row); }); }

  // History + export PDF
  function addHistory(kind){ const d=new Date(); state.history.unshift({ kind, at:d.toISOString(), day:state.currentDay, round:state.currentRound }); state.history = state.history.slice(0,200); persist(); renderHistory(); }
  function renderHistory(){ const box=$('#historyList'); box.innerHTML=''; (state.history||[]).forEach(h=>{ const div=document.createElement('div'); div.className='workout-item'; const when=new Date(h.at).toLocaleString(); div.innerHTML=`<div><div class='h2'>${h.kind==='start'?'Séance lancée':'Intervals'}</div><div class='label'>${when} · ${h.day?('Jour '+h.day):'Libre'}</div></div>`; box.appendChild(div); }); }
  $('#exportPDF').addEventListener('click',()=>{ window.print(); });
  $('#clearHistory').addEventListener('click',()=>{ if(confirm('Effacer tout l\'historique ?')){ state.history=[]; persist(); renderHistory(); }});

  // Import / Export
  $('#exportData').addEventListener('click',()=>{ const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=Object.assign(document.createElement('a'),{href:url,download:'calisfit-data.json'}); a.click(); URL.revokeObjectURL(url); });
  $('#importFile').addEventListener('change',e=>{ const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const data=JSON.parse(r.result); Object.assign(state,data); persist(); init(); }catch{ alert('Fichier invalide'); } }; r.readAsText(f); });

  // Competition
  $('#shareCode').addEventListener('click',()=>{ const payload={ totals:state.totals, calendar:state.calendar, skills:state.skills }; const code=btoa(unescape(encodeURIComponent(JSON.stringify(payload)))); $('#codeArea').value=code; navigator.clipboard?.writeText(code).catch(()=>{}); alert('Code copié.'); });
  $('#importCode').addEventListener('click',()=>{ const code=$('#codeArea').value.trim(); if(!code) return alert('Colle un code.'); try{ const obj=JSON.parse(decodeURIComponent(escape(atob(code)))); const my=state.totals.reps; const other=obj.totals?.reps||0; alert(`Comparaison (reps totales): Toi ${my} vs Ami ${other}`); }catch{ alert('Code invalide'); } });

  // Exercise Guide
  function renderExerciseGuide(){
    const list=$('#exGuideList'); if(!list) return;
    const q=($('#exGuideSearch')?.value||'').toLowerCase();
    list.innerHTML='';
    const keys=Object.keys(EX_DB).sort((a,b)=>tName(a).localeCompare(tName(b),'fr'));
    keys.forEach(k=>{
      const fr=tName(k); if(q && !fr.toLowerCase().includes(q)) return;
      const ex=EX_DB[k]; const details=document.createElement('details'); details.className='workout-item';
      const summary=document.createElement('summary'); summary.innerHTML=`<div class='h2'>${fr}</div><div class='label'>${ex.setup||''}</div>`;
      const body=document.createElement('div'); body.className='label'; body.style.marginTop='8px';
      body.innerHTML=`<strong>Positionnement :</strong> ${ex.setup||'-'}<br><strong>Indices techniques :</strong> ${ex.cues||'-'}<br><strong>Erreurs fréquentes :</strong> ${ex.errors||'-'}`;
      details.appendChild(summary); details.appendChild(body); list.appendChild(details);
    });
  }
  $('#exGuideSearch')?.addEventListener('input', renderExerciseGuide);

  function updateStats(){ let sum=0; for(const k in state.repsLog){ sum += (state.repsLog[k]||0); } state.totals.reps=sum; $('#totalReps').textContent=String(sum); $('#totalTime').textContent=fmtTime(state.totals.time||0); $('#totalSessions').textContent=`${state.totals.sessions||0} séances`; $('#bestStreak').textContent=String(state.totals.bestStreak||0); $('#streakChip').textContent=`🔥 Série: ${state.totals.streak||0}`; }

  $('#duplicate3m').addEventListener('click',()=>{ alert('Astuce: Répète ce plan 3 fois (3 cycles). Utilise le calendrier pour suivre sur 12 semaines.'); });

  function init(){ buildDaysList(); buildCalendar(); updateToday(); updateStats(); renderHistory(); renderFree(); renderSkills(); renderExerciseGuide(); document.querySelector('#restDisplay').textContent='00:00'; }
  init();
  </script>
</body>
</html>
