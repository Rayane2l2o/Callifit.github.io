<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#0b0d12" />
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png" sizes="180x180" />
  <title>CalisFit · Calisthénie</title>
  <style>
    /* ===== Base / iPhone-friendly ===== */
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:#0b0d12;color:#e7edf7;font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",Inter,Roboto,system-ui,Segoe UI,Helvetica,Arial,sans-serif;-webkit-font-smoothing:antialiased;overscroll-behavior-y:none;-webkit-tap-highlight-color:transparent}
    :root{
      --bg:#0b0d12;--card:#0f1424;--muted:#a9b2c3;--accent:#ffd54a;--accent2:#5eead4;--ok:#4ade80;--danger:#ff6b6b;--ring:0 0 0 .12rem rgba(255,213,74,.4);--shadow:0 12px 32px rgba(0,0,0,.35);--radius:18px;--safe-b:calc(env(safe-area-inset-bottom));--safe-t:calc(env(safe-area-inset-top));--maxw:430px
    }
    .app{min-height:calc(var(--vh,1vh)*100);display:flex;flex-direction:column}
    .container{width:100%;max-width:var(--maxw);margin:0 auto}

    /* ===== Topbar ===== */
    .topbar{position:sticky;top:0;z-index:20;background:linear-gradient(180deg,rgba(11,13,18,.95),rgba(11,13,18,.6));backdrop-filter:blur(10px);padding:calc(8px + var(--safe-t)) 16px 10px;border-bottom:1px solid rgba(255,255,255,.06)}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .logo{width:34px;height:34px;border-radius:10px;background:radial-gradient(120% 120% at 10% 10%, var(--accent) 0%, #fffa 40%, transparent 60%),linear-gradient(135deg,#141a2b,#0f1321);box-shadow:inset 0 0 0 1px rgba(255,255,255,.08),0 10px 24px rgba(255,213,74,.25)}
    .title{font-weight:800;font-size:18px}
    .subtitle{color:var(--muted);font-size:12px}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);color:var(--muted);font-size:12px}

    /* ===== Tabs (bottom nav) — corrigé (pas de fond blanc iOS) ===== */
    .tabs{position:fixed;left:0;right:0;bottom:0;height:90px;padding-bottom:var(--safe-b);background:rgba(10,12,18,.92);backdrop-filter:blur(12px);border-top:1px solid rgba(255,255,255,.06);display:grid;grid-template-columns:repeat(5,1fr);z-index:50}
    .tab{
      position:relative;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      gap:6px;color:var(--muted);text-decoration:none;font-size:12px;cursor:pointer;
      transition:200ms transform;min-height:64px;padding:8px 0 10px;
      /* neutralise le style par défaut des <button> qui créait le fond blanc */
      background:transparent !important;
      border:0 !important;
      -webkit-appearance:none;
      appearance:none;
      box-shadow:none;
      outline:none;
    }
    .tab:active{transform:translateY(1px)}
    .ico{width:28px;height:28px;border-radius:10px;display:grid;place-items:center;background:transparent!important;box-shadow:none;border:none}
    .tab.active{color:#fff}
    .tab.active .ico{box-shadow:none}

    /* ===== Sections / cards ===== */
    main{padding:12px 14px 110px}
    section{display:none;opacity:0;transform:translateY(8px);transition:opacity .25s ease,transform .25s ease}
    section.active{display:block;opacity:1;transform:none}
    section > *{max-width:var(--maxw);margin:0 auto 14px}
    .card{background:linear-gradient(180deg,#0f1424,#0c1120);border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px}
    .grid{display:grid;gap:14px}
    .grid.two{grid-template-columns:1fr 1fr}
    .grid.three{grid-template-columns:repeat(3,1fr)}

    .btn{appearance:none;border:0;padding:12px 14px;border-radius:14px;background:#1a2236;color:#eaf1ff;box-shadow:inset 0 0 0 1px rgba(255,255,255,.08);display:inline-flex;align-items:center;gap:10px;cursor:pointer}
    .btn.primary{background:linear-gradient(135deg,#1f2333,#1a1f2e);box-shadow:inset 0 0 0 1px rgba(255,255,255,.08),0 10px 24px rgba(255,213,74,.15)}
    .btn.ghost{background:transparent;box-shadow:inset 0 0 0 1px rgba(255,255,255,.15)}
    .h1{font-size:22px;font-weight:800}
    .h2{font-size:16px;font-weight:700}
    .label{font-size:12px;color:var(--muted)}
    .pill{font-size:11px;padding:6px 9px;border-radius:999px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08)}

    .workout-item{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;padding:10px;border-radius:14px;background:linear-gradient(180deg,#10162a,#0c1120);border:1px solid rgba(255,255,255,.06)}
    .workout-item.done{opacity:.6}
    .counter{display:flex;align-items:center;gap:6px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);padding:6px;border-radius:12px}
    .counter button{width:32px;height:32px;border-radius:10px;background:#192036;color:#fff;border:1px solid rgba(255,255,255,.08)}

    .timer{display:grid;place-items:center;padding:14px}
    .time{font-size:42px;font-weight:800;letter-spacing:1px}

    .calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .day{aspect-ratio:1/1;display:grid;place-items:center;font-size:12px;color:var(--muted);border:1px dashed rgba(255,255,255,.08);border-radius:10px}
    .day.done{background:rgba(74,222,128,.15);color:#eafff3;border:1px solid rgba(74,222,128,.3)}
    .day.off{background:rgba(255,107,107,.12);color:#ffeaea;border:1px solid rgba(255,107,107,.28)}

    /* ===== Landscape tweaks ===== */
    @media (orientation:landscape){
      main{padding-bottom:96px}
      .grid.two{grid-template-columns:1.2fr .8fr}
      .time{font-size:36px}
    }

    /* ===== Small screens ===== */
    @media (max-width:430px){
      .grid.two{grid-template-columns:1fr}
      .grid.three{grid-template-columns:1fr 1fr}
      .time{font-size:clamp(28px,8vw,42px)}
      .h1{font-size:clamp(18px,5vw,22px)}
      .h2{font-size:clamp(14px,4.5vw,16px)}
    }

    /* ===== Accessibility helpers ===== */
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);border:0}
    :focus-visible{outline:2px solid var(--accent);outline-offset:2px}

    /* ===== Print (export PDF) ===== */
    @media print{
      body{background:#fff;color:#000}
      .tabs,.topbar{display:none !important}
      main{padding:0}
      .card{box-shadow:none;border:1px solid #ccc}
    }

    /* auto: exercise gif thumbnail */
    .exercise-gif{width:40px;height:40px;margin-right:8px;border-radius:6px;object-fit:cover;vertical-align:middle}

/* Smooth menu transition */
section {
  opacity: 0;
  transform: translateY(10px);
  transition: opacity 0.5s ease, transform 0.5s ease;
}
section.active {
  opacity: 1;
  transform: translateY(0);
}

/* ==== Smooth animations (0.5s) across the app ==== */
@keyframes fadeSlide { from { opacity:0; transform: translateY(8px);} to { opacity:1; transform: translateY(0);} }
@keyframes pop { 0%{transform:scale(.9);opacity:.6} 60%{transform:scale(1.04)} 100%{transform:scale(1);opacity:1} }
@keyframes flash { 0%,100%{box-shadow:none} 50%{box-shadow:0 0 0.6rem rgba(255,213,74,.45);} }

/* Sections (tabs) */
section { will-change: opacity, transform; transition: opacity .5s ease, transform .5s ease; }
section.enter { animation: fadeSlide .5s ease both; }

/* Cards & items */
.card, .workout-item, .chip { transition: transform .25s ease, box-shadow .25s ease, background-color .25s ease, border-color .25s ease; }
.card:hover, .workout-item:hover { transform: translateY(-2px); box-shadow: var(--shadow); }

/* Buttons */
.btn { transition: transform .2s ease, box-shadow .2s ease, background-color .2s ease, border-color .2s ease; }
.btn:hover { transform: translateY(-2px) scale(1.02); box-shadow: var(--shadow); }
.btn:active { transform: translateY(0) scale(0.98); }

/* Badges: pop when unlocked */
#badgesList .workout-item.done { animation: pop .5s ease both; }
#xpChip { animation: fadeSlide .5s ease both; }

/* Calendar days */
#calendar .day { transition: transform .2s ease, background-color .2s ease, border-color .2s ease; }
#calendar .day:hover { transform: scale(1.03); }
#calendar .day.done { animation: flash .5s ease; }

/* Nav (if anchors exist) */
nav a { transition: color .2s ease, border-color .3s ease; }

/* ==== Mobile-first, smooth horizontal transitions + badge pop-once ==== */
@keyframes slideInFromRight { from { transform: translateX(20px); opacity:.0;} to { transform: translateX(0); opacity:1;} }
@keyframes slideInFromLeft  { from { transform: translateX(-20px); opacity:.0;} to { transform: translateX(0); opacity:1;} }
@keyframes slideOutToLeft   { from { transform: translateX(0); opacity:1;} to { transform: translateX(-20px); opacity:.0;} }
@keyframes slideOutToRight  { from { transform: translateX(0); opacity:1;} to { transform: translateX(20px); opacity:.0;} }

section { will-change: transform, opacity; }
section.active { display:block; }
section:not(.active) { display:none; }

.section-enter-left  { animation: slideInFromLeft  .5s ease both; }
.section-enter-right { animation: slideInFromRight .5s ease both; }
.section-exit-left   { animation: slideOutToLeft   .5s ease both; }
.section-exit-right  { animation: slideOutToRight  .5s ease both; }

/* One-off pop when a badge is newly unlocked */
.badge-pop-once { animation: pop .5s ease both; }

/* Touch: smoother scrolling and tap feedback */
* { -webkit-tap-highlight-color: transparent; }
html, body { overscroll-behavior-y: none; }

/* Respect reduced motion */
@media (prefers-reduced-motion: reduce) {
  * { animation-duration: .01ms !important; animation-iteration-count: 1 !important; transition-duration: .01ms !important; }
}

/* ===== iOS-like visual layer (non-breaking, overrides only) ===== */
:root{
  --ios-accent:#34C759; /* iOS green */
  --ios-bg-trans:rgba(20,24,35,.72);
  --ios-border:rgba(255,255,255,.12);
  --ios-card:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  --ios-btn:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.05));
  --ios-btn-ghost:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
}

/* Body subtle font smoothing */
body{ -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }

/* Translucent nav (like iOS tab bar) */
nav{
  backdrop-filter:saturate(180%) blur(18px);
  -webkit-backdrop-filter:saturate(180%) blur(18px);
  background:var(--ios-bg-trans)!important;
  border-top:1px solid var(--ios-border);
}

/* Cards: softer, rounder, glassy */
.card{
  border-radius:22px!important;
  border:1px solid var(--ios-border)!important;
  background:var(--ios-card)!important;
  box-shadow:0 8px 24px rgba(0,0,0,.25)!important;
}

/* Workout items as rounded list cells */
.workout-item{
  border-radius:18px!important;
  border:1px solid var(--ios-border)!important;
  background:var(--ios-card)!important;
}

/* Chips: pill */
.chip{
  border-radius:999px!important;
  border:1px solid var(--ios-border)!important;
  background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04))!important;
  padding:.35rem .7rem!important;
}

/* Buttons */
.btn{
  border-radius:14px!important;
  border:1px solid rgba(255,255,255,.18)!important;
  background:var(--ios-btn)!important;
  box-shadow:0 2px 0 rgba(255,255,255,.08) inset, 0 8px 20px rgba(0,0,0,.25)!important;
  transition:transform .15s ease, box-shadow .2s ease, background .2s ease!important;
}
.btn:hover{ transform:translateY(-1px); }
.btn:active{ transform:translateY(0) scale(.98); }

/* Primary button = iOS accent */
.btn.primary{
  border:1px solid rgba(52,199,89,.6)!important;
  background:linear-gradient(180deg, rgba(52,199,89,.9), rgba(52,199,89,.7))!important;
  box-shadow:0 2px 0 rgba(255,255,255,.15) inset, 0 8px 22px rgba(52,199,89,.35)!important;
  color:#07140b!important;
  font-weight:600;
}

/* Ghost button */
.btn.ghost{
  border:1px solid var(--ios-border)!important;
  background:var(--ios-btn-ghost)!important;
}

/* Inputs / selects */
input[type="text"], input[type="number"], select, textarea{
  border-radius:14px!important;
  border:1px solid var(--ios-border)!important;
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03))!important;
  outline:none!important;
  box-shadow:0 1px 0 rgba(255,255,255,.06) inset;
}

/* Checkbox and radio accent */
input[type="checkbox"], input[type="radio"]{ accent-color: var(--ios-accent); }

/* Switch-like checkboxes (only when wrapped inside label.row span+input) */
label.row input[type="checkbox"]{
  appearance:none; -webkit-appearance:none; width:44px; height:26px; border-radius:999px;
  position:relative; border:1px solid var(--ios-border); background:rgba(255,255,255,.08);
  outline:none; transition:background .2s ease, border-color .2s ease;
}
label.row input[type="checkbox"]::after{
  content:""; position:absolute; top:2px; left:2px; width:22px; height:22px; border-radius:50%;
  background:#fff; box-shadow:0 2px 8px rgba(0,0,0,.35);
  transition:transform .2s ease;
}
label.row input[type="checkbox"]:checked{ background:var(--ios-accent); border-color:rgba(52,199,89,.8); }
label.row input[type="checkbox"]:checked::after{ transform:translateX(18px); }

/* Section headings typography */
.h2{ font-weight:700; letter-spacing:.2px; }

/* Dialog polish */
dialog{
  border-radius:22px!important;
  border:1px solid var(--ios-border)!important;
  background:linear-gradient(180deg, rgba(30,35,50,.98), rgba(20,24,35,.98))!important;
  backdrop-filter:saturate(180%) blur(14px);
}

/* iOS-like segmented control for difficulty buttons (reuse data-diff) */
[data-diff]{
  border-radius:999px!important;
  padding:.6rem 1rem!important;
}
[data-diff].primary{
  background:linear-gradient(180deg, rgba(52,199,89,.92), rgba(52,199,89,.78))!important;
  color:#061408!important;
}

/* ===== iOS-like visual layer (blue accent + light/dark auto) ===== */
:root{
  --ios-accent:#007AFF; /* iOS blue */
  --ios-border:rgba(255,255,255,.12);
  --ios-blur:18px;
  --ios-card-dark:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  --ios-card-light:linear-gradient(180deg, rgba(0,0,0,.04), rgba(0,0,0,.02));
  --ios-btn-dark:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.05));
  --ios-btn-light:linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,255,255,.7));
  --ios-nav-dark:rgba(20,24,35,.72);
  --ios-nav-light:rgba(255,255,255,.72);
}

/* Smooth theme switches */
html.theme-xfade *{
  transition: background-color .4s ease, color .4s ease, border-color .4s ease, box-shadow .4s ease;
}

/* Base transitions for UI (kept subtle for mobile) */
.card, .workout-item, .chip, .btn, input, select, textarea, nav{
  transition: background-color .25s ease, border-color .25s ease, color .25s ease, box-shadow .25s ease;
}

/* ===== Dark mode (default, close to your original style) ===== */
@media (prefers-color-scheme: dark){
/* Header icon-only buttons */
.header-icons{display:flex;gap:10px;align-items:center}
.btn.icon.only{
  min-width:44px;width:44px;height:44px;padding:0;border-radius:14px;
  display:inline-flex;align-items:center;justify-content:center;
  border:1px solid rgba(255,255,255,.10);
  background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
  box-shadow:0 2px 0 rgba(255,255,255,.06) inset, 0 8px 16px rgba(0,0,0,.25);
}
.btn.icon.only svg{fill:currentColor;stroke:currentColor;stroke-width:1.5}
.btn.icon.only:hover{transform:translateY(-1px)}
.btn.icon.only:active{transform:translateY(0)}
.btn.icon.primary.only{
  border:1px solid rgba(0,122,255,.55);
  background:linear-gradient(180deg, rgba(0,122,255,.95), rgba(0,122,255,.78));
  color:#061021;
  box-shadow:0 2px 0 rgba(255,255,255,.12) inset, 0 8px 22px rgba(0,122,255,.32);
}

  body{ background:#0b0d12; color:#e7edf7; }
  nav{
    backdrop-filter:saturate(180%) blur(var(--ios-blur));
    -webkit-backdrop-filter:saturate(180%) blur(var(--ios-blur));
    background:var(--ios-nav-dark)!important;
    border-top:1px solid var(--ios-border);
  }
  .card, .workout-item{
    background:var(--ios-card-dark)!important;
    border:1px solid var(--ios-border)!important;
  }
  .btn{ background:var(--ios-btn-dark)!important; }
  .btn.primary{
    border:1px solid rgba(0,122,255,.55)!important;
    background:linear-gradient(180deg, rgba(0,122,255,.95), rgba(0,122,255,.78))!important;
    box-shadow:0 2px 0 rgba(255,255,255,.12) inset, 0 8px 22px rgba(0,122,255,.32)!important;
    color:#061021!important;
  }
  .btn.ghost{
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03))!important;
  }
}

/* ===== Light mode (clean iOS-like) ===== */
@media (prefers-color-scheme: light){
  body{ background:#f7f8fb; color:#0b0d12; }
  nav{
    backdrop-filter:saturate(180%) blur(var(--ios-blur));
    -webkit-backdrop-filter:saturate(180%) blur(var(--ios-blur));
    background:var(--ios-nav-light)!important;
    border-top:1px solid rgba(0,0,0,.08);
  }
  .card, .workout-item{
    background:var(--ios-card-light)!important;
    border:1px solid rgba(0,0,0,.08)!important;
    box-shadow:0 8px 20px rgba(0,0,0,.06)!important;
  }
  .chip{
    border:1px solid rgba(0,0,0,.08)!important;
    background:linear-gradient(180deg, rgba(0,0,0,.05), rgba(0,0,0,.02))!important;
    color:#0b0d12!important;
  }
  .btn{
    background:var(--ios-btn-light)!important;
    border:1px solid rgba(0,0,0,.08)!important;
    color:#0b0d12!important;
    box-shadow:0 2px 0 rgba(255,255,255,.8) inset, 0 8px 18px rgba(0,0,0,.12)!important;
  }
  .btn.primary{
    border:1px solid rgba(0,122,255,.55)!important;
    background:linear-gradient(180deg, rgba(0,122,255,1), rgba(0,122,255,.82))!important;
    color:#fff!important;
    box-shadow:0 2px 0 rgba(255,255,255,.35) inset, 0 8px 20px rgba(0,122,255,.28)!important;
  }
  .btn.ghost{
    background:linear-gradient(180deg, rgba(0,0,0,.04), rgba(0,0,0,.02))!important;
  }
  input[type="text"], input[type="number"], select, textarea{
    background:linear-gradient(180deg, rgba(255,255,255,1), rgba(255,255,255,.92))!important;
    border:1px solid rgba(0,0,0,.08)!important;
    color:#0b0d12!important;
  }
}

/* Switch knob color remains consistent */
label.row input[type="checkbox"]:checked{ background:var(--ios-accent); border-color:rgba(0,122,255,.75); }

/* ===== Manual theme force (overrides media queries) ===== */
html.force-dark body{ background:#0b0d12; color:#e7edf7; }
html.force-dark nav{
  backdrop-filter:saturate(180%) blur(var(--ios-blur));
  -webkit-backdrop-filter:saturate(180%) blur(var(--ios-blur));
  background:var(--ios-nav-dark)!important;
  border-top:1px solid var(--ios-border);
}
html.force-dark .card, html.force-dark .workout-item{
  background:var(--ios-card-dark)!important;
  border:1px solid var(--ios-border)!important;
}
html.force-dark .btn{ background:var(--ios-btn-dark)!important; color:#e7edf7!important; }
html.force-dark .btn.primary{
  border:1px solid rgba(0,122,255,.55)!important;
  background:linear-gradient(180deg, rgba(0,122,255,.95), rgba(0,122,255,.78))!important;
  color:#061021!important;
}
html.force-dark .btn.ghost{
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03))!important;
}
html.force-dark input[type="text"], html.force-dark input[type="number"], html.force-dark select, html.force-dark textarea{
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03))!important;
  border:1px solid var(--ios-border)!important;
  color:#e7edf7!important;
}

html.force-light body{ background:#f7f8fb; color:#0b0d12; }
html.force-light nav{
  backdrop-filter:saturate(180%) blur(var(--ios-blur));
  -webkit-backdrop-filter:saturate(180%) blur(var(--ios-blur));
  background:var(--ios-nav-light)!important;
  border-top:1px solid rgba(0,0,0,.08);
}
html.force-light .card, html.force-light .workout-item{
  background:var(--ios-card-light)!important;
  border:1px solid rgba(0,0,0,.08)!important;
  box-shadow:0 8px 20px rgba(0,0,0,.06)!important;
}
html.force-light .chip{
  border:1px solid rgba(0,0,0,.08)!important;
  background:linear-gradient(180deg, rgba(0,0,0,.05), rgba(0,0,0,.02))!important;
  color:#0b0d12!important;
}
html.force-light .btn{
  background:var(--ios-btn-light)!important;
  border:1px solid rgba(0,0,0,.08)!important;
  color:#0b0d12!important;
  box-shadow:0 2px 0 rgba(255,255,255,.8) inset, 0 8px 18px rgba(0,0,0,.12)!important;
}
html.force-light .btn.primary{
  border:1px solid rgba(0,122,255,.55)!important;
  background:linear-gradient(180deg, rgba(0,122,255,1), rgba(0,122,255,.82))!important;
  color:#fff!important;
  box-shadow:0 2px 0 rgba(255,255,255,.35) inset, 0 8px 20px rgba(0,122,255,.28)!important;
}
html.force-light .btn.ghost{
  background:linear-gradient(180deg, rgba(0,0,0,.04), rgba(0,0,0,.02))!important;
}
html.force-light input[type="text"], html.force-light input[type="number"], html.force-light select, html.force-light textarea{
  background:linear-gradient(180deg, rgba(255,255,255,1), rgba(255,255,255,.92))!important;
  border:1px solid rgba(0,0,0,.08)!important;
  color:#0b0d12!important;
}

/* Haptic fallback: tiny press animation */
@keyframes hapticPress { 0%{transform:scale(1)} 50%{transform:scale(.985)} 100%{transform:scale(1)} }
.haptic-press { animation: hapticPress .12s ease; }

/* Light theme: brighter buttons + search input */
@media (prefers-color-scheme: light){
  /* include search input */
  input[type="search"]{
    background:linear-gradient(180deg, rgba(255,255,255,1), rgba(255,255,255,.92))!important;
    border:1px solid rgba(0,0,0,.08)!important;
    color:#0b0d12!important;
  }
  /* make all buttons lighter */
  .btn{
    background:linear-gradient(180deg, #f2f5fb, #e9eef7)!important;
    border:1px solid rgba(0,0,0,.08)!important;
    color:#0b0d12!important;
    box-shadow:0 2px 0 rgba(255,255,255,.85) inset, 0 8px 18px rgba(0,0,0,.10)!important;
  }
  .btn.primary{
    background:linear-gradient(180deg, rgba(0,122,255,1), rgba(0,122,255,.82))!important;
    color:#fff!important;
  }
}
/* Force-light override (manual theme) */
html.force-light input[type="search"]{
  background:linear-gradient(180deg, rgba(255,255,255,1), rgba(255,255,255,.92))!important;
  border:1px solid rgba(0,0,0,.08)!important;
  color:#0b0d12!important;
}
html.force-light .btn{
  background:linear-gradient(180deg, #f2f5fb, #e9eef7)!important;
  border:1px solid rgba(0,0,0,.08)!important;
  color:#0b0d12!important;
  box-shadow:0 2px 0 rgba(255,255,255,.85) inset, 0 8px 18px rgba(0,0,0,.10)!important;
}
html.force-light .btn.primary{
  background:linear-gradient(180deg, rgba(0,122,255,1), rgba(0,122,255,.82))!important;
  color:#fff!important;
}

/* Light mode: lighten +/- counter buttons */
@media (prefers-color-scheme: light){
  .counter button{
    background:linear-gradient(180deg, #f5f7fc, #ebeff7) !important;
    color:#0b0d12 !important;
    border:1px solid rgba(0,0,0,.08) !important;
    box-shadow:0 1px 0 rgba(255,255,255,.9) inset, 0 6px 16px rgba(0,0,0,.08) !important;
  }
}
html.force-light .counter button{
  background:linear-gradient(180deg, #f5f7fc, #ebeff7) !important;
  color:#0b0d12 !important;
  border:1px solid rgba(0,0,0,.08) !important;
  box-shadow:0 1px 0 rgba(255,255,255,.9) inset, 0 6px 16px rgba(0,0,0,.08) !important;
}

/* === Remove the big topbar and show only a small logo === */
.topbar{ display:none !important; height:0 !important; padding:0 !important; border:0 !important; }
.mini-logo{
  position:fixed; z-index:30;
  top:calc(8px + var(--safe-t)); left:12px;
  width: 32px; height: 32px; border-radius:8px;
  box-shadow:0 4px 14px rgba(0,0,0,.28);
  pointer-events:none; /* purely decorative */
}
@media (prefers-color-scheme: light){
  .mini-logo{ box-shadow:0 4px 10px rgba(0,0,0,.12); }
}

/* Light mode: clearer tab text colors */
@media (prefers-color-scheme: light){
  .tab{ color: rgba(11,13,18,.60) !important; }
  .tab.active{ color:#0b0d12 !important; font-weight:600; }
}
/* Manual light override */
html.force-light .tab{ color: rgba(11,13,18,.60) !important; }
html.force-light .tab.active{ color:#0b0d12 !important; font-weight:600; }

/* ==== Exercise Guide: smooth expand / collapse ==== */
#exGuideList details > .label{
  overflow:hidden;
  max-height:0;
  opacity:0;
  transition:max-height .5s ease, opacity .5s ease;
  will-change:max-height, opacity;
}
#exGuideList details[open] > .label{
  /* max-height is set dynamically on open; default fallback: */
  max-height:800px;
  opacity:1;
}
#exGuideList summary{ cursor:pointer; }

/* Free picker dialog tweaks */
#freePicker::backdrop{ backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); background: rgba(0,0,0,.25); }
#freePicker .btn input{ margin-right:6px }

/* ==== Bottom Sheets for Free Mode (no keyboard) ==== */
.sheet {
  position: fixed; left: 0; right: 0; bottom: 0; top: 0;
  display: none; z-index: 60;
}
.sheet .backdrop {
  position:absolute; inset:0; background:rgba(0,0,0,.25);
  backdrop-filter: blur(2px); -webkit-backdrop-filter: blur(2px);
  opacity:0; transition:opacity .35s ease;
}
.sheet .panel {
  position:absolute; left:0; right:0; bottom:0;
  background: linear-gradient(180deg, rgba(22,26,38,.98), rgba(12,14,20,.98));
  border-top-left-radius: 18px; border-top-right-radius: 18px;
  max-height: 85vh; transform: translateY(100%);
  transition: transform .45s cubic-bezier(.22,.61,.36,1);
  box-shadow: 0 -12px 30px rgba(0,0,0,.35);
}
@media (prefers-color-scheme: light){
  .sheet .panel{ background: linear-gradient(180deg, rgba(255,255,255,.98), rgba(245,247,252,.98)); }
}
.sheet.open { display:block; }
.sheet.open .backdrop { opacity:1; }
.sheet.open .panel { transform: translateY(0); }
.sheet.closing .backdrop { opacity:0; }
.sheet.closing .panel { transform: translateY(100%); }

/* Exercise list items for picker */
#sheetExList { padding: 10px 12px 18px; overflow:auto; max-height: 70vh; }
.sheet .ex-row {
  display:flex; align-items:center; gap:10px; padding:10px;
  border-radius:14px; border:1px solid rgba(255,255,255,.10);
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
}
.sheet .ex-row img { width:56px; height:56px; object-fit:cover; border-radius:10px; }
.sheet .ex-row .name { font-weight:600; }
.sheet .ex-row .meta { font-size:.85rem; opacity:.8; }
.sheet .ex-row .add { margin-left:auto; }

@media (prefers-color-scheme: light){
  .sheet .ex-row { border:1px solid rgba(0,0,0,.08); background:linear-gradient(180deg, rgba(0,0,0,.04), rgba(0,0,0,.02)); }
}

/* Reps chooser */
#sheetReps .valueBox {
  display:flex; align-items:center; justify-content:center; gap:14px;
  padding:18px 10px;
}
#sheetReps .valueBox .btn { width:56px; height:56px; border-radius:999px; font-size:22px; }
#sheetReps .valueBox .num { font-size:28px; width:90px; text-align:center; font-weight:700; }
#sheetReps .actions { display:flex; justify-content:flex-end; gap:8px; padding:0 14px 14px; }

/* Floating controls above bottom nav */
#quickControls{
  position:fixed; left:12px; right:12px; bottom:72px; z-index:40;
  display:flex; gap:8px; justify-content:space-between;
}
#quickControls{} .btn{ flex:1; }
@media (max-width:420px){
  #quickControls{ bottom:68px; }
}

/* Today header simplification */
#tab-today > .card:first-of-type .label{ display:none !important; }
#motivation{ display:none !important; }

#quickControls{}

/* Hide unused sections/cards */
#tab-programs .card:first-of-type { display:none !important; } /* Plan actif + Générer 3 mois */
#freeModeCard, #notesCard, #a11yCard, #skillsCard { display:none !important; }

  /* Center tables in stats tab */
  #stats table, .stats table {
    margin-left: auto;
    margin-right: auto;
  }

/* === Dark mode tweaks === */
@media (prefers-color-scheme: dark) {
  /* Increase contrast only in dark mode for the previous-day button */
  button[id*="prev" i],
  button[class*="prev" i],
  .btn-prev, #prev, #prevDay {
    background-color: #1f2430 !important;
    color: #ffffff !important;
    border: 1px solid #ffffff !important;
    box-shadow: 0 0 0 2px rgba(255,255,255,0.08), 0 6px 16px rgba(0,0,0,0.5) !important;
  }
  /* Hover/focus states for accessibility */
  button[id*="prev" i]:hover,
  button[class*="prev" i]:hover,
  .btn-prev:hover, #prev:hover, #prevDay:hover,
  button[id*="prev" i]:focus-visible,
  button[class*="prev" i]:focus-visible,
  .btn-prev:focus-visible, #prev:focus-visible, #prevDay:focus-visible {
    outline: 2px solid #fff !important;
    outline-offset: 2px !important;
    filter: brightness(1.08);
  }
}

/* === Prevent layout shift on day navigation === */
[class*="day" i][class*="button" i],
[id*="day" i][id*="button" i],
[class*="buttons" i][class*="day" i],
#days, .days, .day-buttons, .days-bar {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 8px;
  min-height: 48px; /* reserve space to avoid jumps */
}

#days button, .days button, .day-buttons button, .days-bar button,
button[id*="day" i], button[class*="day" i] {
  min-width: 44px;
  padding: 10px 12px;
  line-height: 1.1;
  font-weight: 600;
  border-width: 1px; /* same in active/normal to avoid expansion */
}

/* Ensure active/selected states don't change sizing */
#days button.active, .days button.active, .day-buttons button.active,
button[id*="day" i].active, button[class*="day" i].active {
  font-weight: 600;
  border-width: 1px;
}

@media (prefers-color-scheme: light){
  .btn.icon.only{
    border:1px solid rgba(0,0,0,.10)!important;
    background:linear-gradient(180deg, rgba(255,255,255,1), rgba(255,255,255,.92))!important;
    color:#0b0d12!important;
    box-shadow:0 2px 0 rgba(255,255,255,.35) inset, 0 8px 20px rgba(0,0,0,.08)!important;
  }
  .btn.icon.primary.only{
    border:1px solid rgba(0,122,255,.45)!important;
    background:linear-gradient(180deg, rgba(0,122,255,1), rgba(0,122,255,.90))!important;
    color:#fff!important;
    box-shadow:0 2px 0 rgba(255,255,255,.35) inset, 0 8px 20px rgba(0,122,255,.28)!important;
  }
}
</style>

    <link rel="icon" href="assets/placeholder.png" sizes="192x192" />

  <link rel="icon" sizes="192x192" href="icons/icon-192.png">
  <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon-180.png">
<style>
  /* ===== Safe-area handling & logo cleanup ===== */
  :root { --safe-top: max(env(safe-area-inset-top, 0px), 84px); }
  .safe-area-spacer { height: var(--safe-top); }

  /* Push main UI below the spacer if a fixed header exists */
  body { padding-top: 0; background-color: #0b0d12; }

  /* Defensive: hide any leftover logo elements */
  .logo, .app-logo, .floating-logo, [data-logo], img[alt*="logo" i] { display:none !important; }

</style>

<style id="calisfit-redesign">
  :root{
    --bg-0:#0b0d12; --bg-1:#0f1117; --surface:#12151d;
    --glass:rgba(255,255,255,0.06); --glass-strong:rgba(255,255,255,0.12);
    --txt-1:#e8ecf1; --txt-2:#b7c0cc;
    --accent:#7dd3fc; --accent-2:#a78bfa;
    --ok:#34d399; --warn:#f59e0b; --danger:#f87171;
    --radius-1:14px; --radius-2:20px;
    --shadow-1:0 6px 18px rgba(0,0,0,0.25);
    --shadow-2:0 20px 40px rgba(0,0,0,0.35);
    --ring:0 0 0 3px color-mix(in oklab, var(--accent) 35%, transparent);
    --speed-fast:180ms; --speed-med:300ms; --speed-slow:600ms;
  }
  @media (prefers-color-scheme: light){
    :root{
      --bg-0:#f7f9fc; --bg-1:#eef2f7; --surface:#ffffff;
      --glass:rgba(0,0,0,0.04); --glass-strong:rgba(0,0,0,0.08);
      --txt-1:#0f172a; --txt-2:#475569;
      --shadow-1:0 6px 18px rgba(0,0,0,0.08);
      --shadow-2:0 20px 40px rgba(0,0,0,0.12);
      --ring:0 0 0 3px color-mix(in oklab, var(--accent) 45%, transparent);
    }
  }
  body{ background: var(--bg-0); color:var(--txt-1); accent-color:var(--accent);
        -webkit-tap-highlight-color: transparent; text-rendering:optimizeLegibility; font-synthesis-weight:none; }
  body::before{
    content:""; position:fixed; inset:-20vmax; z-index:-2;
    background:
      radial-gradient(60vmax 60vmax at 15% 20%, color-mix(in oklab, var(--accent) 24%, transparent), transparent 60%),
      radial-gradient(70vmax 70vmax at 85% 30%, color-mix(in oklab, var(--accent-2) 22%, transparent), transparent 60%),
      radial-gradient(80vmax 80vmax at 50% 120%, color-mix(in oklab, #22d3ee 12%, transparent), transparent 65%);
    filter: blur(40px) saturate(110%);
    animation: bgFloat var(--speed-slow) ease-in-out infinite alternate;
  }
  @keyframes bgFloat { from { transform: translate3d(0,0,0) scale(1); } to { transform: translate3d(0,-1.5%,0) scale(1.02); } }
  body::after{ content:""; position:fixed; inset:0; z-index:-1;
    background: linear-gradient(to bottom, rgba(0,0,0,.14), transparent 30%, rgba(0,0,0,.18)); pointer-events:none; }
  .card, .panel, .box, .module, .sheet, section, article{
    background: linear-gradient(180deg, color-mix(in oklab, var(--surface) 86%, transparent), color-mix(in oklab, var(--surface) 94%, transparent));
    backdrop-filter: saturate(120%) blur(8px);
    border:1px solid var(--glass); border-radius: var(--radius-2);
    box-shadow: var(--shadow-1);
    transition: transform var(--speed-med) ease, box-shadow var(--speed-med) ease, border-color var(--speed-fast) ease;
    will-change: transform;
  }
  .card:hover, .panel:hover, .box:hover, .module:hover, .sheet:hover, section:hover, article:hover{
    transform: translateY(-2px); box-shadow: var(--shadow-2); border-color: var(--glass-strong);
  }
  .btn, button, [role="button"], input[type="button"], input[type="submit"]{
    appearance:none; border:0; border-radius: calc(var(--radius-1) + 4px);
    background:
      linear-gradient(180deg, color-mix(in oklab, var(--accent) 90%, transparent), color-mix(in oklab, var(--accent) 70%, transparent)),
      linear-gradient(180deg, color-mix(in oklab, var(--surface) 70%, transparent), color-mix(in oklab, var(--surface) 92%, transparent));
    color:#081016; font-weight:700; letter-spacing:.2px;
    box-shadow: 0 1px 0 rgba(255,255,255,.25) inset, 0 8px 24px rgba(0,0,0,.25);
    transition: transform var(--speed-fast) ease, box-shadow var(--speed-fast) ease, opacity var(--speed-fast) ease, filter var(--speed-fast) ease;
    position:relative; overflow:hidden; cursor:pointer; outline:none;
  }
  .btn.secondary, button.secondary{
    background:
      linear-gradient(180deg, color-mix(in oklab, var(--accent-2) 90%, transparent), color-mix(in oklab, var(--accent-2) 70%, transparent)),
      linear-gradient(180deg, color-mix(in oklab, var(--surface) 70%, transparent), color-mix(in oklab, var(--surface) 92%, transparent));
  }
  .btn.ok, .success{ background: linear-gradient(180deg, color-mix(in oklab, var(--ok) 90%, transparent), color-mix(in oklab, var(--ok) 70%, transparent)); color:#04110b; }
  .btn.warn{ background: linear-gradient(180deg, color-mix(in oklab, var(--warn) 90%, transparent), color-mix(in oklab, var(--warn) 70%, transparent)); color:#110a04; }
  .btn.danger{ background: linear-gradient(180deg, color-mix(in oklab, var(--danger) 90%, transparent), color-mix(in oklab, var(--danger) 70%, transparent)); color:#1a0505; }
  .btn:hover, button:hover{ transform: translateY(-1px); filter: brightness(1.02); }
  .btn:active, button:active{ transform: translateY(0); filter: brightness(.98); }
  .btn:focus-visible, button:focus-visible{ box-shadow: var(--shadow-2), var(--ring); }
  .btn.prev, .previous, button.prev{
    color: var(--txt-1) !important;
    background: linear-gradient(180deg, #1b2230, #0f1420);
    border:1px solid color-mix(in oklab, var(--txt-1) 18%, transparent);
  }
  input[type="text"], input[type="number"], input[type="search"], input[type="time"], input[type="date"], textarea, select{
    background: linear-gradient(180deg, color-mix(in oklab, var(--surface) 86%, transparent), color-mix(in oklab, var(--surface) 96%, transparent));
    border:1px solid var(--glass); border-radius: var(--radius-1); color:var(--txt-1);
    outline:none; box-shadow:none;
    transition: border-color var(--speed-fast) ease, box-shadow var(--speed-fast) ease, background-color var(--speed-fast) ease;
  }
  input:focus, textarea:focus, select:focus{ border-color: var(--glass-strong); box-shadow: var(--ring); }
  ::placeholder{ color: color-mix(in oklab, var(--txt-2) 70%, transparent); }
  .tab, .pill, .chip{
    background: linear-gradient(180deg, color-mix(in oklab, var(--surface) 70%, transparent), color-mix(in oklab, var(--surface) 95%, transparent));
    border:1px solid var(--glass); border-radius: 999px; color:var(--txt-2);
    transition: color var(--speed-fast) ease, border-color var(--speed-fast) ease, background var(--speed-fast) ease;
  }
  .tab.active, .pill.active, .chip.active{ color:var(--txt-1); border-color: var(--glass-strong); box-shadow: var(--shadow-1); }
  table{ border-collapse:separate; border-spacing:0; overflow:hidden; border-radius: var(--radius-2); }
  thead th{
    background: linear-gradient(180deg, color-mix(in oklab, var(--surface) 92%, transparent), color-mix(in oklab, var(--surface) 96%, transparent));
    color:var(--txt-2); font-weight:700; text-transform:uppercase; letter-spacing:.4px;
    position:sticky; top:0; z-index:2; border-bottom:1px solid var(--glass-strong);
    backdrop-filter: saturate(120%) blur(4px);
  }
  tbody tr{ transition: background var(--speed-fast) ease; }
  tbody tr:hover{ background: color-mix(in oklab, var(--glass) 50%, transparent); }
  td, th{ border-bottom:1px solid var(--glass); }
  .reveal{ opacity:0; transform: translateY(8px); }
  .reveal.is-in{ opacity:1; transform: none; transition: opacity var(--speed-med) ease, transform var(--speed-med) ease; }
  .badge{ display:inline-flex; align-items:center; gap:.5ch; padding:.35em .7em; border-radius:999px; font-weight:600;
          background: color-mix(in oklab, var(--glass) 60%, transparent); border:1px solid var(--glass); }
  .badge.ok{ color:#0a3326; background: color-mix(in oklab, var(--ok) 25%, transparent); border-color: color-mix(in oklab, var(--ok) 45%, transparent); }
  .badge.warn{ color:#3a2405; background: color-mix(in oklab, var(--warn) 25%, transparent); border-color: color-mix(in oklab, var(--warn) 45%, transparent); }
  .badge.danger{ color:#3b0b0b; background: color-mix(in oklab, var(--danger) 25%, transparent); border-color: color-mix(in oklab, var(--danger) 45%, transparent); }
  a{ color: var(--accent); text-decoration: none; } a:hover{ text-decoration: underline; }
  @media (prefers-reduced-motion: reduce){ *{ animation:none !important; transition:none !important; scroll-behavior:auto !important; } }
</style>
<script>
(function(){
  // Ripple effect on all buttons
  const addRipple = (btn) => {
    const style = window.getComputedStyle(btn);
    if (style.position === 'static') btn.style.position = 'relative';
    btn.style.overflow = 'hidden';
    btn.addEventListener('click', (e)=>{
      const r = document.createElement('span');
      const rect = btn.getBoundingClientRect();
      const size = Math.max(rect.width, rect.height) * 1.1;
      const x = e.clientX - rect.left - size/2;
      const y = e.clientY - rect.top - size/2;
      r.style.cssText = \`
        position:absolute; left:\${x}px; top:\${y}px; width:\${size}px; height:\${size}px;
        border-radius:50%; pointer-events:none; opacity:.25;
        background: radial-gradient(circle at 50% 50%, #fff, transparent 55%);
        transform: scale(.2); transition: transform 480ms ease, opacity 620ms ease;
        mix-blend-mode: overlay; z-index:0;\`;
      btn.appendChild(r);
      requestAnimationFrame(()=>{ r.style.transform='scale(1)'; r.style.opacity='0'; });
      setTimeout(()=> r.remove(), 720);
    });
  };
  const ready = () => {
    document.querySelectorAll('button, .btn, [role="button"], input[type="button"], input[type="submit"]').forEach(addRipple);
    // Reveal observer for elements with .reveal
    const io = new IntersectionObserver((entries)=>{
      entries.forEach(ent => { if(ent.isIntersecting){ ent.target.classList.add('is-in'); io.unobserve(ent.target);} });
    }, { rootMargin: '0px 0px -10% 0px', threshold:.05 });
    document.querySelectorAll('.reveal').forEach(el => io.observe(el));
  };
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', ready);
  else ready();
})();
</script>

<style>
/* ===== Modern gradient background optimized for iPhone 15 ===== */
body {
  background: linear-gradient(135deg, #0f2027, #203a43, #2c5364) fixed;
  background-size: 400% 400%;
  animation: bgGradientShift 15s ease infinite;
  color: #fff;
}
@keyframes bgGradientShift {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}
/* Keep cards slightly transparent to blend with background */
.card {
  background-color: rgba(20, 24, 36, 0.85) !important;
  backdrop-filter: blur(8px);
}
</style>

<style>
/* ===== Achievement badges ===== */
.badge-grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(110px,1fr)); gap:10px; }
.achv{
  position: relative; padding:12px; border-radius:16px;
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
  border:1px solid rgba(255,255,255,.08);
  text-align:center;
  overflow:hidden;
  transform: translateZ(0);
}
.achv .icon{ font-size:26px; line-height:1; }
.achv .name{ margin-top:6px; font-weight:600; font-size:12px; opacity:.95; }
.achv .tier{ font-size:11px; opacity:.8; }
.achv.locked{ opacity:.55; filter:saturate(.4) blur(0px); }
.achv .ring{
  position:absolute; inset:-2px;
  border-radius:18px;
  border:2px solid transparent;
  pointer-events:none;
}
.tier-bronze .ring{ border-color:#cd7f32; box-shadow:0 0 12px rgba(205,127,50,.35) inset; }
.tier-silver .ring{ border-color:#c0c0c0; box-shadow:0 0 14px rgba(192,192,192,.4) inset; }
.tier-gold .ring{ border-color:#ffd700; box-shadow:0 0 16px rgba(255,215,0,.45) inset; }
.tier-platinum .ring{ border-color:#e5e4e2; box-shadow:0 0 18px rgba(229,228,226,.5) inset; }

/* Unlock animation */
@keyframes popIn {
  0% { transform: scale(.8); opacity:0; }
  60% { transform: scale(1.08); opacity:1; }
  100% { transform: scale(1); }
}
.achv.unlocked { animation: popIn .5s ease; }

/* Progress bar under each badge */
.achv .bar{
  height:6px; border-radius:6px; background:rgba(255,255,255,.12); margin-top:8px; overflow:hidden;
}
.achv .bar > i{ display:block; height:100%; width:0%; background:linear-gradient(90deg, rgba(255,255,255,.3), rgba(255,255,255,.7)); }

/* Subtle sparkle when leveling up */
@keyframes sparkle {
  from { background-position:-40% 0; }
  to   { background-position:140% 0; }
}
.achv.levelup .bar > i{
  animation: sparkle 1.2s ease;
  background: linear-gradient(90deg, rgba(255,255,255,.2), rgba(255,255,255,1), rgba(255,255,255,.2));
  background-size: 200% 100%;
}
</style>

</head>
<body>

  <div class="safe-area-spacer" aria-hidden="true"></div>

<div id="quickControls">
  <button class="btn" id="nextDayBtn">Jour suivant →</button>
  <button class="btn primary" id="finishBtn">Terminer séance</button>
</div>

  <div class="app" id="app">
    <header class="topbar" role="banner">
      <div class="container row">
        <div class="row" aria-label="CalisFit">
          <div class="logo" aria-hidden="true"></div>
          <div style="line-height:1.1">
            <div class="title">CalisFit</div>
            <div class="subtitle">Programmes · Chronos · Reps · Stats</div>
          </div>
        </div>
        <span class="badge" id="todayBadge" aria-live="polite">Semaine 1 • Jour 1</span>
      </div>
    </header>

    <main class="container" role="main">

      <section id="tab-today" class="active" aria-labelledby="tabTodayBtn" role="region">
        <div class="card" aria-live="polite">
          <div class="row">
            <div>
              <div class="label">Programme actif</div>
              <div class="h1" id="todayTitle">Jour 1 · Full Body</div>
            </div>

            <div class="header-icons" role="group" aria-label="Contrôles du jour">
              <button class="btn icon only" id="prevDayBtn" aria-label="Jour précédent" title="Jour précédent" type="button" >
                <svg viewBox="0 0 24 24" width="22" height="22" aria-hidden="true">
                  <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"></path>
                </svg>
              </button>
              <button class="btn icon primary only" id="startSessionBtn" aria-label="Lancer la séance" title="Lancer la séance">
                <svg viewBox="0 0 24 24" width="22" height="22" aria-hidden="true">
                  <path d="M8 5v14l11-7z"></path>
                </svg>
              </button>
              <button class="btn icon only" id="finishNextBtn" aria-label="Terminer et passer au jour suivant" title="Terminer & Suivant">
                <svg viewBox="0 0 24 24" width="22" height="22" aria-hidden="true">
                  <path d="M9 16.17L4.83 12 3.41 13.41 9 19l12-12-1.41-1.41z"></path>
                </svg>
                <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" style="margin-left:2px">
                  <path d="M10 6l6 6-6 6"></path>
                </svg>
              </button>
            </div>
</div>
          <div class="label" style="margin-top:6px">3 cycles (30 jours × 3 mois) · Swipe ⟷ pour changer de manche</div>
          <div class="badge" id="motivation">💡 « La progression est un voyage, pas une course. »</div>
        </div>

        <div class="card" id="workoutListCard">
          <div class="row" style="margin-bottom:8px">
            <div class="h2">Séance du jour</div>
            <div class="pill" id="roundChip" aria-live="polite">Manche 1/3</div>
          </div>
          <div class="grid" id="workoutList" style="gap:10px"></div>
          <div class="row" style="margin-top:10px">
            <button class="btn" id="prevRound" aria-label="Manche précédente">⟵ Manche</button>
            <button class="btn primary" id="nextRound" aria-label="Manche suivante">Manche suivante ⟶</button>
          </div>
        </div>

        <div class="grid two">
          <div class="card">
            <div class="label">Repos</div>
            <div class="row" style="margin-top:6px;gap:10px">
              <button class="btn" data-rest="30">30s</button>
              <button class="btn" data-rest="60">60s</button>
              <button class="btn" data-rest="90">90s</button>
              <button class="btn" data-rest="180">3min</button>
            </div>
            <div class="timer">
              <div class="time" id="restDisplay" aria-live="polite">00:00</div>
              <div class="row" style="margin-top:8px">
                <button class="btn" id="restStart">Démarrer</button>
                <button class="btn ghost" id="restReset">Réinitialiser</button>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="label">Chrono séance</div>
            <div class="timer">
              <div class="time" id="swDisplay" aria-live="polite">00:00.0</div>
              <div class="row" style="margin-top:8px">
                <button class="btn" id="swStart">Démarrer</button>
                <button class="btn ghost" id="swLap">Tour</button>
                <button class="btn ghost" id="swReset">Remise à zéro</button>
              </div>
              <div class="label" id="swLaps" style="margin-top:6px"></div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="row"><div class="h2">Notes</div><button class="btn ghost" id="saveNotes">💾 Enregistrer</button></div>
          <label class="sr-only" for="notes">Bloc-notes</label>
          <textarea id="notes" rows="3" style="width:100%;margin-top:8px;background:#0e1322;color:#eef4ff;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px" aria-label="Bloc-notes"></textarea>
        </div>
      </section>

      <section id="tab-programs" role="region" aria-labelledby="tabProgramsBtn">
        <div class="card">
          <div class="row">
            <div>
              <div class="label">Plan actif</div>
              <div class="h1">Calisthenics – 30 jours (x3 cycles)</div>
            </div>
            <button class="btn" id="duplicate3m">Générer 3 mois</button>
          </div>
          <div class="label">Jours OFF inclus. Swipe ⟷ sur le calendrier pour marquer un jour.</div>
        </div>

        <div class="card">
          <div class="row" style="margin-bottom:6px"><div class="h2">Calendrier d'entraînement</div>
            <div class="badge" id="streakChip">🔥 Série: 0</div>
          </div>
          <div class="calendar" id="calendar" role="grid" aria-label="Calendrier"></div>
        </div>

        <div class="card">
          <div class="row"><div class="h2">Importer / Exporter</div>
            <div class="row" style="gap:8px">
              <button class="btn" id="exportData">Exporter JSON</button>
              <label class="btn" for="importFile">Importer JSON</label>
              <input id="importFile" type="file" accept="application/json" style="display:none" />
            </div>
          </div>
        </div>

        <div class="card">
          <div class="row" style="margin-bottom:8px"><div class="h2">Jours & exercices</div>
            <div class="badge" id="daysCount">30 jours</div></div>
          <div id="daysList" class="grid" style="grid-template-columns:repeat(1,1fr)"></div>
        </div>

        <div class="card" id="freeModeCard">
          <div class="row" style="margin-bottom:8px"><div class="h2">Mode Libre – Crée ta séance</div>
            <button class="btn" id="freeAddExo">+ Ajouter exo</button>
          </div>
          <div id="freeList" class="grid"></div>
          <div class="row" style="margin-top:8px">
            <button class="btn primary" id="freeStart">▶ Démarrer séance libre</button>
            <button class="btn ghost" id="freeClear">Effacer</button>
          </div>
        </div>

        <div class="card" id="skillsCard">
          <div class="h2">Skills Tracker</div>
          <div class="label">Suis tes progrès sur les figures (0–10).</div>
          <div id="skillsList" class="grid"></div>
        </div>

        <div class="card" id="competitionCard">
          <div class="h2">Mode Compétition</div>
          <div class="label">Partage un code avec un ami et comparez vos stats (sans serveur).</div>
          <div class="row" style="margin-top:8px">
            <button class="btn" id="shareCode">Générer code</button>
            <button class="btn" id="importCode">Importer code</button>
          </div>
          <textarea id="codeArea" rows="2" style="width:100%;margin-top:8px;background:#0e1322;color:#eef4ff;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px" placeholder="Colle ici le code reçu"></textarea>
        </div>
      </section>

      <section id="tab-timer" role="region" aria-labelledby="tabTimerBtn">
        <div class="card">
          <div class="h2">Intervalles (Tabata / EMOM)</div>
          <div class="grid two" style="margin-top:8px">
            <div>
              <div class="label">Travail (s)</div>
              <input id="intWork" type="number" min="5" value="20" style="width:100%;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.1);background:#0e1322;color:#fff" />
            </div>
            <div>
              <div class="label">Repos (s)</div>
              <input id="intRest" type="number" min="5" value="10" style="width:100%;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.1);background:#0e1322;color:#fff" />
            </div>
          </div>
          <div class="grid two" style="margin-top:8px">
            <div>
              <div class="label">Cycles</div>
              <input id="intRounds" type="number" min="1" value="8" style="width:100%;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.1);background:#0e1322;color:#fff" />
            </div>
            <div>
              <div class="label">Préparation (s)</div>
              <input id="intPrep" type="number" min="0" value="5" style="width:100%;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.1);background:#0e1322;color:#fff" />
            </div>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn primary" id="intStart">▶ Démarrer</button>
            <button class="btn ghost" id="intStop">Stop</button>
            <div class="badge" id="intPhase">Prêt</div>
          </div>
          <div class="timer">
            <div class="time" id="intDisplay">00:00</div>
            <div class="label" id="intRoundInfo">Cycle 0/8</div>
          </div>
        </div>

        <div class="card" id="exerciseGuide">
          <div class="row" style="margin-bottom:8px"><div class="h2">Guide des exercices</div>
            <input id="exGuideSearch" type="search" placeholder="Rechercher un exercice..." aria-label="Recherche d'exercice" style="flex:1;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.1);background:#0e1322;color:#fff" />
          </div>
          <div id="exGuideList" class="grid"></div>
        </div>

        <div class="card">
          <div class="row"><div class="h2">Historique des séances</div>
            <div class="row" style="gap:8px">
              <button class="btn" id="exportPDF">Exporter PDF</button>
              <button class="btn" id="clearHistory">Effacer l'historique</button>
            </div>
          </div>
          <div id="historyList" class="grid"></div>
        </div>
      </section>

      <section id="tab-stats" role="region" aria-labelledby="tabStatsBtn">
        <div class="card" id="xpCard">
          <div class="row"><div class="h2">Badges</div>
            <div id="xpChip" class="chip">⭐ XP: <span id="xpPoints">0</span></div>
          </div>
          <div class="label">Gagne des points à chaque séance finie. Débloque des badges en progressant.</div>
          <div id="badgesList" class="grid three" style="margin-top:8px"></div>
        </div>

        <div class="card">
          <div class="row"><div class="h2">Volume & PR</div><div class="badge" id="totalSessions">0 séances</div></div>
          <div class="grid three" style="margin-top:8px">
            <div class="card">
              <div class="label">Reps totales</div>
              <div class="h1" id="totalReps">0</div>
            </div>
            <div class="card">
              <div class="label">Temps d'entraînement</div>
              <div class="h1" id="totalTime">0:00:00</div>
            </div>
            <div class="card">
              <div class="label">Meilleur streak</div>
              <div class="h1" id="bestStreak">0</div>
            </div>
          </div>
        </div>
      </section>

      <section id="tab-settings" role="region" aria-labelledby="tabSettingsBtn">
        <div class="card">
          <div class="h2">Apparence</div>
          <div class="label">Thème</div>
          <div class="row" style="gap:8px;flex-wrap:wrap;margin-top:8px">
            <button class="btn" data-theme-choice="auto">Auto</button>
            <button class="btn" data-theme-choice="light">Clair</button>
            <button class="btn" data-theme-choice="dark">Sombre</button>
          </div>
          <div class="label">“Auto” suit le thème du téléphone. Tu peux forcer Clair ou Sombre ici.</div>
        </div>

        <div class="card">
          <div class="h2">Niveau de difficulté</div>
          <div class="row" style="gap:8px;flex-wrap:wrap;margin-top:8px">
            <button class="btn" data-diff="easy">Facile</button>
            <button class="btn primary" data-diff="medium">Moyen</button>
            <button class="btn" data-diff="hard">Difficile</button>
          </div>
          <div class="label" id="diffHint">Choisis l’intensité qui ajuste automatiquement les cibles.</div>
        </div>

        <div class="card">
          <div class="h2">Accessibilité</div>
          <div class="grid two" style="margin-top:8px">
            <label class="row"><span>Contraste renforcé</span><input id="a11yContrast" type="checkbox" /></label>
            <label class="row"><span>Taille de texte +</span><input id="a11yTextLg" type="checkbox" /></label>
          </div>
        </div>
        <div class="card">
          <div class="h2">Préférences</div>
          <div class="grid two" style="margin-top:8px">
            <label class="row"><span>Signal sonore</span><input id="beepToggle" type="checkbox" checked /></label>
            <label class="row"><span>Vibration (iPhone)</span><input id="hapticsToggle" type="checkbox" checked /></label>
          </div>
        </div>
        <div class="card">
          <div class="row"><div class="h2">Données</div>
            <div class="row" style="gap:8px">
              <button class="btn" id="resetData">Réinitialiser</button>
              <button class="btn" id="markRestDay">Marquer jour OFF</button>
            </div>
          </div>
          <div class="label">Astuce iPhone : Safari → Partager → « Ajouter à l’écran d’accueil ».</div>
        </div>
      </section>
    </main>

    <nav class="tabs" role="tablist" aria-label="Navigation principale">
      <button class="tab active" id="tabTodayBtn" role="tab" aria-controls="tab-today" aria-selected="true"><span class="ico">🏠</span>Aujourd’hui</button>
      <button class="tab" id="tabProgramsBtn" role="tab" aria-controls="tab-programs" aria-selected="false"><span class="ico">📅</span>Programmes</button>
      <button class="tab" id="tabTimerBtn" role="tab" aria-controls="tab-timer" aria-selected="false"><span class="ico">⏱️</span>Chronos</button>
      <button class="tab" id="tabStatsBtn" role="tab" aria-controls="tab-stats" aria-selected="false"><span class="ico">📊</span>Stats</button>
      <button class="tab" id="tabSettingsBtn" role="tab" aria-controls="tab-settings" aria-selected="false"><span class="ico">⚙️</span>Réglages</button>
    </nav>
  </div>

  <audio id="beep" preload="auto"><source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAAAAA/////wAA" type="audio/wav"></audio>
  <audio id="restBell" preload="auto"><source src="assets/placeholder.mp3" type="audio/wav"></audio>

  <script>
  // ===== iOS 100vh fix
  function setVH(){ document.documentElement.style.setProperty('--vh', (window.innerHeight*0.01)+'px'); }
  setVH(); window.addEventListener('resize', setVH); window.addEventListener('orientationchange', setVH);
  const $ = s=>document.querySelector(s); const $$ = s=>Array.from(document.querySelectorAll(s));

  // PWA: register service worker (optionnel si manifest présent)
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => navigator.serviceWorker.register('./service-worker.js').catch(()=>{}));
  }

  // IndexedDB wrapper
  const DB = (()=>{ const name='calisfit_db', store='state'; let db; function open(){return new Promise((res,rej)=>{const r=indexedDB.open(name,1); r.onupgradeneeded=()=>r.result.createObjectStore(store); r.onsuccess=()=>{db=r.result;res()}; r.onerror=()=>rej(r.error)});} async function get(k){ if(!db) await open(); return new Promise((res,rej)=>{const tx=db.transaction(store,'readonly'); const os=tx.objectStore(store); const rq=os.get(k); rq.onsuccess=()=>res(rq.result); rq.onerror=()=>rej(rq.error);});} async function set(k,v){ if(!db) await open(); return new Promise((res,rej)=>{const tx=db.transaction(store,'readwrite'); const os=tx.objectStore(store); const rq=os.put(v,k); rq.onsuccess=()=>res(true); rq.onerror=()=>rej(rq.error);});} return {get,set}; })();

  const storeLS={ load(){try{return JSON.parse(localStorage.getItem('calisfit'))||{}}catch{return {}}}, save(x){localStorage.setItem('calisfit',JSON.stringify(x)); DB.set('state',x).catch(()=>{});} };

  const state = Object.assign({
    currentDay:1,currentRound:1,notes:'',completed:{},repsLog:{},
    totals:{reps:0,time:0,sessions:0,streak:0,bestStreak:0},
    settings:{beep:true,haptics:true,contrast:false,textLg:false},
    calendar:{},history:[],free:[],skills:{'Muscle-up':0,'Handstand':0,'Front Lever':0,'Back Lever':0,'Planche':0,'Pistol Squat':0}
  }, storeLS.load());
  DB.get('state').then(s=>{ if(s && JSON.stringify(s).length>JSON.stringify(state).length){ Object.assign(state,s); init(); } });

  function persist(){ storeLS.save(state); }
  function haptics(){ if(!state.settings?.haptics) return; if(navigator.vibrate) navigator.vibrate(10); }
  function beep(){ if(!state.settings?.beep) return; const a=$('#beep'); try{ a.currentTime=0; a.play(); }catch{} }
  function fmtTime(sec){ sec=Math.max(0,Math.floor(sec)); const h=Math.floor(sec/3600),m=Math.floor((sec%3600)/60),s=sec%60; return `${h?h+':':''}${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}` }

  // Exercise DB (translations + cues)
  const EX_DB={
    'Push-ups':{fr:'Pompes',setup:'Mains sous les épaules, corps gainé.',cues:'Coudes ~45°, souffle en poussant.',errors:'Bassin qui tombe.'},
    'Diamond Push-ups':{fr:'Pompes diamant',setup:'Mains en losange sous poitrine.',cues:'Coudes près du corps.',errors:'Dos creusé.'},
    'Archer Push-up':{fr:'Pompes archer',setup:'Large, un bras fléchit, l’autre tendu.',cues:'Épaule basse.',errors:'Effondrement épaule.'},
    'Pike Push-up':{fr:'Pompes pike',setup:'V inversé, mains largeur épaules.',cues:'Sommet du crâne vers le sol.',errors:'Dos rond.'},
    'Decline Push-up':{fr:'Pompes déclinées',setup:'Pieds surélevés.',cues:'Corps aligné.',errors:'Bassin qui tombe.'},
    'Triangle Push-up':{fr:'Pompes serrées',setup:'Mains proches du buste.',cues:'Coudes serrés.',errors:'Évasement coudes.'},
    'Inverted Row':{fr:'Rowing inversé',setup:'Sous barre/table.',cues:'Poitrine à la barre.',errors:'Hanches qui tombent.'},
    'Elevated Inverted Rows':{fr:'Rowing inversé surélevé',setup:'Pieds surélevés.',cues:'Trajectoire poitrine‑barre.',errors:'À‑coups.'},
    'Pull-ups':{fr:'Tractions pronation',setup:'Prise plus large que épaules.',cues:'Épaules basses.',errors:'Balancement.'},
    'Chin-ups':{fr:'Tractions supination',setup:'Paumes vers toi.',cues:'Coudes vers côtes.',errors:'Cou tendu.'},
    'L Pull-ups':{fr:'Tractions en L',setup:'Jambes à 90°.',cues:'Gaine fort.',errors:'Perte d’angle.'},
    'Bar Dips':{fr:'Dips barres parallèles',setup:'Bras tendus.',cues:'Épaules sous coudes.',errors:'Épaules qui s’affalent.'},
    'Chair Dips':{fr:'Dips sur chaise',setup:'Mains sur banc.',cues:'Cage ouverte.',errors:'Épaules enroulées.'},
    'Squats':{fr:'Squats',setup:'Pieds largeur épaules.',cues:'Genoux suivent orteils.',errors:'Genoux rentrent.'},
    'Sissy Squats':{fr:'Squats sissy',setup:'Corps incliné.',cues:'Contrôle.',errors:'Genoux comprimés.'},
    'Bulgarian Split Squat':{fr:'Fentes bulgares',setup:'Pied arrière surélevé.',cues:'Tronc droit.',errors:'Genou rentre.'},
    'Reverse Lunge':{fr:'Fentes arrière',setup:'Grand pas arrière.',cues:'Genou au‑dessus du pied.',errors:'Buste s’écroule.'},
    'Back & Forth Lunges':{fr:'Fentes avant/arrière',setup:'Alterne avant/arr.',cues:'Stabilité.',errors:'Perte équilibre.'},
    'Curtsy Lunges':{fr:'Fentes croisées',setup:'Pied arrière croisé.',cues:'Hanches face.',errors:'Genou vrille.'},
    'Lateral Lunges':{fr:'Fentes latérales',setup:'Grand pas côté.',cues:'Hanche recule.',errors:'Genou dépasse.'},
    'Skater Squat':{fr:'Squat patineur',setup:'Une jambe.',cues:'Contrôle.',errors:'Bassin chute.'},
    'Pistol Squat':{fr:'Pistol squat',setup:'Une jambe tendue.',cues:'Gaine, contrôle.',errors:'Talons se décollent.'},
    'One-leg RDL':{fr:'Soulevé de terre une jambe',setup:'Charnière hanche.',cues:'Dos long.',errors:'Dos rond.'},
    'SL Elevated Bridge':{fr:'Pont surélevé une jambe',setup:'Pied surélevé.',cues:'Hanche haute.',errors:'Amplitude courte.'},
    'Glute Kickback':{fr:'Extension hanche quadrupédie',setup:'À quatre pattes.',cues:'Talons vers plafond.',errors:'Cambrure.'},
    'Superman Pull':{fr:'Tirage superman',setup:'Allongé ventral.',cues:'Coudes vers hanches.',errors:'Cou en extension.'},
    'Floor IYT':{fr:'Élévations I‑Y‑T au sol',setup:'Allongé ventral.',cues:'Omoplates serrées.',errors:'Haussement épaules.'},
    'Bird Dog':{fr:'Bird dog',setup:'Quadrupédie.',cues:'Bassin stable.',errors:'Oscillation.'},
    'Bird Dog Plank':{fr:'Planche bird dog',setup:'Plank + levers.',cues:'Gaine, respire.',errors:'Bassin bouge.'},
    'Plank':{fr:'Planche',setup:'Coudes sous épaules.',cues:'Nombril rentré.',errors:'Bassin haut/bas.'},
    'Side Plank':{fr:'Planche latérale',setup:'Épaule sur coude.',cues:'Hanche haute.',errors:'Épaule écrasée.'},
    'Side Plank Reach':{fr:'Planche latérale rotation',setup:'Ajoute rotation.',cues:'Contrôle.',errors:'Chute hanche.'},
    'L-Sit':{fr:'L‑Sit',setup:'Appui mains.',cues:'Épaules basses.',errors:'Dos arrondi.'},
    'Hollow Hold':{fr:'Gainage hollow',setup:'Dos plaqué.',cues:'Côtes rentrées.',errors:'Dos décolle.'},
    'Hollow Crunch':{fr:'Crunch hollow',setup:'Dynamique.',cues:'Bas du dos plaqué.',errors:'Tirer la nuque.'},
    'V-ups':{fr:'V‑ups',setup:'Mains/pieds se rejoignent.',cues:'Explosif.',errors:'Dos claque.'},
    'Leg Raises':{fr:'Relevés de jambes',setup:'Allongé/suspendu.',cues:'Dos plaqué.',errors:'Balançoire.'},
    'Hanging Knee Raises':{fr:'Relevés de genoux pendu',setup:'Suspendu.',cues:'Contrôle.',errors:'Balançoire.'},
    'Hanging Leg Raises':{fr:'Relevés de jambes pendu',setup:'Suspendu.',cues:'Rétroversion.',errors:'Dos creusé.'},
    'Hanging Wipers':{fr:'Essuie‑glaces pendu',setup:'Jambes hautes.',cues:'Tourne en bloc.',errors:'Élan.'},
    'Windshield Wipers':{fr:'Essuie‑glaces au sol',setup:'Allongé.',cues:'Épaules collées.',errors:'Arrachage épaules.'},
    'Mountain Climber':{fr:'Mountain climber',setup:'Planche.',cues:'Rythme constant.',errors:'Bassin saute.'},
    'Toes to Bar':{fr:'Orteils à la barre',setup:'Suspendu.',cues:'Creux/bosse.',errors:'Élan anarchique.'},
    'Handstand Push-ups':{fr:'Pompes en équilibre (HSPU)',setup:'Mur ok.',cues:'Gainage.',errors:'Cambrure.'},
    'Wall HSPU':{fr:'Pompes en équilibre au mur',setup:'Pieds au mur.',cues:'Amplitude contrôlée.',errors:'Cervicales.'},
    'Muscle-up (prog)':{fr:'Muscle‑up (progression)',setup:'Tirage explosif.',cues:'Transition rapide.',errors:'Coudes derrière.'},
    'Front Lever (tuck)':{fr:'Front lever (tuck)',setup:'Épaules basses.',cues:'Rétroversion bassin.',errors:'Épaules montées.'},
    'Planche Push-up (prog)':{fr:'Pompes planche (progression)',setup:'Épaules devant poignets.',cues:'Protraction.',errors:'Coudes évasés.'},
    'Shuttle Runs':{fr:'Allers‑retours sprint',setup:'Marques au sol.',cues:'Demi‑tour bas.',errors:'Talons lourds.'},
    'Step-up':{fr:'Montées sur banc',setup:'Pied entier sur appui.',cues:'Pousse le talon.',errors:'Genou rentre.'},
    'Calf Raises':{fr:'Extensions mollets',setup:'Appui avant‑pied.',cues:'Pause en haut.',errors:'Amplitude courte.'},
    'In & Out Jump':{fr:'Sauts écart‑ramener',setup:'Pieds joints → écartés.',cues:'Atterrissage doux.',errors:'Talons durs.'}
  };

  const EX_GIF = {
  "Push-ups": "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExN2xsa2F2b25pcHFicTEza3Q5OXdhbXpsYzl2c3VhcHFjbHA2bHVqaiZlcD12MV9naWZzX3NlYXJjaCZjdD1n/mGWBjz74fn404BWUl4/giphy.gif",
  "Diamond Push-ups": "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExcndjbTBleDdtY2hwdm1oYzZvczRkaTUwOG9rdW1jd280Y3RrdDl1eCZlcD12MV9naWZzX3NlYXJjaCZjdD1n/4XGl3yPyvnWCFfTaYV/giphy.gif",
  "Archer Push-up": "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExbjYzcTJ0bTlpcTNwN2UyZWJjZjRwNzI2aWVjczI2eHN5bnhpM25pNiZlcD12MV9naWZzX3NlYXJjaCZjdD1n/ii1Y4iopQaNEPGlrk6/giphy.gif",
  "Pike Push-up": "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExeGludm5hZmRiNmVwd25xbmJzbWU4dWVrY2hha2N5bnluajAxbm05YyZlcD12MV9naWZzX3NlYXJjaCZjdD1n/6wLz7povE9WOMzcMU4/giphy.gif",
  "Decline Push-up": "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExdWw3bHlwdG1zMXBmZmt0eTgwZTR1czB2eWdjMzh4NGhiNGZobjdyNCZlcD12MV9naWZzX3NlYXJjaCZjdD1n/YQmmcPHmFgHekp7ktU/giphy.gif",
  "Triangle Push-up": "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExcndjbTBleDdtY2hwdm1oYzZvczRkaTUwOG9rdW1jd280Y3RrdDl1eCZlcD12MV9naWZzX3NlYXJjaCZjdD1n/4XGl3yPyvnWCFfTaYV/giphy.gif",
  "Wide Arm Push-up": "https://media2.giphy.com/media/v1.Y2lkPTc5MGI3NjExYXJwZzdjbXMwcjE4dXNua2Z6N3prb2RqYnptaG9yanN0ZTBpZzB3ayZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/RMMvrGrOzqyC4BaDFU/giphy.gif",
  "Planche Push-up (prog)": "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExaG9kaTRsaXBsa2RsaGR2ZzV3Z2RxeWRwNnlvNXpkdjB6ejluN2htdyZlcD12MV9naWZzX3NlYXJjaCZjdD1n/6jcVLg78GqUO199J9p/giphy.gif",
  "Handstand Push-ups": "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExZGtwbDNzbHR6aXByZThoOWd0YnY3a2FiYms0a25xbTc4ZGdvcHV4eCZlcD12MV9naWZzX3NlYXJjaCZjdD1n/srRZG7db7u7hBc8m9w/giphy.gif",
  "Wall HSPU": "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExZGtwbDNzbHR6aXByZThoOWd0YnY3a2FiYms0a25xbTc4ZGdvcHV4eCZlcD12MV9naWZzX3NlYXJjaCZjdD1n/srRZG7db7u7hBc8m9w/giphy.gif",
  "Dive Bomber Push-ups": "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExbHVlbjU1bHBmb3g0NmY5N3B4NWxlZnh2amkwMXdmZ2Zzd3FrbTJ0cCZlcD12MV9naWZzX3NlYXJjaCZjdD1n/m9psC0oUeLFnzgZb0J/giphy.gif",
  "Inverted Row": "https://boxlifemagazine.com/wp-content/uploads//2023/06/traction-australienne-rowing-poids-du-corps.gif",
  "Elevated Inverted Rows": "https://gymvisual.com/img/p/9/7/9/4/9794.gif",
  "Pull-ups": "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExMzNzbTFueTdkNzd1NWJ2NW5sdGt4anVpbm5sYjdiOWNsNmh4MHM4MiZlcD12MV9naWZzX3NlYXJjaCZjdD1n/ejhGXBubaEVqKBv92g/giphy.gif",
  "Chin-ups": "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExb3V5ZndtMHVwczZtNWliNXJzeXl4d3RiaDdyNHZzY3Jkdm4xN2VkeCZlcD12MV9naWZzX3NlYXJjaCZjdD1n/FIRtALeBsjEQFj413X/giphy.gif",
  "L Pull-ups": "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExODdndnRiMjh3NHltcDloNGFleG92bmU1bzR4bXN6bXViOW40Y3N0MCZlcD12MV9naWZzX3NlYXJjaCZjdD1n/0jX7EGwOtNBVvpuFtp/giphy.gif",
  "Muscle-up (prog)": "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExc2s4cHRzenV0YXU3aGdudGJ5dnBpbDd5NGlubWQwbm9qaHV4bXh1NSZlcD12MV9naWZzX3NlYXJjaCZjdD1n/z1q3XUwCaSNTe6TG5S/giphy.gif",
  "Bar Dips": "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExYWRhd2owdWlvdmdsN3RyNDVhOWJxd285N2MxOWU4b3g0dTdlbHZ5dCZlcD12MV9naWZzX3NlYXJjaCZjdD1n/bOv635wGcyx2BMdClg/giphy.gif",
  "Chair Dips": "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExYXg4dTgybmg2Y2R1b3h4YXF5czdzYW50d2dmbG1iZGU3OGd3NnN0diZlcD12MV9naWZzX3NlYXJjaCZjdD1n/ojAEX7tsnRTsg6EY1O/giphy.gif",
  "Squats": "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExNnlhanZ2Ympod2M1a3pibjlieHFybHJmc3Vka3g2NzdjYXp0anFqcCZlcD12MV9naWZzX3NlYXJjaCZjdD1n/26BROTgFzjf22acJq/giphy.gif",
  "Sissy Squats": "https://gymvisual.com/img/p/6/7/1/6/6716.gif",
  "Bulgarian Split Squat": "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExOXFxcmp5cmpycXdzbjFja3RpMzdkY3B5Y241NnE3OHgzYnN5cWlvMSZlcD12MV9naWZzX3NlYXJjaCZjdD1n/LHvD0ogJrdWhtXtdtF/giphy.gif",
  "Reverse Lunge": "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExOWJmcnMya2ZleXExMGVrdWd3MnZuaTQxbnlodzA3MWNhaWxzdHhxciZlcD12MV9naWZzX3NlYXJjaCZjdD1n/r0WOepedKqxNjS3zM0/giphy.gif",
  "Back & Forth Lunges": "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExOWJmcnMya2ZleXExMGVrdWd3MnZuaTQxbnlodzA3MWNhaWxzdHhxciZlcD12MV9naWZzX3NlYXJjaCZjdD1n/r0WOepedKqxNjS3zM0/giphy.gif",
  "Curtsy Lunges": "https://www.kettlebellkings.com/cdn/shop/articles/curtsy-lunge_1200x1200_crop_center.gif?v=1703665328",
  "Lateral Lunges": "https://media0.giphy.com/media/v1.Y2lkPTc5MGI3NjExaXgzN2xjeDVsdG13c2EydDN2NzVmNDAzcDg1ZDZuZHd5d2VuenMxNCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/4Tgw5Lf0RuMmYdwC5G/giphy.gif",
  "Skater Squat": "https://fitnessprogramer.com/wp-content/uploads/2022/07/Skater-Squat.gif",
  "Pistol Squat": "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExZ3JwM3o3MW13bXo0ejFzaW1rZnNqYWRidDB1ZThlYTVsZjNldWhicCZlcD12MV9naWZzX3NlYXJjaCZjdD1n/LNMRALG2RW3sxqoEqZ/giphy.gif",
  "One-leg RDL": "https://gymvisual.com/img/p/2/0/3/6/9/20369.gif",
  "SL Elevated Bridge": "https://fitnessprogramer.com/wp-content/uploads/2021/06/Single-Leg-Bridge.gif",
  "Glute Kickback": "https://i.pinimg.com/originals/8d/e1/04/8de1048f43f279b9c0227edcc6636207.gif",
  "Superman Pull": "https://hips.hearstapps.com/hmg-prod/images/workouts/2016/08/supermanpullup-1472153970.gif?resize=640:*",
  "Floor IYT": "https://copilot-exercise-media.s3.us-east-2.amazonaws.com/1280_jpegs/bodyweight_floor_iyt.jpeg",
  "Bird Dog": "https://media.tenor.com/6nO5406JCHIAAAAM/bird-dog.gif",
  "Bird Dog Plank": "https://spotebi.com/wp-content/uploads/2016/02/plank-bird-dog-exercise-illustration-spotebi.gif",
  "Plank": "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExYjNlaG9ibnNiMWx4Zmt5ZHBtZHVjdnplMmYzeGVqMGxxbGt4NWQwayZlcD12MV9naWZzX3NlYXJjaCZjdD1n/1etBJgfgDimAogaj6Z/giphy.gif",
  "Side Plank": "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExa3djcWFjMzNpbXl4bXNxMHJ3dWJvM3Y0emE2NWRqYXVud3B1bGRraSZlcD12MV9naWZzX3NlYXJjaCZjdD1n/7m70b4wcZOOstmKCE8/giphy.gif",
  "Side Plank Reach": "https://hips.hearstapps.com/hmg-prod/images/workouts/2016/08/planksideplankreachandrotate-1472131712.gif",
  "L-Sit": "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExYm11aWR3d2tjMWc4ZnMxOTZkMDIyZTZ4bGl4Y3F1MDJ2NTUwbGNsYyZlcD12MV9naWZzX3NlYXJjaCZjdD1n/prdXh8ZNQTQ4ynQCnl/giphy.gif",
  "Hollow Hold": "https://hips.hearstapps.com/hmg-prod/images/workouts/2016/03/lyinghollowbodyhold-1457044774.gif?crop=1xw:1xh;center,top&resize=1200:*",
  "Hollow Crunch": "https://hips.hearstapps.com/hmg-prod/images/workouts/2016/08/hollowbodyholdpump-1472220583.gif?crop=1xw:0.75xh;center,top&resize=1200:*",
  "V-ups": "https://i.pinimg.com/originals/2e/ee/34/2eee3479632b1a8b1144b4f7e1e57ead.gif",
  "Leg Raises": "https://cdn.jefit.com/assets/img/exercises/gifs/44.gif",
  "Hanging Knee Raises": "https://i.pinimg.com/originals/21/86/e7/2186e7a33fda75a9ff3f1f2a8eef435a.gif",
  "Hanging Leg Raises": "https://gymvisual.com/img/p/2/4/9/4/4/24944.gif",
  "Hanging Wipers": "https://www.strengthlog.com/wp-content/uploads/2024/11/hanging-windshield-wiper.gif",
  "Windshield Wipers": "https://www.strengthlog.com/wp-content/uploads/2021/01/Lying-Windshield-Wipers-1.gif",
  "Mountain Climber": "https://hips.hearstapps.com/hmg-prod/images/workouts/2016/08/mountainclimber-1472061303.gif?crop=1xw:1xh;center,top&resize=1200:*",
  "Toes to Bar": "https://gymvisual.com/img/p/1/8/4/4/1/18441.gif",
  "Burpees": "https://hips.hearstapps.com/hmg-prod/images/workouts/2016/03/burpee-1457045324.gif",
  "Shuttle Runs": "https://i.makeagif.com/media/4-02-2017/xZhi0r.gif",
  "Step-up": "https://i.pinimg.com/originals/c1/b9/1b/c1b91bbe66a35cbef4917e1974651c8b.gif",
  "Calf Raises": "https://i.pinimg.com/originals/71/58/dc/7158dc3b232bb7b0a9a07b17f87af49b.gif",
  "In & Out Jump": "https://media.tenor.com/67z7_qwcWTQAAAAM/jumps-legs-work-out.gif"
};
  for(const k in EX_GIF){ if(EX_DB[k]) EX_DB[k].gif = EX_GIF[k]; }

  const PLAN_30=[
    {day:1,title:'Full Body',rounds:3,items:[
      ['Push-ups','20'],['Squats','20'],['Pike Push-up','10'],['Inverted Row','20'],['Lateral Lunges','10/side'],['Chair Dips','10']
    ]},
    {day:2,title:'Upper/Lower + Core',rounds:3,items:[
      ['Dive Bomber Push-ups','15'],['Chin-ups','AMRAP'],['Reverse Lunge','10/side'],['Shoulder Tap','20'],['Reverse Crunches','20'],['Step-up','10/side']
    ]},
    {day:3,title:'Pull • Core • Legs',rounds:3,items:[
      ['Squats','20'],['Pull-ups','AMRAP'],['Diamond Push-ups','20'],['Windshield Wipers','10/side'],['Curtsy Lunges','10/side'],['Bird Dog','5/side']
    ]},
    {day:4,title:'OFF / Récup',rounds:0,items:[]},
    {day:5,title:'Mix explosif',rounds:3,items:[
      ['Squat Jump','10'],['Push-ups','20'],['Superman Pull','10'],['Chin-ups','AMRAP'],['Wall HSPU','10'],['Hollow Crunch','10']
    ]},
    {day:6,title:'Push/Pull + Core',rounds:3,items:[
      ['Inverted Row','10'],['Archer Push-up','10/side'],['Reverse Lunge','10/side'],['Bar Dips','10'],['Mountain Climber','20s'],['Hanging Knee Raises','10']
    ]},
    {day:7,title:'OFF / Récup',rounds:0,items:[]},
    {day:8,title:'Core & Stability',rounds:3,items:[
      ['Burpees','10'],['Floor IYT','10'],['Wide Arm Push-up','10'],['L-Sit','Hold'],['Step-up','10'],['Calf Raises','20'],['Plank','45-60s'],['Side Plank','20s/side']
    ]},
    {day:9,title:'Push/Pull Mix',rounds:3,items:[
      ['Inverted Row','10'],['Decline Push-up','10'],['Bulgarian Split Squat','5/side'],['Chin-ups','10'],['Bird Dog Plank','5/side'],['Bar Dips','10'],['Pike Push-up','10'],['Leg Raises','10']
    ]},
    {day:10,title:'Legs · Push · Core',rounds:3,items:[
      ['Squat Jump','10'],['Archer Push-up','10/side'],['Reverse Lunge','10/side'],['Single-Leg Tuck-up','10/side'],['Lateral Lunges','10/side'],['Mountain Climber','20s'],['Hanging Knee Raises','10'],['Diamond Push-ups','10']
    ]},
    {day:11,title:'OFF / Récup',rounds:0,items:[]},
    {day:12,title:'Skills & Legs',rounds:3,items:[
      ['Wall HSPU','10'],['Shuttle Runs','20s'],['Pseudo Planche','10'],['Pistol Squat','8-10/side'],['Burpees','10'],['Hanging Leg Raises','10'],['Mountain Climber','20s'],['One-leg RDL','8-10/side']
    ]},
    {day:13,title:'Hamstrings & Pull',rounds:3,items:[
      ['Back & Forth Lunges','10'],['Dead Bug','10'],['Nordic Curl','10'],['Bird Dog Plank','20'],['Pull-ups','6+'],['Dragon Flag','6-10'],['Shoulder Tap','15-20s'],['Plank','1:00']
    ]},
    {day:14,title:'OFF / Récup',rounds:0,items:[]},
    {day:15,title:'Plyo + Pull',rounds:4,items:[
      ['In & Out Jump','10'],['Clap Push-up','10'],['L Pull-ups','10'],['Bar Dips','10'],['Dragon Flag','6-8'],['Side Plank Reach','20s'],['Chin-ups','8-12'],['Archer Push-up','6-8/side']
    ]},
    {day:16,title:'Skills Focus',rounds:4,items:[
      ['Toes to Bar','10'],['Skater Squat','10/side'],['Muscle-up (prog)','10'],['Planche Push-up (prog)','10'],['Hollow Hold','15s'],['Single-Leg Hamstring Bridge','10/side'],['Triangle Push-up','10'],['Side Plank','15s/side']
    ]},
    {day:17,title:'Mixed Strength',rounds:4,items:[
      ['Back & Forth Lunges','10'],['Inverted Row','10'],['Pike Push-up','10'],['Squats','20'],['Dragon Flag','6-10'],['Shoulder Tap','15-20s'],['Mountain Climber','20s'],['Plank','1:00']
    ]},
    {day:18,title:'OFF / Récup',rounds:0,items:[]},
    {day:19,title:'Pull & Posterior',rounds:4,items:[
      ['Chin-ups','10'],['Archer Push-up','10/side'],['Front Lever (tuck)','AMRAP'],['One-leg RDL','5/side'],['Superman Pull','10'],['Curtsy Lunges','10'],['Toes to Bar','10'],['SL Elevated Bridge','10']
    ]},
    {day:20,title:'HSPU & Core',rounds:4,items:[
      ['Pike Push-up','10'],['Back & Forth Lunges','10/side'],['Handstand Push-ups','AMRAP'],['Inverted Row','10'],['V-ups','10'],['Bar Dips','10'],['Skater Squat','10'],['Single-Leg Tuck-up','10']
    ]},
    {day:21,title:'OFF / Récup',rounds:0,items:[]},
    {day:22,title:'Skills + Legs',rounds:4,items:[
      ['Toes to Bar','10'],['Sissy Squats','10'],['Muscle-up (prog)','AMRAP'],['Planche Push-up (prog)','10'],['Pistol Squat','10/side'],['Dragon Flag','AMRAP'],['Triangle Push-up','10'],['Plank','60s']
    ]},
    {day:23,title:'Plyo + Split Legs',rounds:4,items:[
      ['In & Out Jump','10'],['Clap Push-up','10'],['L Pull-ups','10'],['Bulgarian Split Squat','10/side'],['Hanging Knee Raises','10'],['Knee Outside Elbow','10/side'],['Elevated Inverted Rows','8-12'],['Glute Kickback','10/side']
    ]},
    {day:24,title:'Mixed + Core',rounds:4,items:[
      ['Squat Jump','10'],['Pull-ups','10'],['Pike Push-up','10'],['Sissy Squats','20'],['Dragon Flag','6-10'],['Shoulder Tap','20s'],['Mountain Climber','20s'],['Hanging Wipers','10/side']
    ]},
    {day:25,title:'OFF / Récup',rounds:0,items:[]},
    {day:26,title:'Push Skills',rounds:4,items:[
      ['Dive Bomber Push-ups','10'],['Muscle-up (prog)','10'],['Triangle Push-up','10'],['One-leg RDL','10/side'],['Hollow Crunch','10'],['Skater Squat','10/side'],['Toes to Bar','10'],['Bird Dog','10/side']
    ]},
    {day:27,title:'Front Lever + Pistols',rounds:4,items:[
      ['Back & Forth Lunges','10'],['Front Lever (tuck)','10'],['Bar Dips','10'],['Pistol Squat','20'],['Pull-ups','6+'],['Dragon Flag','6-10'],['Shoulder Tap','20s'],['Plank','1:00']
    ]},
    {day:28,title:'OFF / Récup',rounds:0,items:[]},
    {day:29,title:'Full Mix Advanced',rounds:4,items:[
      ['Burpees','10'],['Pull-ups','10'],['V-ups','10'],['Muscle-up (prog)','10'],['Sissy Squats','10'],['Handstand Push-ups','10'],['Hanging Knee Raises','15'],['Bird Dog','10/side']
    ]},
    {day:30,title:'Finale',rounds:4,items:[
      ['In & Out Jump','10'],['Clap Push-up','10'],['L Pull-ups','10'],['Bulgarian Split Squat','10/side'],['Knee to Elbow','10'],['Knee Inside Elbow','10/side'],['Inverted Row','8-12'],['SL Elevated Bridge','10/side']
    ]}
  ];

  const tabs=[['today','tabTodayBtn'],['programs','tabProgramsBtn'],['timer','tabTimerBtn'],['stats','tabStatsBtn'],['settings','tabSettingsBtn']];
  tabs.forEach(([id,btn])=>{ $('#'+btn).addEventListener('click',()=>activateTab(id,btn)); });
  function activateTab(id,btn){ $$('.tab').forEach(t=>t.classList.remove('active')); $('#'+btn).classList.add('active'); $$('section').forEach(s=>s.classList.remove('active')); $('#tab-'+id).classList.add('active'); }

  function getDayData(d){ return PLAN_30.find(x=>x.day===d) || PLAN_30[0]; }
  function tName(name){ return (EX_DB[name] && EX_DB[name].fr) ? EX_DB[name].fr : name; }

  function updateToday(){
    if(!state._booted){ state.currentDay = Math.min(30, Math.max(1, state.currentDay||1)); state._booted=true; }
    const d = getDayData(state.currentDay);
    $('#todayTitle').textContent = `Jour ${d.day} · ${d.title}`;
    $('#todayBadge').textContent = `Semaine ${Math.ceil(d.day/7)} • Jour ${d.day}`;
    const rounds = d.rounds || (d.day<=15?3:4);
    state.currentRound = Math.min(Math.max(1,state.currentRound||1), rounds);
    $('#roundChip').textContent = `Manche ${state.currentRound}/${rounds}`;

    const list=$('#workoutList'); list.innerHTML='';
    d.items.forEach(([name,target],idx)=>{
      const key = `${d.day}:${state.currentRound}:${idx}`; const reps = state.repsLog[key]||0; const done = !!state.completed[key];
      const el=document.createElement('div'); el.className='workout-item'+(done?' done':'');
      el.innerHTML=`<div><div class="h2">${tName(name)}</div><div class="label">Cible: ${target}</div></div>
      <div class="row" style="gap:8px">
        <span class="pill" aria-live="polite">${reps} reps</span>
        <div class="counter" role="group" aria-label="Compteur de répétitions">
          <button data-act="-" aria-label="Moins">−</button>
          <button data-act="+" aria-label="Plus">+</button>
        </div>
        <button class="btn" data-done>✔</button>
      </div>`;
      el.querySelectorAll('.counter button').forEach(b=>b.addEventListener('click',()=>{ let v=state.repsLog[key]||0; v += (b.dataset.act==='+')?1:-1; v=Math.max(0,v); state.repsLog[key]=v; haptics(); updateToday(); persist(); updateStats(); }));
      el.querySelector('[data-done]').addEventListener('click',()=>{ state.completed[key] = !done; if(state.completed[key]){ beep(); haptics(); } persist(); updateToday(); updateStats(); });
      list.appendChild(el);
    });
  }

  // Swipe gestures for round/day
  function bindSwipes(el, onLeft, onRight){ let x0=null,t0=0; el.addEventListener('touchstart',e=>{ x0=e.touches[0].clientX; t0=Date.now(); }); el.addEventListener('touchend',e=>{ if(x0==null) return; const dx=(e.changedTouches[0].clientX-x0); const dt=Date.now()-t0; if(dt<500 && Math.abs(dx)>40){ if(dx<0) onLeft&&onLeft(); else onRight&&onRight(); } x0=null; }); }
  bindSwipes($('#workoutListCard'),()=>$('#nextRound').click(),()=>$('#prevRound').click());
  $('#prevRound').addEventListener('click',()=>{ const d=getDayData(state.currentDay); const rounds=d.rounds||(d.day<=15?3:4); state.currentRound=Math.max(1,state.currentRound-1); updateToday(); persist(); });
  $('#nextRound').addEventListener('click',()=>{ const d=getDayData(state.currentDay); const rounds=d.rounds||(d.day<=15?3:4); state.currentRound=Math.min(rounds,state.currentRound+1); updateToday(); persist(); });

  // Rest timer
  let restSel=60, restTimer=null, restLeft=0; $$('#tab-today [data-rest]').forEach(b=>b.addEventListener('click',()=>{ restSel=+b.dataset.rest; $('#restDisplay').textContent=fmtTime(restSel); }));
  $('#restStart').addEventListener('click',()=>{ if(restTimer){clearInterval(restTimer)}; restLeft=restSel; $('#restDisplay').textContent=fmtTime(restLeft); restTimer=setInterval(()=>{ restLeft--; $('#restDisplay').textContent=fmtTime(restLeft); if(restLeft<=0){ clearInterval(restTimer); restTimer=null; beep(); haptics(); } },1000); });
  $('#restReset').addEventListener('click',()=>{ if(restTimer){clearInterval(restTimer)}; restTimer=null; restLeft=0; $('#restDisplay').textContent='00:00'; });

  // Stopwatch
  let swTimer=null, swStartAt=0; function renderSW(){ const t=swTimer?(Date.now()-swStartAt)/1000:0; const ms=Math.floor((t%1)*10); const s=Math.floor(t)%60; const m=Math.floor(t/60)%60; const h=Math.floor(t/3600); $('#swDisplay').textContent=`${h?String(h).padStart(2,'0')+':':''}${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}.${ms}`; }
  $('#swStart').addEventListener('click',()=>{ if(swTimer){ clearInterval(swTimer); swTimer=null; $('#swStart').textContent='Démarrer'; const delta=Math.floor((Date.now()-swStartAt)/1000); state.totals.time+=delta; persist(); updateStats(); } else { swStartAt=Date.now(); swTimer=setInterval(renderSW,100); $('#swStart').textContent='Pause'; }});
  $('#swReset').addEventListener('click',()=>{ if(swTimer){clearInterval(swTimer); swTimer=null;} $('#swDisplay').textContent='00:00.0'; $('#swStart').textContent='Démarrer'; $('#swLaps').textContent=''; });
  $('#swLap').addEventListener('click',()=>{ const t=$('#swDisplay').textContent; const n=document.createElement('span'); n.textContent=( $('#swLaps').textContent? ' · ' : '' )+t; $('#swLaps').appendChild(n); haptics(); });

  $('#startSessionBtn').addEventListener('click',()=>{ state.sessionStart=Date.now(); $('#swReset').click(); $('#swStart').click(); haptics(); addHistory('start'); });

  // Intervals
  let intTimer=null,intPhase='prep',intLeft=0,intRound=0; function intRender(){ $('#intDisplay').textContent=fmtTime(intLeft); $('#intPhase').textContent=intPhase.toUpperCase(); $('#intRoundInfo').textContent=`Cycle ${intRound}/${+$('#intRounds').value}`; }
  function intTick(){ intLeft--; intRender(); if(intLeft<=0){ beep(); haptics(); if(intPhase==='prep'){ intPhase='work'; intLeft=+$('#intWork').value; } else if(intPhase==='work'){ intPhase='rest'; intLeft=+$('#intRest').value; } else if(intPhase==='rest'){ intRound++; if(intRound>+$('#intRounds').value){ clearInterval(intTimer); intTimer=null; intPhase='fini'; $('#intPhase').textContent='Terminé'; addHistory('interval_done'); return; } intPhase='work'; intLeft=+$('#intWork').value; } intRender(); } }
  $('#intStart').addEventListener('click',()=>{ if(intTimer){clearInterval(intTimer);} intPhase='prep'; intLeft=+$('#intPrep').value; intRound=1; intRender(); intTimer=setInterval(intTick,1000); });
  $('#intStop').addEventListener('click',()=>{ if(intTimer){clearInterval(intTimer); intTimer=null;} intPhase='stop'; intRender(); });

  // Programs list + calendar
  function buildDaysList(){ const box=$('#daysList'); box.innerHTML=''; PLAN_30.forEach(d=>{ const card=document.createElement('div'); card.className='workout-item'; const rounds=d.rounds||(d.day<=15?3:4); card.innerHTML=`<div><div class="h2">Jour ${d.day} · ${d.title}</div><div class="label">${rounds} manches • ${d.items.length} exos</div></div><div class="row"><button class='btn' data-go='${d.day}'>Aller</button></div>`; card.querySelector('[data-go]').addEventListener('click',()=>{ state.currentDay=d.day; state.currentRound=1; updateToday(); persist(); activateTab('today','tabTodayBtn'); }); box.appendChild(card); }); $('#daysCount').textContent=`${PLAN_30.length} jours`; }

  function buildCalendar(){ const cal=$('#calendar'); cal.innerHTML=''; const dt=new Date(); const y=dt.getFullYear(), m=dt.getMonth(); const first=new Date(y,m,1); const start=(first.getDay()||7); const days=new Date(y,m+1,0).getDate(); for(let i=1;i<start;i++){ cal.appendChild(document.createElement('div')); } for(let d=1; d<=days; d++){ const el=document.createElement('div'); el.className='day'; el.textContent=d; const key=`d${y}-${m+1}-${d}`; if(state.calendar[key]==='done') el.classList.add('done'); if(state.calendar[key]==='off') el.classList.add('off'); el.addEventListener('click',()=>{ state.calendar[key] = state.calendar[key]==='done' ? 'off' : state.calendar[key]==='off' ? undefined : 'done'; if(state.calendar[key]==='done'){ state.totals.sessions++; state.totals.streak++; state.totals.bestStreak=Math.max(state.totals.bestStreak,state.totals.streak); } else if(state.calendar[key]==='off'){ state.totals.streak=0; } persist(); buildCalendar(); updateStats(); }); cal.appendChild(el); } }

  // Free mode
  function renderFree(){ const box=$('#freeList'); box.innerHTML=''; (state.free||[]).forEach((x,i)=>{ const item=document.createElement('div'); item.className='workout-item'; item.innerHTML=`<div><div class='h2'>${x.name||'Exercice'}</div><div class='label'>Cible: ${x.target||'-'}</div></div><div class='row'><button class='btn' data-edit='${i}'>✎</button><button class='btn' data-del='${i}'>🗑️</button></div>`; item.querySelector('[data-del]').addEventListener('click',()=>{ state.free.splice(i,1); persist(); renderFree(); }); item.querySelector('[data-edit]').addEventListener('click',()=>{ const name=prompt('Nom',x.name||''); const target=prompt('Cible',x.target||''); if(name!==null){ state.free[i]={name,target}; persist(); renderFree(); } }); box.appendChild(item); }); }
  $('#freeAddExo').addEventListener('click',()=>{ const name=prompt('Nom de l\'exercice'); if(!name) return; const target=prompt('Cible (reps/temps)')||''; state.free=state.free||[]; state.free.push({name,target}); persist(); renderFree(); });
  $('#freeClear').addEventListener('click',()=>{ if(confirm('Effacer la séance libre ?')){ state.free=[]; persist(); renderFree(); }});
  $('#freeStart').addEventListener('click',()=>{ if(!state.free||!state.free.length){ alert('Ajoute au moins un exercice.'); return; } state.currentDay=0; state.currentRound=1; updateTodayFree(); activateTab('today','tabTodayBtn'); });
  function updateTodayFree(){ const list=$('#workoutList'); list.innerHTML=''; $('#todayTitle').textContent='Séance Libre'; $('#todayBadge').textContent='Libre'; $('#roundChip').textContent='Manche 1/1'; (state.free||[]).forEach((x,idx)=>{ const key=`F:${idx}`; const reps=state.repsLog[key]||0; const el=document.createElement('div'); el.className='workout-item'; el.innerHTML=`<div><div class='h2'>${x.name}</div><div class='label'>Cible: ${x.target||'-'}</div></div><div class='row'><span class='pill'>${reps} reps</span><div class='counter'><button data-k='${key}' data-a='-'>−</button><button data-k='${key}' data-a='+'>+</button></div></div>`; el.querySelectorAll('button[data-k]').forEach(b=>b.addEventListener('click',()=>{ const k=b.dataset.k; let v=state.repsLog[k]||0; v+=(b.dataset.a==='+')?1:-1; state.repsLog[k]=Math.max(0,v); persist(); updateTodayFree(); })); list.appendChild(el); }); }

  // Skills
  function renderSkills(){ const box=$('#skillsList'); box.innerHTML=''; Object.keys(state.skills).forEach(k=>{ const v=state.skills[k]; const row=document.createElement('div'); row.className='workout-item'; row.innerHTML=`<div><div class='h2'>${k}</div><div class='label'>Niveau: <strong>${v}</strong>/10</div></div><input type='range' min='0' max='10' value='${v}' style='width:160px' aria-label='Niveau ${k}'>`; const slider=row.querySelector('input'); slider.addEventListener('input',()=>{ state.skills[k]=+slider.value; persist(); renderSkills(); }); box.appendChild(row); }); }

  // History + export PDF
  function addHistory(kind){ const d=new Date(); state.history.unshift({ kind, at:d.toISOString(), day:state.currentDay, round:state.currentRound }); state.history = state.history.slice(0,200); persist(); renderHistory(); }
  function renderHistory(){ const box=$('#historyList'); box.innerHTML=''; (state.history||[]).forEach(h=>{ const div=document.createElement('div'); div.className='workout-item'; const when=new Date(h.at).toLocaleString(); div.innerHTML=`<div><div class='h2'>${h.kind==='start'?'Séance lancée':'Intervals'}</div><div class='label'>${when} · ${h.day?('Jour '+h.day):'Libre'}</div></div>`; box.appendChild(div); }); }
  $('#exportPDF').addEventListener('click',()=>{ window.print(); });
  $('#clearHistory').addEventListener('click',()=>{ if(confirm('Effacer tout l\'historique ?')){ state.history=[]; persist(); renderHistory(); }});

  // Import / Export JSON
  $('#exportData').addEventListener('click',()=>{ const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=Object.assign(document.createElement('a'),{href:url,download:'calisfit-data.json'}); a.click(); URL.revokeObjectURL(url); });
  $('#importFile').addEventListener('change',e=>{ const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const data=JSON.parse(r.result); Object.assign(state,data); persist(); init(); }catch{ alert('Fichier invalide'); } }; r.readAsText(f); });

  // Competition (code de partage simple)
  $('#shareCode').addEventListener('click',()=>{ const payload={ totals:state.totals, calendar:state.calendar, skills:state.skills }; const code=btoa(unescape(encodeURIComponent(JSON.stringify(payload)))); $('#codeArea').value=code; navigator.clipboard?.writeText(code).catch(()=>{}); alert('Code copié.'); });
  $('#importCode').addEventListener('click',()=>{ const code=$('#codeArea').value.trim(); if(!code) return alert('Colle un code.'); try{ const obj=JSON.parse(decodeURIComponent(escape(atob(code)))); const my=state.totals.reps; const other=obj.totals?.reps||0; alert(`Comparaison (reps totales): Toi ${my} vs Ami ${other}`); }catch{ alert('Code invalide'); } });

  // Exercise Guide

  function renderExerciseGuide(){
    const list=$('#exGuideList'); if(!list) return;
    const q=($('#exGuideSearch')?.value||'').toLowerCase();
    list.innerHTML='';
    const keys=Object.keys(EX_DB).sort((a,b)=>tName(a).localeCompare(tName(b),'fr'));
    keys.forEach(k=>{
      const fr=tName(k); if(q && !fr.toLowerCase().includes(q)) return;
      const ex=EX_DB[k];
      const details=document.createElement('details'); details.className='workout-item';
      const summary=document.createElement('summary');
      const imgHTML = ex.gif ? `<img src="${ex.gif}" class="exercise-gif" alt="${fr}">` : '';
      summary.innerHTML = `${imgHTML}<div class='h2'>${fr}</div><div class='label'>${ex.setup||''}</div>`;
      const body=document.createElement('div'); body.className='label'; body.style.marginTop='8px';
      const big = ex.gif ? `<div style="margin-bottom:8px;"><img src="${ex.gif}" alt="${fr}" style="width:100%;max-width:240px;border-radius:12px;"></div>` : '';
      body.innerHTML = `${big}<strong>Positionnement :</strong> ${ex.setup||'-'}<br><strong>Indices techniques :</strong> ${ex.cues||'-'}<br><strong>Erreurs fréquentes :</strong> ${ex.errors||'-'}`;
      details.appendChild(summary); details.appendChild(body); list.appendChild(details);
    });
  }
  $('#exGuideSearch')?.addEventListener('input', renderExerciseGuide);

  function updateStats(){ let sum=0; for(const k in state.repsLog){ sum += (state.repsLog[k]||0); } state.totals.reps=sum; $('#totalReps').textContent=String(sum); $('#totalTime').textContent=fmtTime(state.totals.time||0); $('#totalSessions').textContent=`${state.totals.sessions||0} séances`; $('#bestStreak').textContent=String(state.totals.bestStreak||0); $('#streakChip').textContent=`🔥 Série: ${state.totals.streak||0}`; }

  $('#duplicate3m').addEventListener('click',()=>{ alert('Astuce: Répète ce plan 3 fois (3 cycles). Utilise le calendrier pour suivre sur 12 semaines.'); });

  function init(){ buildDaysList(); buildCalendar(); updateToday(); updateStats(); renderHistory(); renderFree(); renderSkills(); renderExerciseGuide(); document.querySelector('#restDisplay').textContent='00:00'; }
  init();

  // ==== Difficulty selector (easy/medium/hard) ====
  state.difficulty = state.difficulty || 'medium';
  const DIFF_FACT = {easy:0.8, medium:1.0, hard:1.25};

  function scaleTargetText(target, factor){
    if(!target) return target;
    // Scale first number in the string (reps or seconds). Keep rest the same.
    const m = String(target).match(/(\d+)(?=[^\d]*$)|\d+/); // pick first number
    if(!m) return target;
    const n = parseInt(m[0],10);
    const s = Math.max(1, Math.round(n*factor));
    return target.replace(m[0], String(s));
  }

  function applyDifficultyToToday(){
    const list = $('#workoutList');
    const d = getDayData(state.currentDay);
    if(!list || !d) return;
    const factor = DIFF_FACT[state.difficulty] || 1;
    [...list.querySelectorAll('.workout-item')].forEach((row, idx)=>{
      const pair = d.items[idx]; if(!pair) return;
      const [name, base] = pair;
      const label = row.querySelector('.label');
      if(label){
        label.textContent = 'Cible: ' + scaleTargetText(base, factor);
      }
    });
  }

  // Hook updateToday to re-apply scaling after render
  const __updateToday = updateToday;
  updateToday = function(){ __updateToday(); applyDifficultyToToday(); };

  // UI: difficulty buttons in Settings
  function refreshDiffButtons(){
    const sel = state.difficulty;
    document.querySelectorAll('[data-diff]').forEach(b=>{
      if(b.getAttribute('data-diff')===sel) b.classList.add('primary'); else b.classList.remove('primary');
    });
    const hint = $('#diffHint');
    if(hint){
      hint.textContent = sel==='easy'?'Objectifs réduits (~20% de moins)':
                          sel==='hard'?'Objectifs augmentés (~25% de plus)':
                          'Cibles standards.';
    }
  }
  document.querySelectorAll('[data-diff]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      state.difficulty = btn.getAttribute('data-diff');
      persist(); refreshDiffButtons(); updateToday();
    });
  });
  refreshDiffButtons();

  // === XP & Badges ===
  state.xp = state.xp || 0;
  state.badges = state.badges || {}; // {id:true}

  // ===== Revamped Achievements: tiered badges with progress & animations =====
  const ACHIEVEMENTS = [
    { key:'pompes', icon:'💪', name:'Pompes', tiers:[
      {id:'pompes_bronze', tier:'bronze', threshold:500},
      {id:'pompes_silver', tier:'silver', threshold:1000},
      {id:'pompes_gold', tier:'gold', threshold:2500},
      {id:'pompes_platinum', tier:'platinum', threshold:5000}
    ]},
    { key:'squats', icon:'🦵', name:'Squats', tiers:[
      {id:'squats_bronze', tier:'bronze', threshold:500},
      {id:'squats_silver', tier:'silver', threshold:1200},
      {id:'squats_gold', tier:'gold', threshold:3000},
      {id:'squats_platinum', tier:'platinum', threshold:6000}
    ]},
    { key:'tractions', icon:'🧗', name:'Tractions', tiers:[
      {id:'tractions_bronze', tier:'bronze', threshold:200},
      {id:'tractions_silver', tier:'silver', threshold:500},
      {id:'tractions_gold', tier:'gold', threshold:1200},
      {id:'tractions_platinum', tier:'platinum', threshold:2500}
    ]},
    { key:'dips', icon:'🏋️', name:'Dips', tiers:[
      {id:'dips_bronze', tier:'bronze', threshold:300},
      {id:'dips_silver', tier:'silver', threshold:800},
      {id:'dips_gold', tier:'gold', threshold:1800},
      {id:'dips_platinum', tier:'platinum', threshold:3500}
    ]},
    // Keep a few milestone badges too
    { key:'streak', icon:'📅', name:'Streak', tiers:[
      {id:'streak7', tier:'bronze', threshold:7},
      {id:'streak14', tier:'silver', threshold:14},
      {id:'streak30', tier:'gold', threshold:30}
    ], from:'totals.streak' },
    { key:'sessions', icon:'✅', name:'Séances', tiers:[
      {id:'sessions10', tier:'bronze', threshold:10},
      {id:'sessions25', tier:'silver', threshold:25},
      {id:'sessions50', tier:'gold', threshold:50},
      {id:'sessions100', tier:'platinum', threshold:100}
    ], from:'totals.sessions' },
    { key:'time', icon:'⏱️', name:'Temps (h)', tiers:[
      {id:'time10h', tier:'bronze', threshold:10},
      {id:'time25h', tier:'silver', threshold:25},
      {id:'time50h', tier:'gold', threshold:50}
    ], from:'totals.timeHours' }
  ];

  const NAME_MAP = {
    'pompes':'pompes','pompe':'pompes','push-up':'pompes','push ups':'pompes',
    'squats':'squats','squat':'squats',
    'tractions':'tractions','traction':'tractions','pull-up':'tractions','pull ups':'tractions',
    'dips':'dips','dip':'dips'
  };
  function normalizeName(n){ const k=(''+(n||'')).toLowerCase().trim(); return NAME_MAP[k]||null; }

  function computeExerciseTotals(){
    const totals = { pompes:0, squats:0, tractions:0, dips:0 };
    try{
      const log = state.repsLog || {};
      Object.keys(log).forEach(k=>{
        const reps = +log[k] || 0;
        const parts = k.split(':');
        if(parts.length<3) return;
        const day = parseInt(parts[0],10);
        const idx = parseInt(parts[2],10);
        let d = null; try{ d = (typeof getDayData==='function') ? getDayData(day) : null; }catch(_){}
        if(!d || !d.items) return;
        const item = d.items[idx]; if(!item) return;
        const name = Array.isArray(item)? item[0] : (item && item.name) || '';
        const key = normalizeName(name);
        if(key && reps>0) totals[key] = (totals[key]||0) + reps;
      });
    }catch(_){}
    return totals;
  }

  function extract(path, fallback=0){
    try{
      if(path==='totals.timeHours'){ return Math.round((state.totals?.time||0)/3600); }
      const seg = path.split('.'); let o = state;
      for(const s of seg){ o = o?.[s]; }
      return +o || 0;
    }catch(_){ return fallback; }
  }

  function tierStatus(tiers, value){
    let unlocked = null, next = null, progress = 0;
    for (let i=0;i<tiers.length;i++){
      if (value >= tiers[i].threshold) { unlocked = tiers[i]; continue; }
      next = tiers[i]; break;
    }
    if (!next){ next = tiers[tiers.length-1]; progress = 1; }
    else {
      const prev = unlocked ? unlocked.threshold : 0;
      const span = next.threshold - prev;
      progress = Math.max(0, Math.min(1, (value - prev) / span));
    }
    return {unlocked, next, progress};
  }

  function gainXP(amount){ state.xp = (state.xp||0) + amount; persist(); refreshXP(); }

  function refreshXP(){
    const xp = state.xp||0;
    const el = $('#xpPoints'); if(el) el.textContent = String(xp);
  }

  function renderBadges(){
    const box = $('#badgesList'); if(!box) return;
    box.classList.add('badge-grid');
    box.innerHTML='';
    // totals
    const exTotals = computeExerciseTotals();
    // Build UI
    ACHIEVEMENTS.forEach(a=>{
      const value = (a.from ? extract(a.from, 0) : (exTotals[a.key]||0));
      const st = tierStatus(a.tiers, value);
      const div = document.createElement('div');
      div.className = 'achv ' + (st.unlocked?('tier-'+st.unlocked.tier+' unlocked levelup'):'locked');
      div.innerHTML = `
        <div class="icon">${a.icon}</div>
        <div class="name">${a.name}</div>
        <div class="tier">${st.unlocked ? (st.unlocked.tier.toUpperCase()) : ('→ '+(st.next?st.next.threshold:''))}</div>
        <div class="bar"><i style="width:${(st.progress*100).toFixed(1)}%"></i></div>
        <span class="ring"></span>
      `;
      box.appendChild(div);
    });
    // persist badges flags for simple lookup (optional)
    state.badges = state.badges || {};
    ACHIEVEMENTS.forEach(a=>{
      const value = (a.from ? extract(a.from, 0) : (exTotals[a.key]||0));
      a.tiers.forEach(t=>{ if(value>=t.threshold) state.badges[t.id]=true; });
    });
    persist();
  }

  // Hook into calendar day toggle to award XP when marking 'done'
  (function hookCalendarAward(){
    const cal = $('#calendar'); if(!cal) return;
    cal.addEventListener('click', (e)=>{
      const t = e.target.closest('.day'); if(!t) return;
      // We can't easily get the key here; rely on totals change heuristic after a short delay
      setTimeout(()=>{ refreshXP(); renderBadges(); }, 50);
    });
  })();

  // Also award XP right at the place where session is marked done
  (function patchCalendarMarking(){
    const pat = /state\.calendar\[key\]==='done'\)\{ state\.totals\.sessions\+\+; state\.totals\.streak\+\+;/;
    // Not easily regex-replace here; instead, add a MutationObserver to detect 'done' state
    const cal = $('#calendar'); if(!cal) return;
    const mo = new MutationObserver(()=>{});
  })();

  // Refresh on init and whenever stats update
  const _updateStats = updateStats;
  updateStats = function(){
    _updateStats();
    refreshXP();
    renderBadges();
  };
  refreshXP();
  renderBadges();

// === Smooth menu animation ===
document.querySelectorAll('nav a').forEach(a=>{
  a.addEventListener('click', e=>{
    const targetId = a.getAttribute('href').replace('#','');
    document.querySelectorAll('section').forEach(sec=>sec.classList.remove('active'));
    setTimeout(()=>{
      const sec = document.getElementById(targetId);
      if(sec) sec.classList.add('active');
    },10);
  });
});
// Activate first visible section
document.querySelectorAll('section').forEach((sec,i)=>{
  if(i===0) sec.classList.add('active');
});

// ==== Global animations: tab enter effect ====
(function(){
  function activateSection(id){
    var sec = document.getElementById(id);
    if(!sec) return;
    // Trigger enter animation
    sec.classList.remove('enter');
    // Force reflow to restart animation
    void sec.offsetWidth;
    sec.classList.add('enter');
  }
  // Bind to any nav anchor with href="#tab-*"
  document.querySelectorAll('a[href^="#tab-"]').forEach(function(a){
    a.addEventListener('click', function(){
      var id = a.getAttribute('href').replace('#','');
      setTimeout(function(){ activateSection(id); }, 5);
    });
  });
  // Kick initial
  var current = document.querySelector('section'); if(current){ current.classList.add('enter'); }
})();

// ==== Mobile-friendly horizontal tab transitions ====
(function(){
  const TABS = ['tab-today','tab-timer','tab-stats','tab-settings'];
  const idxOf = id => Math.max(0, TABS.indexOf(id));
  let currentId = (location.hash||'').replace('#','');
  if(!currentId || !TABS.includes(currentId)) currentId = TABS[0];

  function setActive(id, dir){
    if(id === currentId) return;
    const from = document.getElementById(currentId);
    const to   = document.getElementById(id);
    if(!to) return;

    // Prepare visibility
    to.classList.add('active');
    // Directional classes
    from && from.classList.remove('section-enter-left','section-enter-right','section-exit-left','section-exit-right');
    to.classList.remove('section-enter-left','section-enter-right','section-exit-left','section-exit-right');

    if(from){
      from.classList.add(dir>0 ? 'section-exit-left' : 'section-exit-right');
      // After exit, hide old
      from.addEventListener('animationend', ()=>{
        from.classList.remove('active','section-exit-left','section-exit-right');
      }, {once:true});
    }
    to.classList.add(dir>0 ? 'section-enter-right' : 'section-enter-left');

    currentId = id;
  }

  function show(id){
    const dir = idxOf(id) - idxOf(currentId);
    setActive(id, dir);
    location.hash = '#' + id;
    // Ensure we scroll to top on tab change for mobile
    window.scrollTo({top:0, behavior:'instant'});
  }

  // Init: ensure only the current is visible
  document.querySelectorAll('section').forEach(sec=>sec.classList.remove('active'));
  const cur = document.getElementById(currentId); if(cur) cur.classList.add('active');

  // Bind nav
  document.querySelectorAll('a[href^="#tab-"]').forEach(a=>{
    a.addEventListener('click', (e)=>{
      e.preventDefault();
      const id = a.getAttribute('href').slice(1);
      show(id);
    }, {passive:true});
  });

  // Handle back/forward
  window.addEventListener('hashchange', ()=>{
    const id = (location.hash||'').slice(1);
    if(TABS.includes(id)) show(id);
  });
})();

// Smooth cross-fade when OS theme changes
(function(){
  var mq = window.matchMedia('(prefers-color-scheme: dark)');
  if(mq && mq.addEventListener){
    mq.addEventListener('change', function(){
      document.documentElement.classList.add('theme-xfade');
      setTimeout(function(){ document.documentElement.classList.remove('theme-xfade'); }, 450);
    });
  }
})();

// ===== Manual theme switch (Auto / Light / Dark) + persist =====
(function(){
  state.theme = state.theme || 'auto';
  function applyTheme(){
    document.documentElement.classList.remove('force-light','force-dark','theme-xfade');
    // Smooth cross-fade
    document.documentElement.classList.add('theme-xfade');
    setTimeout(()=>document.documentElement.classList.remove('theme-xfade'), 450);
    if(state.theme==='light'){ document.documentElement.classList.add('force-light'); }
    else if(state.theme==='dark'){ document.documentElement.classList.add('force-dark'); }
  }
  function refreshThemeButtons(){
    document.querySelectorAll('[data-theme-choice]').forEach(b=>{
      if(b.getAttribute('data-theme-choice')===state.theme) b.classList.add('primary');
      else b.classList.remove('primary');
    });
  }
  document.querySelectorAll('[data-theme-choice]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      state.theme = btn.getAttribute('data-theme-choice');
      persist(); refreshThemeButtons(); applyTheme();
    }, {passive:true});
  });
  refreshThemeButtons(); applyTheme();
})();

// ===== Light haptics on tap (if available) =====
(function(){
  const vib = (ms)=>{ try{ if('vibrate' in navigator) navigator.vibrate(ms); }catch(_){} };
  function attachHaptics(sel){
    document.querySelectorAll(sel).forEach(el=>{
      el.addEventListener('click', ()=>{
        vib(10); // Android/Chrome
        // Visual fallback for iOS (no Vibration API)
        el.classList.add('haptic-press');
        setTimeout(()=>el.classList.remove('haptic-press'), 130);
      }, {passive:true});
    });
  }
  attachHaptics('.btn');
  attachHaptics('#calendar .day');
  attachHaptics('.workout-item summary');
})();

// === Rest bell (ding ding ding) at end of REST phase ===
function restBell(){
  const a = $('#restBell');
  if(!a) return;
  try{ a.currentTime = 0; a.play(); }catch(e){ /* ignored */ }
}
// Watch phase label to detect end of REST -> WORK transition
(function(){
  const phaseEl = $('#intPhase');
  if(!phaseEl) return;
  let prev = phaseEl.textContent.trim().toLowerCase();
  const obs = new MutationObserver(()=>{
    const cur = phaseEl.textContent.trim().toLowerCase();
    if(prev==='repos' && (cur==='travail' || cur==='fini' || cur==='prêt')){
      restBell();
    }
    prev = cur;
  });
  obs.observe(phaseEl, {characterData:true, subtree:true, childList:true});
})();

// ==== WebAudio chimes for interval timer ====
(function(){
  const AUD = { ctx:null, ready:false };
  function ensureAudio(){
    if(AUD.ready && AUD.ctx && AUD.ctx.state!=='closed') return true;
    try{
      const C = window.AudioContext || window.webkitAudioContext;
      if(!C) return false;
      AUD.ctx = new C();
      AUD.ready = true;
      return true;
    }catch(e){ return false; }
  }
  // Prepare on first user gesture (anywhere)
  ['pointerdown','touchstart','mousedown'].forEach(ev=>{
    window.addEventListener(ev, ()=>{ ensureAudio(); }, {once:true, passive:true});
  });

  function playTone(freq, dur, vol, when){
    const ctx = AUD.ctx; if(!ctx) return;
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type='sine'; o.frequency.setValueAtTime(freq, ctx.currentTime+(when||0));
    g.gain.setValueAtTime(0.0001, ctx.currentTime+(when||0));
    g.gain.linearRampToValueAtTime(vol, ctx.currentTime+(when||0)+0.01);
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+(when||0)+dur);
    o.connect(g).connect(ctx.destination);
    o.start(ctx.currentTime+(when||0));
    o.stop(ctx.currentTime+(when||0)+dur+0.03);
  }

  function chimeRestEnd(){
    if(!ensureAudio()) { const a=$('#restBell'); try{ a.currentTime=0; a.play(); }catch(_){} return; }
    // triple bright chime (660+990), repeated x3 with short gaps
    const seq = [0, 0.34, 0.68];
    seq.forEach(off=>{ playTone(660,0.22,0.22,off); playTone(990,0.22,0.12,off); });
  }

  function chimeWorkEnd(){
    if(!ensureAudio()) return;
    // double lower chime (440+660, then 392+587)
    playTone(440,0.28,0.24,0.00); playTone(660,0.24,0.14,0.00);
    playTone(392,0.32,0.24,0.36); playTone(587,0.24,0.14,0.36);
  }

  // When user taps Start on interval timer, also ensure audio is primed
  const startBtn = $('#intStart');
  if(startBtn){ startBtn.addEventListener('click', ()=>{ ensureAudio(); }, {passive:true}); }

  // Watch phase label to detect transitions
  (function(){
    const phaseEl = $('#intPhase');
    if(!phaseEl) return;
    let prev = (phaseEl.textContent||'').trim().toLowerCase();
    const obs = new MutationObserver(()=>{
      const cur = (phaseEl.textContent||'').trim().toLowerCase();
      // REST -> WORK/FINI
      if(prev==='repos' && (cur==='travail' || cur==='fini' || cur==='prêt')){
        chimeRestEnd();
      }
      // WORK -> REST/FINI
      if(prev==='travail' && (cur==='repos' || cur==='fini')){
        chimeWorkEnd();
      }
      prev = cur;
    });
    obs.observe(phaseEl, {characterData:true, subtree:true, childList:true});
  })();
})();

// ==== Animate exercise guide details ====
(function(){
  const list = document.getElementById('exGuideList');
  if(!list) return;

  function setup(details){
    if(details.__animated) return;
    details.__animated = true;
    const content = details.querySelector(':scope > .label');
    if(!content) return;
    content.style.overflow = 'hidden';
    // Initial state
    if(details.open){
      content.style.maxHeight = content.scrollHeight + 'px';
      content.style.opacity = '1';
    }else{
      content.style.maxHeight = '0px';
      content.style.opacity = '0';
    }
    details.addEventListener('toggle', ()=>{
      const open = details.open;
      // fix current height to allow transition from current to target
      const startH = content.getBoundingClientRect().height;
      content.style.maxHeight = startH + 'px';
      // next frame -> animate to target
      requestAnimationFrame(()=>{
        const target = open ? content.scrollHeight : 0;
        content.style.transition = 'max-height .5s ease, opacity .5s ease';
        content.style.maxHeight = target + 'px';
        content.style.opacity = open ? '1' : '0';
        if(open){
          const tidy = ()=>{
            // remove max-height so content can grow naturally if resized
            content.style.maxHeight = '';
            content.removeEventListener('transitionend', tidy);
          };
          content.addEventListener('transitionend', tidy);
        }
      });
    });
  }

  // Hook existing
  list.querySelectorAll('details.workout-item').forEach(setup);

  // Observe future list renders
  const mo = new MutationObserver((muts)=>{
    muts.forEach(m=>{
      m.addedNodes && m.addedNodes.forEach(node=>{
        if(node.tagName === 'DETAILS') setup(node);
        else if(node.querySelectorAll){
          node.querySelectorAll('details.workout-item').forEach(setup);
        }
      });
    });
  });
  mo.observe(list, {childList:true});
})();

// === Free Mode: enhanced 'Ajouter exo' with selector + target builder ===
(function(){
  const dlg = $('#freePicker'); if(!dlg) return;
  const sel = $('#freePickSelect'), search=$('#freePickSearch');
  const gif = $('#freePickGif'), info=$('#freePickInfo');
  const val = $('#freePickValue'), side=$('#freePickSide');
  const btnClose=$('#freePickerClose'), btnCancel=$('#freePickCancel'), btnOk=$('#freePickConfirm');

  // Build options list
  let KEYS = Object.keys(EX_DB).sort((a,b)=>tName(a).localeCompare(tName(b),'fr'));
  function refillOptions(){
    const q = (search.value||'').toLowerCase();
    sel.innerHTML='';
    KEYS.forEach(k=>{
      const fr = tName(k);
      if(q && !fr.toLowerCase().includes(q)) return;
      const opt = document.createElement('option');
      opt.value = k; opt.textContent = fr;
      sel.appendChild(opt);
    });
    onSelect();
  }
  function onSelect(){
    const k = sel.value; if(!k){ gif.style.display='none'; info.textContent=''; return; }
    const ex = EX_DB[k];
    if(ex?.gif){ gif.src=ex.gif; gif.style.display='block'; } else { gif.style.display='none'; }
    info.innerHTML = `<strong>${tName(k)}</strong><br><span class='label'>${ex?.setup||''}</span>`;
  }
  sel.addEventListener('change', onSelect);
  search.addEventListener('input', refillOptions);

  function makeTarget(){
    const type = (document.querySelector('input[name="freeType"]:checked')?.value)||'reps';
    const n = Math.max(1, parseInt(val.value||'10',10));
    const bySide = side.checked;
    if(type==='time') return `${n}s`;
    return bySide ? `${n}/side` : String(n);
  }

  let editingIndex = null;
  function openPicker(editIndex=null, preset=null){
    editingIndex = editIndex;
    if(preset){
      // try to match exercise by name string (FR display)
      const key = Object.keys(EX_DB).find(k=>tName(k)===preset.name) || Object.keys(EX_DB).find(k=>k===preset.name) || KEYS[0];
      sel.value = key;
      onSelect();
      const t = String(preset.target||''); const m = t.match(/(\d+)/); val.value = m? m[1] : 10;
      const isTime = /s\b/.test(t); document.querySelector(`input[name="freeType"][value="${isTime?'time':'reps'}"]`).checked = true;
      side.checked = /\/side$/.test(t);
      btnOk.textContent = 'Enregistrer';
    }else{
      search.value=''; val.value=10; side.checked=false; document.querySelector('input[name="freeType"][value="reps"]').checked = true;
      refillOptions(); btnOk.textContent = 'Ajouter';
    }
    if(typeof dlg.showModal==='function') dlg.showModal(); else dlg.open=true;
  }

  function closePicker(){ if(dlg.close) try{ dlg.close(); }catch{} else dlg.open=false; }

  // Replace old listener to avoid prompts
  const old = $('#freeAddExo'); if(old){
    const fresh = old.cloneNode(true); old.replaceWith(fresh);
    fresh.addEventListener('click', ()=> openPicker(null, null));
  }
  // Also allow editing from the list by clicking item name
  const _renderFree = renderFree;
  renderFree = function(){
    _renderFree();
    const rows = $('#freeList')?.querySelectorAll('.workout-item');
    rows?.forEach((row, idx)=>{
      row.style.cursor='pointer';
      row.addEventListener('click', (e)=>{
        // avoid acting on delete button clicks
        if(e.target.closest('[data-del]')) return;
        const x = state.free[idx];
        if(x) openPicker(idx, x);
      });
    });
  };

  // Confirm add/edit
  btnOk.addEventListener('click', ()=>{
    const key = sel.value; if(!key) return;
    const name = tName(key);
    const target = makeTarget();
    if(editingIndex!=null){
      state.free[editingIndex] = {name, target};
    }else{
      state.free = state.free || [];
      state.free.push({name, target});
    }
    persist(); closePicker(); renderFree();
  });
  [btnClose, btnCancel].forEach(b=> b.addEventListener('click', ()=> closePicker()));
  // Init options
  refillOptions();
})();

// ==== Sheets & Free Mode add without keyboard ====
(function(){
  const sheetEx = $('#sheetEx'), exList = $('#sheetExList'), exClose = $('#sheetExClose');
  const sheetReps = $('#sheetReps'), repsClose=$('#sheetRepsClose');
  const repMinus=$('#repMinus'), repPlus=$('#repPlus'), repNum=$('#repNum'), repOk=$('#repOk');
  let selectedName = null;

  function openSheet(el){
    el.classList.remove('closing'); el.classList.add('open'); el.setAttribute('aria-hidden','false');
  }
  function closeSheet(el){
    el.classList.add('closing'); el.classList.remove('open');
    setTimeout(()=>{ el.setAttribute('aria-hidden','true'); el.classList.remove('closing'); }, 420);
  }

  function buildExList(){
    exList.innerHTML='';
    const keys = Object.keys(EX_DB).sort((a,b)=>tName(a).localeCompare(tName(b),'fr'));
    keys.forEach(k=>{
      const ex = EX_DB[k], fr = tName(k);
      const row = document.createElement('div');
      row.className = 'ex-row';
      const gif = ex.gif ? `<img src="${ex.gif}" alt="${fr}">` : `<div style="width:56px;height:56px;border-radius:10px;background:rgba(255,255,255,.06)"></div>`;
      row.innerHTML = `${gif}<div><div class="name">${fr}</div><div class="meta">${ex.setup||''}</div></div><button class="btn add" data-add="${k}">+</button>`;
      exList.appendChild(row);
    });
    // Delegate '+' buttons
    exList.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-add]'); if(!btn) return;
      const k = btn.getAttribute('data-add');
      selectedName = tName(k);
      // Close list, open reps
      closeSheet(sheetEx);
      setTimeout(()=>{ repNum.textContent='8'; openSheet(sheetReps); }, 450);
    }, {once:true}); // reattach on each open
  }

  // Open list from freeAddExo
  const addBtn = $('#freeAddExo');
  if(addBtn){
    const fresh = addBtn.cloneNode(true); addBtn.replaceWith(fresh);
    fresh.addEventListener('click', ()=>{ buildExList(); openSheet(sheetEx); }, {passive:true});
  }

  // Close handlers
  [exClose, repsClose].forEach(b=> b && b.addEventListener('click', ()=>{
    const parent = b.id==='sheetRepsClose' ? sheetReps : sheetEx;
    closeSheet(parent);
  }));

  // Reps chooser
  function setNum(n){ n = Math.max(1, Math.min(300, n)); repNum.textContent = String(n); }
  repMinus.addEventListener('click', ()=> setNum(parseInt(repNum.textContent,10)-1));
  repPlus.addEventListener('click', ()=> setNum(parseInt(repNum.textContent,10)+1));
  repOk.addEventListener('click', ()=>{
    const reps = parseInt(repNum.textContent,10) || 8;
    if(!selectedName) return closeSheet(sheetReps);
    state.free = state.free || [];
    state.free.push({name:selectedName, target:String(reps)});
    persist(); renderFree();
    closeSheet(sheetReps);
  });
})();

// ==== Quick controls: next day & finish session (sync calendar) ====
(function(){
  function gotoNextDay(){
    if(typeof state.currentDay!=='number') state.currentDay = 1;
    // PLAN_30 length fallback
    const max = (typeof PLAN_30!=='undefined' && PLAN_30?.length) ? PLAN_30.length : 30;
    state.currentDay = (state.currentDay < max) ? state.currentDay + 1 : 1;
    persist(); updateToday && updateToday();
  }
  function finishSession(){
    const d = new Date();
    const y = d.getFullYear(), m=d.getMonth()+1, day=d.getDate();
    const candidates = [
      `${y}-${m}-${day}`,
      `${y}-${String(m).padStart(2,'0')}-${String(day).padStart(2,'0')}`,
      `${y}/${m}/${day}`
    ];
    let key = candidates.find(k => (state.calendar||{})[k] !== undefined);
    if(!key){ key = candidates[0]; state.calendar = state.calendar || {}; }
    const was = state.calendar[key] === 'done';
    state.calendar[key] = 'done';
    if(!was){
      state.totals = state.totals || {};
      state.totals.sessions = (state.totals.sessions||0)+1;
      state.totals.streak = (state.totals.streak||0)+1;
    }
    addHistory && addHistory('today');
    persist();
    if(typeof buildCalendar==='function') buildCalendar();
    if(typeof updateStats==='function') updateStats();
    // Feedback: small flash on streak chip if exists
    const chip = $('#streakChip'); if(chip){ chip.classList.add('badge-pop-once'); setTimeout(()=>chip.classList.remove('badge-pop-once'),600); }
  }

  $('#nextDayBtn')?.addEventListener('click', gotoNextDay);
  $('#finishBtn')?.addEventListener('click', finishSession);
})();

// Fused "Finish & Next" button: mark day as done (calendar) then go to next workout
(function(){
  function finishAndNext(){
    const d = new Date();
    const y = d.getFullYear(), m=d.getMonth()+1, day=d.getDate();
    const cand = [
      `${y}-${m}-${day}`,
      `${y}-${String(m).padStart(2,'0')}-${String(day).padStart(2,'0')}`,
      `${y}/${m}/${day}`
    ];
    state.calendar = state.calendar || {};
    let key = cand.find(k => state.calendar[k] !== undefined) || cand[1] || cand[0];
    const already = state.calendar[key] === 'done';
    state.calendar[key] = 'done';
    state.totals = state.totals || {};
    if(!already){
      state.totals.sessions = (state.totals.sessions||0)+1;
      state.totals.streak = (state.totals.streak||0)+1;
    }
    addHistory && addHistory('today');
    persist();
    if(typeof buildCalendar==='function') buildCalendar();
    if(typeof updateStats==='function') updateStats();
    // Advance to next day
    const max = (typeof PLAN_30!=='undefined' && PLAN_30?.length) ? PLAN_30.length : 30;
    if(typeof state.currentDay!=='number') state.currentDay = 1;
    state.currentDay = (state.currentDay < max) ? state.currentDay + 1 : 1;
    persist();
    updateToday && updateToday();
    // Small visual feedback on button
    const b = $('#finishNextBtn'); if(b){ b.classList.add('badge-pop-once'); setTimeout(()=>b.classList.remove('badge-pop-once'), 500); }
  }
  const btn = $('#finishNextBtn'); if(btn){ btn.addEventListener('click', finishAndNext); }
})();

// --- Robust binder for Finish & Next button ---
(function(){
  function finishAndNext(){
    const dNow = new Date();
    const y = dNow.getFullYear(), m=dNow.getMonth()+1, day=dNow.getDate();
    const key = `${y}-${String(m).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    state.calendar = state.calendar || {};
    const already = state.calendar[key] === 'done';
    state.calendar[key] = 'done';
    state.totals = state.totals || {};
    if(!already){
      state.totals.sessions = (state.totals.sessions||0)+1;
      state.totals.streak = (state.totals.streak||0)+1;
    }
    // add to history if function exists
    if (typeof addHistory === 'function') addHistory('today');
    persist();
    if(typeof buildCalendar==='function') buildCalendar();
    if(typeof updateStats==='function') updateStats();

    // Advance to next planned day
    const max = (typeof PLAN_30!=='undefined' && PLAN_30?.length) ? PLAN_30.length : 30;
    if(typeof state.currentDay!=='number') state.currentDay = 1;
    state.currentDay = (state.currentDay < max) ? state.currentDay + 1 : 1;
    persist();
    if(typeof updateToday==='function') updateToday();
  }

  function bindFinishNext(){
    const btn = document.getElementById('finishNextBtn');
    if(!btn || btn.__bound) return;
    btn.__bound = true;
    btn.addEventListener('click', finishAndNext);
  }

  // Bind now and after every updateToday()
  bindFinishNext();
  if(typeof updateToday === 'function' && !updateToday.__patched){
    const __updateToday = updateToday;
    updateToday = function(){ __updateToday(); bindFinishNext(); };
    updateToday.__patched = true;
  }
})();

// --- Fix calendar key: use same format as buildCalendar (dYYYY-M-D) ---
(function(){
  function bindFix(){
    const btn = document.getElementById('finishNextBtn'); if(!btn) return;
    if(btn.__fixed) return; btn.__fixed = true;
    btn.addEventListener('click', function(){
      const now = new Date();
      const y = now.getFullYear(), m = now.getMonth()+1, d = now.getDate();
      const key = `d${y}-${m}-${d}`; // same as buildCalendar
      state.calendar = state.calendar || {};
      const already = state.calendar[key] === 'done';
      state.calendar[key] = 'done';
      state.totals = state.totals || {};
      if(!already){
        state.totals.sessions = (state.totals.sessions||0)+1;
        state.totals.streak = (state.totals.streak||0)+1;
      }
      if (typeof addHistory === 'function') addHistory('today');
      persist();
      if(typeof buildCalendar==='function') buildCalendar();
      if(typeof updateStats==='function') updateStats();
      // Advance day
      const max = (typeof PLAN_30!=='undefined' && PLAN_30?.length) ? PLAN_30.length : 30;
      if(typeof state.currentDay!=='number') state.currentDay = 1;
      state.currentDay = (state.currentDay < max) ? state.currentDay + 1 : 1;
      persist();
      if(typeof updateToday==='function') updateToday();
    });
  }
  bindFix();
  if(typeof updateToday==='function' && !updateToday.__fix2){
    const _u = updateToday;
    updateToday = function(){ _u(); bindFix(); };
    updateToday.__fix2 = true;
  }
})();
</script>

<dialog id="freePicker" style="max-width:560px;width:92%;border:none;border-radius:18px;padding:0;overflow:hidden">
  <div style="padding:14px 14px 6px; display:flex; align-items:center; gap:10px; border-bottom:1px solid rgba(255,255,255,.08)">
    <div class="h2" style="margin:0">Ajouter un exercice</div>
    <button class="btn ghost" id="freePickerClose" style="margin-left:auto">Fermer</button>
  </div>
  <div style="padding:14px; display:grid; gap:10px">
    <div class="row" style="gap:8px; align-items:center">
      <input id="freePickSearch" placeholder="Rechercher un exercice..." type="search" style="flex:1">
      <select id="freePickSelect" style="min-width:210px"></select>
    </div>
    <div class="row" style="gap:10px; align-items:center">
      <img id="freePickGif" style="width:72px;height:72px;object-fit:cover;border-radius:12px;display:none" alt="aperçu">
      <div id="freePickInfo" class="label" style="flex:1"></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr; gap:10px">
      <div>
        <div class="label">Type de cible</div>
        <div class="row" style="gap:6px; flex-wrap:wrap">
          <label class="btn ghost"><input type="radio" name="freeType" value="reps" checked> Reps</label>
          <label class="btn ghost"><input type="radio" name="freeType" value="time"> Durée (s)</label>
        </div>
      </div>
      <div>
        <div class="label">Valeur</div>
        <div class="row" style="gap:6px; align-items:center">
          <input id="freePickValue" type="number" min="1" max="1000" value="10" style="width:110px">
          <label class="row" style="gap:6px;align-items:center">
            <input id="freePickSide" type="checkbox">
            <span class="label">par côté</span>
          </label>
        </div>
      </div>
    </div>
    <div class="row" style="gap:8px;justify-content:flex-end;padding-top:8px;border-top:1px solid rgba(255,255,255,.08)">
      <button class="btn ghost" id="freePickCancel">Annuler</button>
      <button class="btn primary" id="freePickConfirm">Ajouter</button>
    </div>
  </div>
</dialog>

<div id="sheetEx" class="sheet" aria-hidden="true">
  <div class="backdrop"></div>
  <div class="panel">
    <div class="row" style="align-items:center; gap:8px; padding:12px 14px 6px">
      <div class="h2" style="margin:0">Ajouter un exercice</div>
      <button class="btn ghost" id="sheetExClose" style="margin-left:auto">Fermer</button>
    </div>
    <div id="sheetExList"></div>
  </div>
</div>

<div id="sheetReps" class="sheet" aria-hidden="true">
  <div class="backdrop"></div>
  <div class="panel">
    <div class="row" style="align-items:center; gap:8px; padding:12px 14px 6px">
      <div class="h2" style="margin:0">Choisir les reps</div>
      <button class="btn ghost" id="sheetRepsClose" style="margin-left:auto">Fermer</button>
    </div>
    <div class="valueBox">
      <button class="btn" id="repMinus">–</button>
      <div class="num" id="repNum">8</div>
      <button class="btn" id="repPlus">+</button>
    </div>
    <div class="actions">
      <button class="btn primary" id="repOk">✓</button>
    </div>
  </div>
</div>

<script>
(function () {
  // make sure we have a global state object
  window.state = window.state || {};

  function markTodayDone() {
    try {
      const now = new Date();
      const key = `d${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}`;
      state.calendar = state.calendar || {};
      const already = state.calendar[key] === 'done';
      state.calendar[key] = 'done';
      state.totals = state.totals || {};
      if (!already) {
        state.totals.sessions = (state.totals.sessions || 0) + 1;
        state.totals.streak  = (state.totals.streak  || 0) + 1;
      }
      if (typeof addHistory === 'function') addHistory('today');
      if (typeof buildCalendar === 'function') buildCalendar();
      if (typeof updateStats   === 'function') updateStats();
    } catch (e) {
      console.warn('markTodayDone failed:', e);
    }
  }

  function findPlanLength() {
    if (typeof PLAN_30 !== 'undefined' && PLAN_30 && PLAN_30.length) return PLAN_30.length;
    if (typeof PLAN !== 'undefined' && PLAN && PLAN.length) return PLAN.length;
    return 30;
  }

  function goToNextDay() {
    try {
      const max = findPlanLength();
      if (typeof state.currentDay !== 'number') state.currentDay = 1;
      state.currentDay = (state.currentDay < max) ? state.currentDay + 1 : 1;
      state.currentRound = 1;
      if (typeof persist === 'function') persist();
      if (typeof updateToday === 'function') updateToday();
      if (typeof activateTab === 'function') activateTab('today','tabTodayBtn');
    } catch (e) {
      console.warn('goToNextDay failed:', e);
    }
  }

  function onFinishNext() {
    markTodayDone();
    goToNextDay();
  }

  function bindOnce(btn) {
    if (!btn || btn.__boundFinishNext) return;
    btn.__boundFinishNext = true;
    btn.addEventListener('click', onFinishNext);
  }

  function tryBind() {
    const btn = document.getElementById('finishNextBtn') ||
                document.querySelector('[data-action="finish-next"]');
    if (btn) bindOnce(btn);
  }

  // Patch updateToday so that every re-render rebinds the button
  function patchUpdateToday() {
    if (typeof window.updateToday === 'function' && !window.updateToday.__patchedFinishNext) {
      const _u = window.updateToday;
      window.updateToday = function () {
        const r = _u.apply(this, arguments);
        // rebind after DOM updates
        setTimeout(tryBind, 0);
        return r;
      };
      window.updateToday.__patchedFinishNext = true;
      // also bind now in case the button already exists
      setTimeout(tryBind, 0);
      return true;
    }
    return false;
  }

  // Start once DOM is ready
  function start() {
    // Attempt immediate bind
    tryBind();
    // Keep trying to patch updateToday until it exists (max 5s)
    const start = Date.now();
    const iv = setInterval(function () {
      if (patchUpdateToday() || Date.now() - start > 5000) {
        clearInterval(iv);
        // One last bind for safety
        setTimeout(tryBind, 50);
      }
    }, 100);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', start);
  } else {
    start();
  }
})();
</script>

<style>
  /* Minimal style for the previous-day button */
  #prevDayBtn {
    display: inline-flex;
    align-items: center;
    gap: .5rem;
    padding: .6rem .9rem;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.06);
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
    font-weight: 600;
    cursor: pointer;
    user-select: none;
    transition: transform .08s ease, background .2s ease, border-color .2s ease;
  }
  #prevDayBtn:hover { transform: translateY(-1px); }
  #prevDayBtn:active { transform: translateY(0); }
  #prevDayBtn[disabled] {
    opacity: .6;
    cursor: not-allowed;
    transform: none;
  }
</style>
<script>
(function () {
  function findPlanLength() {
    if (typeof PLAN_30 !== 'undefined' && PLAN_30 && PLAN_30.length) return PLAN_30.length;
    if (typeof PLAN !== 'undefined' && PLAN && PLAN.length) return PLAN.length;
    return 30;
  }

  function ensurePrevButton() {
    // Try to place it next to the existing finishNextBtn
    let btn = document.getElementById('prevDayBtn');
    if (btn) return btn;

    const nextBtn = document.getElementById('finishNextBtn') || document.querySelector('[data-action="finish-next"]');
    if (nextBtn && nextBtn.parentElement) {
      btn = document.createElement('button');
      // prevDay injected via HTML; keeping legacy code guarded
if(!document.getElementById('prevDayBtn')){
\1
}
 // place before next
    } else {
      // Fallback: floating button at bottom-left
      btn = document.createElement('button');
      btn.id = 'prevDayBtn';
      btn.type = 'button';
      btn.innerHTML = '⟵ Jour précédent';
      btn.style.position = 'fixed';
      btn.style.left = '16px';
      btn.style.bottom = '16px';
      btn.style.zIndex = 9999;
      document.body.appendChild(btn);
    }
    return btn;
  }

  function goToPrevDay() {
  try {
    const max = (typeof PLAN_30 !== 'undefined' && PLAN_30 && PLAN_30.length) ? PLAN_30.length
              : (typeof PLAN !== 'undefined' && PLAN && PLAN.length) ? PLAN.length
              : 30;
    if (typeof window.state !== 'object') window.state = {};
    if (typeof state.currentDay !== 'number') state.currentDay = 1;
    // wrap-around: 1 -> max
    state.currentDay = (state.currentDay > 1) ? (state.currentDay - 1) : max;
    state.currentRound = 1;
    if (typeof persist === 'function') persist();
    if (typeof updateToday === 'function') updateToday();
    if (typeof activateTab === 'function') activateTab('today','tabTodayBtn');
  } catch (e) {
    console.warn('goToPrevDay failed:', e);
  }
}
function setPrevDisabled() {
  const btn = document.getElementById('prevDayBtn');
  if (!btn) return;
  // With wrap-around enabled, the previous button is never disabled
  btn.disabled = false;
}

  function bindPrev() {
    const btn = ensurePrevButton();
    if (!btn || btn.__boundPrev) return;
    btn.__boundPrev = true;
    btn.addEventListener('click', goToPrevDay);
  }

  function patchUpdateTodayPrev() {
    if (typeof window.updateToday === 'function' && !window.updateToday.__patchedPrevDay) {
      const _u = window.updateToday;
      window.updateToday = function () {
        const r = _u.apply(this, arguments);
        setTimeout(function(){
          bindPrev();
          setPrevDisabled();
        }, 0);
        return r;
      };
      window.updateToday.__patchedPrevDay = true;
      // Initial bind (if the button already exists after first render)
      setTimeout(function(){
        bindPrev();
        setPrevDisabled();
      }, 0);
      return true;
    }
    return false;
  }

  function startPrev() {
    // First try
    bindPrev();
    setPrevDisabled();
    // Keep trying to patch updateToday until it exists (up to 5s)
    const start = Date.now();
    const iv = setInterval(function () {
      if (patchUpdateTodayPrev() || Date.now() - start > 5000) {
        clearInterval(iv);
        setTimeout(function(){
          bindPrev();
          setPrevDisabled();
        }, 50);
      }
    }, 100);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', startPrev);
  } else {
    startPrev();
  }
})();
</script>

<script>
// Robust click binding for prev-day button (works across re-renders)
</script>

<script id="prev-day-fix">
(function(){
  function getMaxDay(){
    try{
      if (typeof window.PLAN_30 !== "undefined" && window.PLAN_30 && window.PLAN_30.length) return window.PLAN_30.length;
      if (typeof window.PLAN !== "undefined" && window.PLAN && window.PLAN.length) return window.PLAN.length;
    }catch(e){}
    return 30;
  }
  function getCurrentDay(){
    try{
      if (typeof window.state === "object" && typeof window.state.currentDay === "number") return window.state.currentDay;
      var t = document.getElementById("todayTitle");
      if (t && t.textContent){
        var m = t.textContent.match(/Jour\s+(\d+)/i);
        if (m) return parseInt(m[1],10);
      }
    }catch(e){}
    return 1;
  }
  function setCurrentDay(n){
    if (typeof window.state !== "object") window.state = {};
    window.state.currentDay = n;
    try{ if (typeof window.persist === "function") window.persist(); }catch(e){}
    try{ if (typeof window.updateToday === "function") window.updateToday(); }catch(e){}
    try{ if (typeof window.activateTab === "function") window.activateTab('today','tabTodayBtn'); }catch(e){}
  }
  function goPrev(){
    var max = getMaxDay();
    var d = getCurrentDay();
    d = (d > 1) ? (d - 1) : max; // wrap to last
    setCurrentDay(d);
  }
  // Expose as the official handler (overrides any earlier definition)
  window.goToPrevDay = goPrev;

  function bind(){
    var btn = document.getElementById('prevDayBtn');
    if (!btn) return;
    if (!btn.__prevFixBound){
      btn.type = 'button';
      btn.removeAttribute('disabled');
      btn.addEventListener('click', function(ev){
        ev.preventDefault(); ev.stopPropagation();
        goPrev();
      });
      btn.__prevFixBound = true;
    }
  }
  // bind now and re-bind on DOM changes (in case header is re-rendered)
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', bind, {once:true});
  } else {
    bind();
  }
  new MutationObserver(function(){ bind(); }).observe(document.documentElement, {childList:true, subtree:true});
})();
</script>

<style>
  /* ========= Mobile App Transitions & Haptics Helpers ========= */
  :root{
    --tap-scale: .98;
    --elev: 0 6px 18px rgba(0,0,0,.25);
    --elev-soft: 0 2px 10px rgba(0,0,0,.18);
    --accent: #ffd34f;
  }
  *{ -webkit-tap-highlight-color: transparent; }
  .pressable{
    transition: transform .12s ease, box-shadow .2s ease, background-color .2s ease, opacity .2s ease;
    will-change: transform;
  }
  .pressable:active{ transform: scale(var(--tap-scale)); }
  .card-smooth{ box-shadow: var(--elev-soft); border-radius: 16px; }
  .lift:hover{ box-shadow: var(--elev); transform: translateY(-1px); }
  .tap-ripple{
    position: absolute; border-radius: 999px; pointer-events: none;
    transform: translate(-50%,-50%); opacity: .25; background: currentColor;
    width: 10px;height: 10px; animation: ripple .45s ease-out forwards;
    mix-blend-mode: screen;
  }
  @keyframes ripple{
    from { opacity:.25; transform: translate(-50%,-50%) scale(1); }
    to   { opacity:0;   transform: translate(-50%,-50%) scale(22); }
  }
  .view-enter{ opacity: 0; transform: translateY(8px); }
  .view-enter.view-enter-active{ opacity:1; transform:none; transition: opacity .22s ease, transform .22s ease; }
  .fade-in{ animation: fadein .24s ease both; }
  @keyframes fadein{ from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:none} }
  :focus-visible{ outline: 2px solid var(--accent); outline-offset: 2px; border-radius: 10px; }
  .btn,.button,.icon-btn,[role="button"]{
    position: relative;
    border-radius: 12px;
    touch-action: manipulation;
  }
  @media (prefers-reduced-motion: reduce){
    .pressable,.lift,.fade-in,.view-enter{ transition: none !important; animation: none !important; }
    .tap-ripple{ display:none !important; }
  }
</style>

<script>
(function(){

  // Disable all UI/menu sounds
  try{  }catch(_){}

  function makePressable(el){
    if(el.__pressableBound) return; el.__pressableBound = true;
    el.classList.add('pressable');
    el.addEventListener('pointerenter', e=>{
      if(el.hasAttribute('disabled') || el.getAttribute('aria-disabled')==='true') return;

    }, {passive:true});
    el.addEventListener('click', e=>{
      if(el.hasAttribute('disabled') || el.getAttribute('aria-disabled')==='true'){  return; }

      const rect = el.getBoundingClientRect();
      const x = (e.clientX|| (rect.left+rect.width/2)) - rect.left;
      const y = (e.clientY|| (rect.top+rect.height/2)) - rect.top;
      const rp = document.createElement('span');
      rp.className = 'tap-ripple';
      rp.style.left = x + 'px';
      rp.style.top  = y + 'px';
      rp.style.color = getComputedStyle(el).color;
      el.style.position = getComputedStyle(el).position === 'static' ? 'relative' : getComputedStyle(el).position;
      el.appendChild(rp);
      setTimeout(()=> rp.remove(), 480);
    }, {passive:true});
  }
  function autoBindButtons(){
    const candidates = Array.from(document.querySelectorAll(
      'button, .btn, .button, .icon-btn, [role=\"button\"], a[href], [data-action], [data-sound]'
    ));
    candidates.forEach(makePressable);
    candidates.forEach(el=>{
      const label = (el.getAttribute('aria-label') || el.innerText || '').toLowerCase();
      const idc = (el.id || '' ) + ' ' + (el.className || '');
      const isNext = /suivant|next|>|jour suivant/.test(label+idc);
      const isPrev = /précédent|precedent|prev|<|jour précédent/.test(label+idc);
      const isStart = /lancer|start|démarrer|demarrer|go|play/.test(label+idc);
      const isStop  = /stop|terminer|fin|end|arrêter|arreter/.test(label+idc);
      const isPause = /pause/.test(label+idc);
      const isResume= /reprendre|resume|continuer/.test(label+idc);
      const isValidate = /valider|ok|save|enregistrer|confirm/.test(label+idc);
      const isDelete   = /supprimer|delete|remove|trash/.test(label+idc);
      el.addEventListener('click', ()=>{
        if(isNext || isPrev)
        if(isStart)
        if(isStop)
        if(isPause)
        if(isResume)
        if(isValidate)
        if(isDelete)
      }, {passive:true});
    });
  }
  function bindTimerObserver(){
    const targets = Array.from(document.querySelectorAll('[id*=\"timer\"], .timer, [data-timer]'));
    targets.forEach(el=>{
      let lastText = el.textContent.trim();
      const obs = new MutationObserver(()=>{
        const t = el.textContent.trim();
        if (t !== lastText){
          lastText = t;
          if (/^\\d{1,3}(:\\d{2})?$/.test(t))
          if (t === '0' || t === '00:00' || t === '0:00')
        }
      });
      obs.observe(el, {childList:true, characterData:true, subtree:true});
    });
  }
  function screenTransition(){
    document.body.classList.add('view-enter');
    requestAnimationFrame(()=>{ document.body.classList.add('view-enter-active'); });
    window.addEventListener('hashchange', ()=>{

      document.body.classList.remove('view-enter','view-enter-active');
      void document.body.offsetWidth;
      document.body.classList.add('view-enter');
      requestAnimationFrame(()=> document.body.classList.add('view-enter-active'));
    });
    document.addEventListener('visibilitychange', ()=>{
      if(document.visibilityState === 'visible'){  }
    });
  }
  function injectSfxTuner(){
    const panel = document.createElement('div');
    panel.style.position='fixed'; panel.style.bottom='14px'; panel.style.right='14px';
    panel.style.background='rgba(20,22,28,.88)'; panel.style.backdropFilter='blur(6px)';
    panel.style.border='1px solid rgba(255,255,255,.06)'; panel.style.borderRadius='14px';
    panel.style.padding='10px 12px'; panel.style.zIndex='9999'; panel.style.color='#fff';
    panel.style.font='14px system-ui, -apple-system, Segoe UI, Roboto, sans-serif';
    panel.style.boxShadow='0 6px 18px rgba(0,0,0,.25)';
    panel.className='card-smooth pressable';
    panel.innerHTML = `
      <div style="display:flex;align-items:center;gap:10px;">
        <strong style="font-size:13px;opacity:.9">Audio</strong>
        <input id="sfxVol" type="range" min="0" max="1" step="0.01" value="${SFX.volume}" style="width:110px">
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
          <input id="sfxOn" type="checkbox" checked>
          <span style="opacity:.9">On</span>
        </label>
        <label style="display:flex;align-items:center;gap:6px;cursor:pointer">
          <input id="haptOn" type="checkbox" checked>
          <span style="opacity:.9">Haptique</span>
        </label>
        <button id="sfxTest" class="btn" style="margin-left:6px;padding:6px 10px;border-radius:10px;border:none;background:#2a2f3a;color:#fff;">Test</button>
      </div>`;
    document.body.appendChild(panel);
    const vol = panel.querySelector('#sfxVol');
    const on  = panel.querySelector('#sfxOn');
    const hap = panel.querySelector('#haptOn');
    const test= panel.querySelector('#sfxTest');
    const saved = JSON.parse(localStorage.getItem('sfx-prefs')||'{}');
    if(saved.volume != null){ vol.value = saved.volume;  }
    if(saved.enabled != null){ on.checked = saved.enabled;  }
    if(saved.haptics != null){ hap.checked = saved.haptics;  }
    const sync = ()=> localStorage.setItem('sfx-prefs', JSON.stringify({volume: +vol.value, enabled: on.checked, haptics: hap.checked}));
    vol.addEventListener('input', ()=>{  sync(); }, {passive:true});
    on.addEventListener('change', ()=>{  sync(); }, {passive:true});
    hap.addEventListener('change',()=>{  sync(); }, {passive:true});
    test.addEventListener('click', ()=>{  }, {passive:true});
  }
  const aliases = { 'timer-tick':'tick', 'timer-complete':'complete', 'validation':'success' };
  const _origTrigger = SFX.trigger.bind(SFX);
  SFX.trigger = (name)=>{ if(aliases[name]) name = aliases[name]; _origTrigger(name); };

  function boot(){
    screenTransition();
    autoBindButtons();
    bindTimerObserver();
    injectSfxTuner();
    document.querySelectorAll('button,.btn,.button,[role="button"]').forEach(el=> el.classList.add('pressable'));
    document.querySelectorAll('main,section,.screen,.view').forEach(el=> el.classList.add('fade-in'));
  }
  if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', boot, {once:true});
  else boot();
})();
</script>

<script>
(function(){
  // Helper
  const $ = (sel, ctx=document) => ctx.querySelector(sel);
  const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));

  // ---------- Prev / Next Day helpers ----------
  function getPlanMax(){
    try{
      if (typeof window.PLAN_30 !== 'undefined' && PLAN_30 && PLAN_30.length) return PLAN_30.length;
      if (typeof window.PLAN !== 'undefined' && PLAN && PLAN.length) return PLAN.length;
    }catch(e){}
    return 30;
  }
  function getDay(){
    if (typeof window.state==='object' && typeof state.currentDay==='number') return state.currentDay;
    const t = $('#todayTitle'); if(t){ const m = t.textContent.match(/Jour\s+(\d+)/i); if(m) return parseInt(m[1],10); }
    return 1;
  }
  function setDay(n){
    if (typeof window.state!=='object') window.state = {};
    state.currentDay = n;
    try{ persist && persist(); }catch(_e){}
    try{ typeof updateToday==='function' && updateToday(); }catch(_e){}
    try{ typeof activateTab==='function' && activateTab('today','tabTodayBtn'); }catch(_e){}
  }
  function goPrev(){ const max=getPlanMax(); const d=getDay(); setDay(d>1?d-1:max); }
  function goNext(){ const max=getPlanMax(); const d=getDay(); setDay(d<max?d+1:1); }
  window.goToPrevDay = goPrev; // expose

  // ---------- Finish & Next: ensure calendar mark + move day ----------
  function finishAndNext(){
    try {
      const now = new Date(); const y=now.getFullYear(), m=now.getMonth()+1, d=now.getDate();
      const key = `d${y}-${m}-${d}`; // matches calendar format
      state.calendar = state.calendar || {};
      const already = state.calendar[key] === 'done';
      state.calendar[key] = 'done';
      state.totals = state.totals || {};
      if(!already){
        state.totals.sessions = (state.totals.sessions||0)+1;
        state.totals.streak = (state.totals.streak||0)+1;
      }
      if (typeof addHistory === 'function') addHistory('today');
      persist && persist();
      typeof buildCalendar==='function' && buildCalendar();
      typeof updateStats==='function' && updateStats();
      goNext();
    } catch(e){ console.warn('finishAndNext error', e); }
  }

  // ---------- Bindings (robust & re-entrant) ----------
  function bindCore(){
    const prev = $('#prevDayBtn'); if(prev && !prev.__bound){ prev.__bound=true; prev.type='button'; prev.addEventListener('click', (ev)=>{ ev.preventDefault(); goPrev(); }); }
    const next = $('#nextDayBtn'); if(next && !next.__bound){ next.__bound=true; next.addEventListener('click', (ev)=>{ ev.preventDefault(); goNext(); }); }
    const finx = $('#finishNextBtn'); if(finx && !finx.__bound){ finx.__bound=true; finx.addEventListener('click', (ev)=>{ ev.preventDefault(); finishAndNext(); }); }
    const fin = $('#finishBtn'); if(fin && !fin.__bound){ fin.__bound=true; fin.addEventListener('click', (ev)=>{ ev.preventDefault(); finishAndNext(); }); }
    // Round navigation if present
    const pr = $('#prevRound'); if(pr && !pr.__bound){ pr.__bound=true; pr.addEventListener('click', (e)=>{ e.preventDefault(); if(typeof state.currentRound!=='number') state.currentRound=1; state.currentRound=Math.max(1,state.currentRound-1); persist&&persist(); typeof updateToday==='function'&&updateToday(); }); }
    const nr = $('#nextRound'); if(nr && !nr.__bound){ nr.__bound=true; nr.addEventListener('click', (e)=>{ e.preventDefault(); if(typeof state.currentRound!=='number') state.currentRound=1; state.currentRound=Math.min(5,state.currentRound+1); persist&&persist(); typeof updateToday==='function'&&updateToday(); }); }
  }

  // Patch updateToday so we re-bind after each render
  function patchUpdate(){
    if (typeof window.updateToday === 'function' && !window.updateToday.__patchedAll){
      const _u = window.updateToday;
      window.updateToday = function(){
        const r = _u.apply(this, arguments);
        setTimeout(bindCore, 0);
        return r;
      };
      window.updateToday.__patchedAll = true;
    }
  }

  // Tab navigation delegate (if project forgot to bind)
  document.addEventListener('click', function(e){
    const tab = e.target.closest && e.target.closest('.tabs .tab[role="tab"]');
    if(!tab) return;
    const id = tab.getAttribute('aria-controls'); if(!id) return;
    e.preventDefault();
    $$('.tabs .tab').forEach(b=>{ b.classList.toggle('active', b===tab); b.setAttribute('aria-selected', b===tab?'true':'false'); });
    $$('main > section[role="region"]').forEach(sec=> sec.classList.toggle('active', sec.id===id));
    try{ typeof SFX!=='undefined' &&  }catch(_e){}
  }, true);

  // Initial & subsequent binds
  function start(){
    bindCore(); patchUpdate();
    // Observe DOM mutations to rebind when header/content re-renders
    new MutationObserver(()=>{ bindCore(); }).observe(document.body, {childList:true, subtree:true});
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', start, {once:true});
  else start();
})();
</script>

<style>
  /* Hide common bottom bars if present */
  .bottom-bar, .footer-actions, #bottomActions, .sticky-bottom, .fixed-bottom {
    display: none !important;
  }
</style>
<script>
(function(){
  const $ = (sel, ctx=document) => ctx.querySelector(sel);
  const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));
  let navLock = false;
  function lock(ms=220){ navLock = true; setTimeout(()=> navLock=false, ms); }

  function getMax(){
    try{
      if (typeof window.PLAN_30 !== 'undefined' && PLAN_30 && PLAN_30.length) return PLAN_30.length;
      if (typeof window.PLAN !== 'undefined' && PLAN && PLAN.length) return PLAN.length;
    }catch(e){}
    return 30;
  }
  function getDay(){
    if (typeof window.state==='object' && typeof state.currentDay==='number') return state.currentDay;
    const t = document.querySelector('#todayTitle'); if(t){ const m=t.textContent.match(/Jour\s+(\d+)/i); if(m) return parseInt(m[1],10); }
    return 1;
  }
  function setDaySafe(n){
    if (typeof window.state!=='object') window.state = {};
    const max = getMax();
    const d = ((n-1+max)%max)+1; // 1..max wrap
    state.currentDay = d;
    try{ typeof persist==='function' && persist(); }catch(e){}
    try{ typeof updateToday==='function' && updateToday(); }catch(e){}
  }
  function rebindStrict(){
    const prevCandidates = $$('button, .btn, [role="button"], a').filter(el=>/précédent|precedent/i.test((el.innerText||el.ariaLabel||'') + ' ' + (el.id||'') + ' ' + (el.className||'')));
    const nextCandidates = $$('button, .btn, [role="button"], a').filter(el=>/suivant/i.test((el.innerText||el.ariaLabel||'') + ' ' + (el.id||'') + ' ' + (el.className||'')));

    const bindOne = (el, dir) => {
      if (el.__navBoundStrict) return;
      el.__navBoundStrict = true;
      el.addEventListener('click', (e)=>{
        // hard-stop other handlers to avoid double increments
        e.preventDefault(); e.stopImmediatePropagation(); e.stopPropagation();
        if (navLock) return;
        const cur = getDay();
        const max = getMax();
        const next = dir==='prev' ? (cur===1?max:cur-1) : (cur===max?max:cur+1);
        setDaySafe(next);
        try{ if (window.SFX)  }catch(_){}
        lock();
      }, true);
    };

    prevCandidates.forEach(el=>bindOne(el,'prev'));
    nextCandidates.forEach(el=>bindOne(el,'next'));
  }

  function hideBottomBigButtons(){
    // Hide by text content
    const texts = [/^jour\s+suivant/i, /^jour\s+pr(é|e)c(é|e)dent/i, /^terminer\s+s(é|e)ance/i, /^terminer\b/i];
    $$('button, .btn, [role="button"], a').forEach(el=>{
      const t = (el.innerText||'').trim().toLowerCase();
      if (texts.some(rx=>rx.test(t))) {
        // If it's visually the large one (wide or fixed), hide it
        const rect = el.getBoundingClientRect();
        if (rect.width > 220 || rect.height > 44) {
          el.style.display = 'none';
          el.removeAttribute('id'); // prevent other code from trying to rebind it
        }
      }
    });
    // Also hide known containers
    ['#bottomActions', '.bottom-bar', '.footer-actions', '.sticky-bottom', '.fixed-bottom'].forEach(sel=>{
      document.querySelectorAll(sel).forEach(el=> el.style.display='none');
    });
  }

  function start(){
    rebindStrict();
    hideBottomBigButtons();
    new MutationObserver(()=>{ rebindStrict(); hideBottomBigButtons(); }).observe(document.body, {childList:true, subtree:true});
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', start, {once:true});
  else start();
})();
</script>

<script>
(function(){
  const moveAudioPanel = () => {
    const panel = document.querySelector('#audioPanel, .audio-panel, .sfx-panel');
    const settingsTab = document.querySelector('#tab-settings, #settingsTab, section#settings, main section[aria-label*="Param"], main section[aria-label*="param"]');
    if(panel && settingsTab){
      settingsTab.appendChild(panel);
    } else if (panel) {
      panel.style.display = 'none';
    }
  };
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', moveAudioPanel, {once:true});
  else moveAudioPanel();
})();
</script>

<script>
(function(){
  const $ = (sel, ctx=document) => ctx.querySelector(sel);
  const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));
  let navLock = false;
  function lock(ms=250){ navLock = true; setTimeout(()=> navLock=false, ms); }
  function getMax(){
    try{
      if (typeof window.PLAN_30 !== 'undefined' && PLAN_30 && PLAN_30.length) return PLAN_30.length;
      if (typeof window.PLAN !== 'undefined' && PLAN && PLAN.length) return PLAN.length;
    }catch(e){}
    return 30;
  }
  function getDay(){
    if (typeof window.state==='object' && typeof state.currentDay==='number') return state.currentDay;
    const t = document.querySelector('#todayTitle'); if(t){ const m=t.textContent.match(/Jour\s+(\d+)/i); if(m) return parseInt(m[1],10); }
    return 1;
  }
  function setDaySafe(n){
    if (typeof window.state!=='object') window.state = {};
    const max = getMax();
    let d = n;
    if (d < 1) d = max;
    if (d > max) d = max;
    state.currentDay = d;
    try{ typeof persist==='function' && persist(); }catch(e){}
    try{ typeof updateToday==='function' && updateToday(); }catch(e){}
  }
  function rebindNav(){
    const prevButtons = $$('button, .btn, [role="button"], a').filter(el=>/pr(é|e)c(é|e)dent/i.test((el.innerText||el.ariaLabel||'') + ' ' + (el.id||'') + ' ' + (el.className||'')));
    const nextButtons = $$('button, .btn, [role="button"], a').filter(el=>/suivant/i.test((el.innerText||el.ariaLabel||'') + ' ' + (el.id||'') + ' ' + (el.className||'')));
    const bindOne = (el, dir) => {
      if (el.__boundFinal) return;
      el.__boundFinal = true;
      el.addEventListener('click', (e)=>{
        e.preventDefault(); e.stopImmediatePropagation(); e.stopPropagation();
        if (navLock) return;
        const cur = getDay();
        const max = getMax();
        const newDay = dir==='prev' ? (cur===1?max:cur-1) : (cur===max?max:cur+1);
        setDaySafe(newDay);
        try{ if (window.SFX)  }catch(_){}
        lock();
      }, true);
    };
    prevButtons.forEach(b=>bindOne(b,'prev'));
    nextButtons.forEach(b=>bindOne(b,'next'));
  }
  function start(){
    rebindNav();
    new MutationObserver(()=>{ rebindNav(); }).observe(document.body,{childList:true,subtree:true});
  }
  if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', start, {once:true});
  else start();
})();
</script>

<script>
(function(){
  const $  = (s,ctx=document)=>ctx.querySelector(s);
  const $$ = (s,ctx=document)=>Array.from(ctx.querySelectorAll(s));

  // ---------- Guard helpers ----------
  function safe(fn){ return function(){ try{ return fn.apply(this, arguments);}catch(e){ console.warn('[patch error]', e); } }; }
  function throttle(fn, ms){
    let t=0, pend=false;
    return function(){
      const now = Date.now();
      const args = arguments, ctx = this;
      if (now - t >= ms){ t = now; fn.apply(ctx,args); }
      else if (!pend){ pend = true; setTimeout(()=>{ pend=false; t=Date.now(); fn.apply(ctx,args); }, ms - (now - t)); }
    };
  }

  // ---------- Move/Hide Audio panel safely ----------
  const moveAudioPanel = safe(function(){
    const vol = document.querySelector('#sfxVol');
    if(!vol) return;
    const panel = vol.closest('div');
    if(!panel) return;
    panel.id = panel.id || 'audioPanel';
    const settings =
      $('#settings') || $('#settingsTab') || $('#tab-settings') ||
      $('section#settings') ||
      Array.from(document.querySelectorAll('section,main,div')).find(el=>{
        const a = (el.getAttribute('aria-label')||'') + ' ' + (el.id||'') + ' ' + (el.className||'');
        return /param|réglage|reglage|settings/i.test(a);
      });
    if (settings){
      Object.assign(panel.style, { position:'relative', right:'auto', bottom:'auto', margin:'14px 0' });
      settings.appendChild(panel);
    } else {
      panel.style.display = 'none';
    }
  });

  // ---------- Helpers for days ----------
  const getMax = safe(function(){
    try{
      if (typeof window.PLAN_30 !== 'undefined' && PLAN_30 && PLAN_30.length) return PLAN_30.length;
      if (typeof window.PLAN !== 'undefined' && PLAN && PLAN.length) return PLAN.length;
    }catch(e){}
    return 30;
  });

  const getDay = safe(function(){
    try{
      if (typeof window.state==='object' && typeof state.currentDay==='number') return state.currentDay;
    }catch(e){}
    const t = document.querySelector('#todayTitle');
    if(t){
      const m = (t.textContent||'').match(/Jour\s+(\d+)/i);
      if(m) return parseInt(m[1],10);
    }
    return 1;
  });

  const setDaySafe = safe(function(n){
    const max = getMax()||30;
    let d = parseInt(n,10);
    if (!isFinite(d)) return;
    if (d < 1) d = 1;      // pas de wrap en avant
    if (d > max) d = max;  // pas de wrap en avant
    if (typeof window.state!=='object') window.state = {};
    state.currentDay = d;
    try{ typeof persist==='function' && persist(); }catch(e){}
    try{ typeof updateToday==='function' && updateToday(); }catch(e){}
  });

  // ---------- Hide only the large bottom CTA buttons (by text + size) ----------
  const hideLargeBottomButtons = safe(function(){
    const texts = [/^jour\s+suivant/i, /^jour\s+pr(é|e)c(é|e)dent/i, /^terminer\s+s(é|e)ance/i, /^terminer\b/i];
    $$('button, .btn, [role="button"], a').forEach(el=>{
      const t = (el.innerText||'').trim().toLowerCase();
      const rect = el.getBoundingClientRect ? el.getBoundingClientRect() : {width:0,height:0,top:0};
      const nearBottom = (window.innerHeight - rect.top) < 180; // dans la zone basse
      const large = rect.width > 220 || rect.height > 44;
      if (texts.some(rx=>rx.test(t)) && (large || nearBottom)){
        el.style.display = 'none';
      }
    });
  });

  // ---------- Corrector for prev/next (measure then correct) ----------
  const bindNavCorrector = safe(function(){
    const isPrev = (el) => /pr(é|e)c(é|e)dent/i.test(((el.innerText||el.ariaLabel||'') + ' ' + (el.id||'') + ' ' + (el.className||'')).toLowerCase());
    const isNext = (el) => /suivant/i.test(((el.innerText||el.ariaLabel||'') + ' ' + (el.id||'') + ' ' + (el.className||'')).toLowerCase());
    const candidates = $$('button, .btn, [role="button"], a[href], [data-action]');
    candidates.forEach(el=>{
      if (el.__navCorrectorBound) return;
      if (!isPrev(el) && !isNext(el)) return;
      el.__navCorrectorBound = true;
      const dir = isPrev(el) ? -1 : +1;
      el.addEventListener('click', safe(()=>{
        const before = getDay()||1;
        setTimeout(safe(()=>{
          const after = getDay()||before;
          const max = getMax()||30;
          let delta = after - before;
          if (delta >  max/2) delta -= max;
          if (delta < -max/2) delta += max;
          if (delta === dir) return;
          let target = before + dir;
          if (target < 1) target = 1;     // no wrap forward
          if (target > max) target = max; // no wrap forward
          setDaySafe(target);
        }), 50);
      }), {passive:true});
    });
  });

  // ---------- Boot with throttled observer ----------
  const refresh = throttle(function(){
    moveAudioPanel();
    hideLargeBottomButtons();
    bindNavCorrector();
  }, 200);

  function start(){
    refresh();
    const obs = new MutationObserver(refresh);
    obs.observe(document.body, {childList:true, subtree:true});
  }

  if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', start, {once:true});
  else start();
})();
</script>

<script>
// ===== FINAL PATCH: Fix day vs round navigation =====
(function(){
  function ready(fn){ if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', fn, {once:true}); else fn(); }
  ready(function(){
    // 1) Disable any auto day-navigation rebinders
    try{ window.rebindNav = function(){}; }catch{}
    // Helper: replace node to drop old listeners, then bind our own
    function rebindClickById(id, handler){
      var el = document.getElementById(id);
      if(!el) return null;
      var clone = el.cloneNode(true);
      el.replaceWith(clone);
      clone.addEventListener('click', function(e){
        e.preventDefault(); e.stopImmediatePropagation(); e.stopPropagation();
        try{ handler(e); }catch(_){}
      }, {passive:false});
      return clone;
    }
    function getMax(){ try{ if (typeof window.PLAN_30!=='undefined' && PLAN_30 && PLAN_30.length) return PLAN_30.length; }catch(e){} return 30; }
    function getDay(){ try{ return (typeof window.state==='object' && typeof state.currentDay==='number') ? state.currentDay : 1; }catch(e){ return 1; } }
    function setDaySafe(n){
      try{
        if (typeof window.state!=='object') window.state = {};
        var max = getMax(); var d = n;
        if (d < 1) d = 1;
        if (d > max) d = max;
        state.currentDay = d;
        if (typeof persist==='function') try{ persist(); }catch(_){}
        if (typeof updateToday==='function') try{ updateToday(); }catch(_){}
      }catch(_){}
    }
    function getRoundsForDay(day){
      try{
        var d = (typeof getDayData==='function') ? getDayData(day) : null;
        if (!d) return 3;
        return d.rounds || (d.day<=15 ? 3 : 4);
      }catch(_){ return 3; }
    }
    // 2) Day buttons
    rebindClickById('nextDayBtn', function(){
      var cur = getDay(), max = getMax();
      var next = (cur >= max) ? max : (cur + 1);
      setDaySafe(next);
    });
    rebindClickById('prevDayBtn', function(){
      var cur = getDay();
      var prev = (cur <= 1) ? 1 : (cur - 1);
      setDaySafe(prev);
    });
    rebindClickById('finishNextBtn', function(){
      // Prefer built-in finish flow if available
      try{ if (typeof finishAndNext==='function'){ finishAndNext(); return; } }catch(_){}
      var cur = getDay(), max = getMax();
      var next = (cur >= max) ? max : (cur + 1);
      setDaySafe(next);
    });
    // 3) Round buttons (Manche)
    function bindRound(id, delta){
      var el = document.getElementById(id);
      if (!el) return;
      var clone = el.cloneNode(true);
      el.replaceWith(clone);
      clone.addEventListener('click', function(e){
        e.preventDefault(); e.stopImmediatePropagation(); e.stopPropagation();
        try{
          if (typeof window.state!=='object') window.state = {};
          var d = getDay();
          var maxR = getRoundsForDay(d);
          var curR = Math.max(1, Math.min(state.currentRound||1, maxR));
          curR += delta;
          if (curR < 1) curR = 1;
          if (curR > maxR) curR = maxR;
          state.currentRound = curR;
          if (typeof persist==='function') try{ persist(); }catch(_){}
          if (typeof updateToday==='function') try{ updateToday(); }catch(_){}
        }catch(_){}
      }, {passive:false});
    }
    bindRound('prevRound', -1);
    bindRound('nextRound', +1);
  });
})();
</script>

<script>
(function(){
  // ===== Achievements config (push-ups/pompes based) =====
  const ACHIEVEMENTS = [
    { key:'pompes', icon:'💪', name:'Pompes', tiers:[
      {tier:'bronze', threshold:500},
      {tier:'silver', threshold:1000},
      {tier:'gold', threshold:2500},
      {tier:'platinum', threshold:5000}
    ]},
    { key:'squats', icon:'🦵', name:'Squats', tiers:[
      {tier:'bronze', threshold:500},
      {tier:'silver', threshold:1200},
      {tier:'gold', threshold:3000},
      {tier:'platinum', threshold:6000}
    ]},
    { key:'tractions', icon:'🧗', name:'Tractions', tiers:[
      {tier:'bronze', threshold:200},
      {tier:'silver', threshold:500},
      {tier:'gold', threshold:1200},
      {tier:'platinum', threshold:2500}
    ]},
    { key:'dips', icon:'🏋️', name:'Dips', tiers:[
      {tier:'bronze', threshold:300},
      {tier:'silver', threshold:800},
      {tier:'gold', threshold:1800},
      {tier:'platinum', threshold:3500}
    ]}
  ];

  const NAME_MAP = {
    'pompes':'pompes','pompe':'pompes','push-up':'pompes','push ups':'pompes',
    'squats':'squats','squat':'squats',
    'tractions':'tractions','traction':'tractions','pull-up':'tractions','pull ups':'tractions',
    'dips':'dips','dip':'dips'
  };
  function normalizeName(n){ const k=(''+(n||'')).toLowerCase().trim(); return NAME_MAP[k]||null; }
  function getState(){ try{ return window.state || (window.state={}); }catch(e){ return {}; } }

  function computeTotals(){
    const s = getState(); const totals = { pompes:0, squats:0, tractions:0, dips:0 };
    try{
      const log = s.repsLog || {};
      Object.keys(log).forEach(k=>{
        const reps = +log[k] || 0;
        const parts = k.split(':');
        if(parts.length<3) return;
        const day = parseInt(parts[0],10);
        const idx = parseInt(parts[2],10);
        if (!Number.isFinite(day) || !Number.isFinite(idx)) return;
        let d = null; try{ d = (typeof getDayData==='function') ? getDayData(day) : null; }catch(_){}
        if (!d || !d.items || !Array.isArray(d.items)) return;
        const item = d.items[idx];
        if (!item) return;
        const name = (Array.isArray(item)? item[0] : item && item.name) || '';
        const key = normalizeName(name);
        if (key && reps>0){ totals[key] = (totals[key]||0) + reps; }
      });
    }catch(_){}
    return totals;
  }

  function currentTier(tiers, value){
    let unlocked = null, next = null, progress = 0;
    for (let i=0;i<tiers.length;i++){
      if (value >= tiers[i].threshold) { unlocked = tiers[i]; continue; }
      next = tiers[i]; break;
    }
    if (!next){ next = tiers[tiers.length-1]; progress = 1; }
    else {
      const prev = unlocked ? unlocked.threshold : 0;
      const span = next.threshold - prev;
      progress = Math.max(0, Math.min(1, (value - prev) / span));
    }
    return {unlocked, next, progress};
  }

  function ensureBadgesUI(){
    const wrap = document.getElementById('badgesList');
    if (!wrap) return null;
    if (!wrap.classList.contains('badge-grid')) wrap.classList.add('badge-grid');
    if (wrap.__built) return wrap;
    wrap.__built = true;
    wrap.innerHTML = '';
    ACHIEVEMENTS.forEach(a=>{
      const div = document.createElement('div');
      div.className = 'achv locked tier-bronze';
      div.id = 'achv-'+a.key;
      div.innerHTML = '<div class="icon">'+a.icon+'</div><div class="name">'+a.name+'</div><div class="tier">—</div><div class="bar"><i></i></div><span class="ring"></span>';
      wrap.appendChild(div);
    });
    return wrap;
  }

  function updateBadges(){
    const wrap = ensureBadgesUI(); if (!wrap) return;
    const totals = computeTotals();
    ACHIEVEMENTS.forEach(a=>{
      const value = totals[a.key]||0;
      const t = currentTier(a.tiers, value);
      const el = document.getElementById('achv-'+a.key); if (!el) return;
      const tierEl = el.querySelector('.tier');
      const bar = el.querySelector('.bar > i');
      bar.style.width = (t.progress*100).toFixed(1)+'%';
      let tierName = '—';
      el.classList.remove('tier-bronze','tier-silver','tier-gold','tier-platinum','unlocked','levelup');
      el.classList.add('locked');
      if (t.unlocked){
        tierName = t.unlocked.tier.charAt(0).toUpperCase() + t.unlocked.tier.slice(1);
        el.classList.add('tier-'+t.unlocked.tier, 'unlocked', 'levelup');
        el.classList.remove('locked');
      } else if (t.next){
        tierName = '→ ' + t.next.threshold;
      }
      tierEl.textContent = tierName + ' • ' + value + '/' + (t.next? t.next.threshold : a.tiers[a.tiers.length-1].threshold);
    });
  }

  function hook(){
    try{
      if (typeof window.updateToday === 'function' && !window.updateToday.__achv){
        const _u = window.updateToday;
        window.updateToday = function(){
          const r = _u.apply(this, arguments);
          setTimeout(updateBadges, 0);
          return r;
        };
        window.updateToday.__achv = true;
      } else {
        setTimeout(updateBadges, 0);
      }
    }catch(_){ setTimeout(updateBadges, 0); }
  }
  if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', hook, {once:true}); else hook();
  window.__updateBadges = updateBadges;
  window.__computeTotals = computeTotals;
})();
</script>

</body></html>