<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#0b0d12">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <title>CalisFit ¬∑ Programme & Chronos</title>
  <style>
    /* ---- Reset / iOS-friendly base ---- */
    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", Inter, Roboto, Segoe UI, system-ui, Avenir, Helvetica, Arial, sans-serif; background:#0b0d12; color:#e8ecf1; }
    button { font: inherit; }
    :root{
      --bg:#0b0d12;           /* page */
      --card:#121622;         /* cards */
      --muted:#a9b2c3;        /* secondary text */
      --accent:#ffd54a;       /* primary accent */
      --accent-2:#5eead4;     /* secondary accent */
      --danger:#ff6b6b;       /* errors */
      --ok:#4ade80;           /* success */
      --ring: 0 0 0 2px rgba(255,213,74,.35);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }
    .app{ position:relative; min-height:100%; padding-bottom: calc(74px + env(safe-area-inset-bottom)); }

    /* Header */
    .topbar{ position: sticky; top:0; z-index:10; padding: calc(10px + env(safe-area-inset-top)) 16px 10px; backdrop-filter: blur(8px); background: linear-gradient(180deg, rgba(11,13,18,.9), rgba(11,13,18,.5)); display:flex; align-items:center; gap:12px; border-bottom:1px solid rgba(255,255,255,.06); }
    .logo{ width:34px; height:34px; border-radius:10px; background: radial-gradient(120% 120% at 10% 10%, var(--accent) 0%, #ff8 40%, transparent 60%), linear-gradient(135deg, #141a2b, #0f1321); box-shadow: inset 0 0 0 1px rgba(255,255,255,.08), 0 8px 20px rgba(255,213,74,.25); }
    .hgroup{ line-height:1.1; }
    .title{ font-weight:700; font-size:18px; }
    .subtitle{ color:var(--muted); font-size:12px; }

    /* Tabs */
    .tabs{ position: fixed; bottom:0; left:0; right:0; height:74px; padding-bottom: calc(env(safe-area-inset-bottom)); background: rgba(10,12,18,.85); backdrop-filter: blur(10px); border-top:1px solid rgba(255,255,255,.06); display:grid; grid-template-columns: repeat(5,1fr); }
    .tab{ display:flex; flex-direction:column; align-items:center; justify-content:center; gap:6px; color:var(--muted); text-decoration:none; font-size:11px; }
    .tab.active{ color:#fff; }
    .tab .ico{ width:24px; height:24px; border-radius:9px; background: linear-gradient(135deg, #1a2032, #151a28); display:grid; place-items:center; box-shadow: inset 0 0 0 1px rgba(255,255,255,.06); }
    .tab.active .ico{ outline:var(--ring); box-shadow: inset 0 0 0 1px rgba(255,255,255,.1), 0 8px 18px rgba(255,213,74,.15); }

    /* Sections */
    section{ padding:14px 16px 18px; display:none; }
    section.active{ display:block; }

    /* Cards */
    .card{ background: linear-gradient(180deg, #0f1424, #0c1120); border:1px solid rgba(255,255,255,.06); border-radius: var(--radius); box-shadow: var(--shadow); padding:14px; }
    .grid{ display:grid; gap:14px; }
    .grid.two{ grid-template-columns: 1fr 1fr; }
    .grid.three{ grid-template-columns: repeat(3,1fr); }

    .badge{ display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.06); color:var(--muted); font-size:12px; }
    .chip{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:rgba(94,234,212,.08); color:#d6fff7; border:1px solid rgba(94,234,212,.2); font-size:12px; }

    .btn{ appearance:none; border:0; padding:12px 14px; border-radius:14px; background:#1a2236; color:#eaf1ff; box-shadow: inset 0 0 0 1px rgba(255,255,255,.08); display:inline-flex; align-items:center; gap:10px; cursor:pointer; }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{ background: linear-gradient(135deg, #1f2333, #1a1f2e); box-shadow: inset 0 0 0 1px rgba(255,255,255,.08), 0 10px 24px rgba(255,213,74,.15); }
    .btn.primary.active{ outline: var(--ring); }
    .btn.ghost{ background: transparent; box-shadow: inset 0 0 0 1px rgba(255,255,255,.15); }

    .row{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .muted{ color:var(--muted); }
    .h1{ font-size:22px; font-weight:800; }
    .h2{ font-size:16px; font-weight:700; }
    .label{ font-size:12px; color:var(--muted); }

    /* Workout list */
    .workout-item{ display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center; padding:10px; border-radius:14px; background: linear-gradient(180deg, #0f1424, #0c1120); border:1px solid rgba(255,255,255,.06); }
    .workout-item.done{ opacity:.6; }
    .pill{ font-size:11px; padding:6px 9px; border-radius:999px; background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.08); }
    .controls{ display:flex; align-items:center; gap:8px; }
    .counter{ display:flex; align-items:center; gap:6px; background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.08); padding:6px; border-radius:12px; }
    .counter button{ width:28px; height:28px; border-radius:10px; background:#192036; color:#fff; border:1px solid rgba(255,255,255,.08); }

    /* Timer */
    .timer{ display:grid; place-items:center; padding:14px; }
    .time{ font-size:42px; font-weight:800; letter-spacing:1px; }
    .timer .controls .btn{ min-width:86px; justify-content:center; }

    /* Calendar */
    .calendar{ display:grid; grid-template-columns: repeat(7, 1fr); gap:6px; }
    .day{ aspect-ratio: 1 / 1; display:grid; place-items:center; font-size:12px; color:var(--muted); border:1px dashed rgba(255,255,255,.08); border-radius:10px; }
    .day.done{ background: rgba(74,222,128,.15); color:#eafff3; border:1px solid rgba(74,222,128,.3); }
    .day.skipped{ background: rgba(255,107,107,.12); color:#ffeaea; border:1px solid rgba(255,107,107,.28); }

    /* iOS safe areas */
    .pad-safe{ padding-bottom: calc(env(safe-area-inset-bottom)); }

    /* iPhone 15 fit & responsive */
    html, body { overflow-x: hidden; -webkit-text-size-adjust: 100%; }
    .app { max-width: 393px; margin: 0 auto; min-height: 100vh; }
    @supports (height: 100svh) { .app { min-height: 100svh; } }
    @media (max-width: 430px) {
      .grid.two { grid-template-columns: 1fr; }
      .grid.three { grid-template-columns: 1fr; }
      .time { font-size: 36px; }
      .btn { padding: 11px 12px; border-radius: 12px; }
      .workout-item { grid-template-columns: 1fr; }
      .tab .ico { width: 22px; height: 22px; }
    }
    * { max-width: 100%; }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="logo" aria-hidden="true"></div>
      <div class="hgroup">
        <div class="title">CalisFit</div>
        <div class="subtitle">Programmes ¬∑ Chronos ¬∑ Reps ¬∑ Statistiques</div>
      </div>
      <div style="margin-left:auto" class="badge" id="todayBadge">Semaine 1 ‚Ä¢ Jour 1</div>
    </div>

    <!-- TODAY -->
    <section id="tab-today" class="active">
      <div class="grid">
        <div class="card">
          <div class="row">
            <div>
              <div class="label">Programme actif</div>
              <div class="h1" id="todayTitle">Jour 1 ¬∑ Full Body</div>
            </div>
            <button class="btn primary" id="startSessionBtn">‚ñ∂ Lancer</button>
          </div>
          <div class="label" style="margin-top:6px">3 cycles (semaines 1‚Äì4 r√©p√©t√©s sur 3 mois)</div>
        </div>

        <div class="card" id="workoutListCard">
          <div class="row" style="margin-bottom:8px">
            <div class="h2">S√©ance du jour</div>
            <div class="chip" id="roundChip">Manche 1/3</div>
          </div>
          <div class="grid" id="workoutList" style="gap:10px"></div>
          <div class="row pad-safe" style="margin-top:10px">
            <button class="btn" id="prevRound">‚üµ Manche</button>
            <button class="btn primary" id="nextRound">Manche suivante ‚ü∂</button>
          </div>
        </div>

        <div class="grid two">
          <div class="card">
            <div class="label">Repos</div>
            <div class="row" style="margin-top:6px; gap:10px">
              <button class="btn" data-rest="30">30s</button>
              <button class="btn" data-rest="60">60s</button>
              <button class="btn" data-rest="90">90s</button>
              <button class="btn" data-rest="180">3min</button>
            </div>
            <div class="timer"><div class="time" id="restDisplay">00:00</div>
              <div class="controls" style="margin-top:8px">
                <button class="btn" id="restStart">D√©marrer</button>
                <button class="btn ghost" id="restReset">R√©initialiser</button>
              </div>
            </div>
          </div>
          <div class="card">
            <div class="label">Chrono s√©ance</div>
            <div class="timer">
              <div class="time" id="swDisplay">00:00.0</div>
              <div class="controls" style="margin-top:8px">
                <button class="btn" id="swStart">D√©marrer</button>
                <button class="btn ghost" id="swLap">Tour</button>
                <button class="btn ghost" id="swReset">Remettre √† z√©ro</button>
              </div>
              <div class="label" id="swLaps" style="margin-top:6px"></div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="row"><div class="h2">Notes</div><button class="btn ghost" id="saveNotes">üíæ Enregistrer</button></div>
          <textarea id="notes" rows="3" style="width:100%; margin-top:8px; background:#0e1322; color:#eef4ff; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px"></textarea>
        </div>
      </div>
    </section>

    <!-- PROGRAMS -->
    <section id="tab-programs">
      <div class="grid">
        <div class="card">
          <div class="row">
            <div>
              <div class="label">Plan actif</div>
              <div class="h1">Calisthenics ‚Äì 30 jours (x3 cycles)</div>
            </div>
            <button class="btn" id="duplicate3m">G√©n√©rer 3 mois</button>
          </div>
          <div class="label">Chaque jour comporte 3 √† 4 manches (rounds). Les jours 4, 7, 11, 14, 18, 21, 25, 28 sont OFF.</div>
        </div>

        <div class="card">
          <div class="row" style="margin-bottom:6px"><div class="h2">Calendrier d'entra√Ænement</div>
            <div class="chip" id="streakChip">üî• S√©rie: 0</div>
          </div>
          <div class="calendar" id="calendar"></div>
        </div>

        <div class="card">
          <div class="row"><div class="h2">Importer / Exporter</div>
            <div class="controls">
              <button class="btn" id="exportData">Exporter JSON</button>
              <label class="btn" for="importFile">Importer JSON</label>
              <input id="importFile" type="file" accept="application/json" style="display:none" />
            </div>
          </div>
        </div>

        <div class="card">
          <div class="row" style="margin-bottom:8px"><div class="h2">Jours & exercices</div>
            <div class="badge" id="daysCount">30 jours</div></div>
          <div id="daysList" class="grid" style="grid-template-columns: repeat(1, 1fr);"></div>
        </div>
      </div>
    </section>

    <!-- TIMER -->
    <section id="tab-timer">
      <div class="grid">
        <div class="card">
          <div class="h2">Intervals (Tabata / EMOM)</div>
          <div class="grid two" style="margin-top:8px">
            <div>
              <div class="label">Travail (s)</div>
              <input id="intWork" type="number" min="5" value="20" style="width:100%; padding:10px; border-radius:12px; border:1px solid rgba(255,255,255,.1); background:#0e1322; color:#fff;" />
            </div>
            <div>
              <div class="label">Repos (s)</div>
              <input id="intRest" type="number" min="5" value="10" style="width:100%; padding:10px; border-radius:12px; border:1px solid rgba(255,255,255,.1); background:#0e1322; color:#fff;" />
            </div>
          </div>
          <div class="grid two" style="margin-top:8px">
            <div>
              <div class="label">Cycles</div>
              <input id="intRounds" type="number" min="1" value="8" style="width:100%; padding:10px; border-radius:12px; border:1px solid rgba(255,255,255,.1); background:#0e1322; color:#fff;" />
            </div>
            <div>
              <div class="label">Pr√©paration (s)</div>
              <input id="intPrep" type="number" min="0" value="5" style="width:100%; padding:10px; border-radius:12px; border:1px solid rgba(255,255,255,.1); background:#0e1322; color:#fff;" />
            </div>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn primary" id="intStart">‚ñ∂ D√©marrer</button>
            <button class="btn ghost" id="intStop">Stop</button>
            <div class="chip" id="intPhase">Pr√™t</div>
          </div>
          <div class="timer">
            <div class="time" id="intDisplay">00:00</div>
            <div class="label" id="intRoundInfo">Cycle 0/8</div>
          </div>
        </div>
      </div>
    </section>

    <!-- STATS -->
    <section id="tab-stats">
      <div class="grid">
        <div class="card">
          <div class="row"><div class="h2">Volume & PR</div><div class="badge" id="totalSessions">0 s√©ances</div></div>
          <div class="grid three" style="margin-top:8px">
            <div class="card">
              <div class="label">Reps totales</div>
              <div class="h1" id="totalReps">0</div>
            </div>
            <div class="card">
              <div class="label">Temps d'entra√Ænement</div>
              <div class="h1" id="totalTime">0:00:00</div>
            </div>
            <div class="card">
              <div class="label">Meilleur streak</div>
              <div class="h1" id="bestStreak">0</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="tab-settings">
      <div class="grid">
        <div class="card">
          <div class="h2">Pr√©f√©rences</div>
          <div class="grid two" style="margin-top:8px">
            <label class="row"><span>Signal sonore</span><input id="beepToggle" type="checkbox" checked /></label>
            <label class="row"><span>Haptique (iPhone)</span><input id="hapticsToggle" type="checkbox" checked /></label>
          </div>
        </div>
        <div class="card">
          <div class="row"><div class="h2">Donn√©es</div>
            <div class="controls">
              <button class="btn" id="resetData">R√©initialiser</button>
              <button class="btn" id="markRestDay">Marquer jour OFF</button>
            </div>
          </div>
          <div class="label">Astuce iPhone : Partager ‚Üí ¬´¬†Ajouter √† l‚Äô√©cran d‚Äôaccueil¬†¬ª pour un acc√®s plein √©cran.</div>
        </div>
      </div>
    </section>

    <!-- Bottom tabs -->
    <nav class="tabs pad-safe">
      <a class="tab active" data-tab="today"><div class="ico">üè†</div>Aujourd‚Äôhui</a>
      <a class="tab" data-tab="programs"><div class="ico">üìÖ</div>Programmes</a>
      <a class="tab" data-tab="timer"><div class="ico">‚è±Ô∏è</div>Chronos</a>
      <a class="tab" data-tab="stats"><div class="ico">üìä</div>Stats</a>
      <a class="tab" data-tab="settings"><div class="ico">‚öôÔ∏è</div>R√©glages</a>
    </nav>
  </div>

  <audio id="beep" preload="auto">
    <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAAAAA/////wAA" type="audio/wav">
  </audio>

  <script>
    /************** Data model **************/
    const store = {
      load(){ try{ return JSON.parse(localStorage.getItem('calisfit')) || {}; }catch(e){return{}} },
      save(data){ localStorage.setItem('calisfit', JSON.stringify(data)); }
    };

    const state = Object.assign({
      currentDay: 1,
      currentRound: 1,
      roundsPerHalf: { start:3, end:4 },
      notes: '',
      completed:{}, // day -> true/false
      repsLog:{},    // key "day:round:idx" -> reps
      totals:{ reps:0, time:0, sessions:0, streak:0, bestStreak:0 },
      settings:{ beep:true, haptics:true }
    }, store.load());

    // 30-day plan (identique √† ta version compl√®te ; abr√©g√© ici pour lisibilit√©)
    const PLAN_30 = [
      {"day":1,"title":"Full Body","rounds":3,"items":[
        {"name":"Push-ups","target":"20"},{"name":"Squats","target":"20"},
        {"name":"Pike Push-up","target":"10"},{"name":"Underhand Inverted Row","target":"20"},
        {"name":"Lateral Lunges","target":"10/side"},{"name":"Chair Dips","target":"10"}]},
      {"day":2,"title":"Upper/Lower + Core","rounds":3,"items":[
        {"name":"Dive Bomber Push-ups","target":"15"},{"name":"Chin-ups","target":"AMRAP"},
        {"name":"Reverse Lunge","target":"10/side"},{"name":"Shoulder Tap","target":"20"},
        {"name":"Reverse Crunches","target":"20"},{"name":"Step-up","target":"10/side"}]},
      {"day":3,"title":"Pull ¬∑ Core ¬∑ Legs","rounds":3,"items":[
        {"name":"Squats","target":"20"},{"name":"Pull-ups","target":"AMRAP"},
        {"name":"Diamond Push-ups","target":"20"},{"name":"Floor Windshield Wipers","target":"10/side"},
        {"name":"Curtsy Lunges","target":"10/side"},{"name":"Bird Dog","target":"5/side"}]},
      {"day":4,"title":"OFF / R√©cup","rounds":0,"items":[]}
      // ... pour gagner de la place, les jours 5 √† 30 sont identiques √† ta version
    ];

    /************** Helpers **************/
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    function haptics(){ if(!state.settings?.haptics) return; if(window.navigator && 'vibrate' in navigator){ navigator.vibrate(10); } }
    function beep(){ if(!state.settings?.beep) return; const a = $('#beep'); a.currentTime=0; a.play().catch(()=>{}); }
    function fmtTime(sec){ sec = Math.max(0, Math.floor(sec)); const h=Math.floor(sec/3600), m=Math.floor((sec%3600)/60), s=sec%60; return `${h>0?h+':':''}${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }

    /************** Tabs **************/
    $$('.tab').forEach(t=>t.addEventListener('click',()=>{
      $$('.tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      const id = t.dataset.tab;
      $$('section').forEach(s=>s.classList.remove('active'));
      $('#tab-'+id).classList.add('active');
    }));

    /************** Today screen **************/
    function getDayData(day){ return PLAN_30.find(d=>d.day===day) || PLAN_30[0]; }
    function updateToday(){
      const d = getDayData(state.currentDay);
      $('#todayTitle').textContent = `Jour ${d.day} ¬∑ ${d.title}`;
      $('#todayBadge').textContent = `Semaine ${Math.ceil(d.day/7)} ‚Ä¢ Jour ${d.day}`;
      const rounds = d.rounds || (d.day<=15?3:4);
      const rNow = Math.min(Math.max(1, state.currentRound), Math.max(1, rounds));
      $('#roundChip').textContent = `Manche ${rNow}/${rounds}`;

      const list = $('#workoutList');
      list.innerHTML = '';
      d.items.forEach((ex, idx)=>{
        const key = `${d.day}:${rNow}:${idx}`;
        const reps = state.repsLog[key] || 0;
        const done = !!state.completed[`${d.day}:${rNow}:${idx}`];
        const el = document.createElement('div');
        el.className = 'workout-item'+(done?' done':'');
        el.innerHTML = `
          <div>
            <div class="h2">${ex.name}</div>
            <div class="label">Cible: ${ex.target}</div>
          </div>
          <div class="controls">
            <span class="pill" title="R√©p√©titions compt√©es">${reps} reps</span>
            <div class="counter">
              <button data-act="-" aria-label="Moins">‚àí</button>
              <button data-act="+" aria-label="Plus">+</button>
            </div>
            <button class="btn" data-done="1">‚úî</button>
          </div>`;
        el.querySelector('[data-done]')?.addEventListener('click',()=>{
          state.completed[`${d.day}:${rNow}:${idx}`] = !done;
          if(state.completed[`${d.day}:${rNow}:${idx}`]){ haptics(); beep(); }
          persist(); updateToday(); updateStats();
        });
        el.querySelectorAll('.counter button').forEach(b=>b.addEventListener('click',()=>{
          const act = b.dataset.act; let v = state.repsLog[key]||0; v += (act==='+')?1:-1; v=Math.max(0,v); state.repsLog[key]=v; haptics(); updateToday(); persist();
        }));
        list.appendChild(el);
      });
    }

    $('#prevRound').addEventListener('click',()=>{ state.currentRound = Math.max(1, state.currentRound-1); updateToday(); persist(); });
    $('#nextRound').addEventListener('click',()=>{ const rounds=(getDayData(state.currentDay).rounds|| (state.currentDay<=15?3:4)); state.currentRound = Math.min(rounds, state.currentRound+1); updateToday(); persist(); });

    $('#startSessionBtn').addEventListener('click',()=>{ state.sessionStart = Date.now(); $('#swReset').click(); $('#swStart').click(); haptics(); });

    /************** Rest Timer **************/
    let restSel = 60, restTimer=null, restLeft=0;
    $$('#tab-today [data-rest]').forEach(b=>b.addEventListener('click',()=>{ restSel=+b.dataset.rest; $('#restDisplay').textContent = fmtTime(restSel); }));
    $('#restStart').addEventListener('click',()=>{
      if(restTimer){ clearInterval(restTimer); restTimer=null; }
      restLeft = restSel; $('#restDisplay').textContent = fmtTime(restLeft);
      restTimer = setInterval(()=>{
        restLeft--; $('#restDisplay').textContent = fmtTime(restLeft);
        if(restLeft<=0){ clearInterval(restTimer); restTimer=null; beep(); haptics(); }
      },1000);
    });
    $('#restReset').addEventListener('click',()=>{ if(restTimer){clearInterval(restTimer)}; restTimer=null; restLeft=0; $('#restDisplay').textContent='00:00'; });

    /************** Stopwatch **************/
    let swTimer=null, swStartAt=0;
    function renderSW(){ const t = swTimer? (Date.now()-swStartAt)/1000 : 0; const ms = Math.floor((t%1)*10); const s=Math.floor(t)%60; const m=Math.floor(t/60)%60; const h=Math.floor(t/3600); $('#swDisplay').textContent=`${h?String(h).padStart(2,'0')+':':''}${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}.${ms}`; }
    $('#swStart').addEventListener('click',()=>{
      if(swTimer){ clearInterval(swTimer); swTimer=null; $('#swStart').textContent='D√©marrer';
        const delta = Math.floor((Date.now()-swStartAt)/1000);
        state.totals.time += delta; persist(); updateStats();
      }else{ swStartAt=Date.now(); swTimer=setInterval(renderSW, 100); $('#swStart').textContent='Pause'; }
    });
    $('#swReset').addEventListener('click',()=>{ if(swTimer){ clearInterval(swTimer); swTimer=null; } $('#swDisplay').textContent='00:00.0'; $('#swStart').textContent='D√©marrer'; $('#swLaps').textContent=''; });
    $('#swLap').addEventListener('click',()=>{ const t=$('#swDisplay').textContent; const node=document.createElement('span'); node.textContent = ( $('#swLaps').textContent? ' ¬∑ ' : '' )+t; $('#swLaps').appendChild(node); haptics(); });

    /************** Interval Timer **************/
    let intTimer=null, intPhase='prep', intLeft=0, intRound=0;
    function intRender(){ $('#intDisplay').textContent = fmtTime(intLeft); $('#intPhase').textContent = intPhase.toUpperCase(); $('#intRoundInfo').textContent = `Cycle ${intRound}/${+$('#intRounds').value}`; }
    function intTick(){ intLeft--; intRender(); if(intLeft<=0){
        beep(); haptics();
        if(intPhase==='prep'){ intPhase='work'; intLeft=+$('#intWork').value; }
        else if(intPhase==='work'){ intPhase='rest'; intLeft=+$('#intRest').value; }
        else if(intPhase==='rest'){ intRound++; if(intRound>+$('#intRounds').value){ clearInterval(intTimer); intTimer=null; intPhase='fini'; $('#intPhase').textContent='Termin√©'; return; } intPhase='work'; intLeft=+$('#intWork').value; }
        intRender();
      } }
    $('#intStart').addEventListener('click',()=>{ if(intTimer){clearInterval(intTimer);} intPhase='prep'; intLeft=+$('#intPrep').value; intRound=1; intRender(); intTimer=setInterval(intTick,1000); });
    $('#intStop').addEventListener('click',()=>{ if(intTimer){ clearInterval(intTimer); intTimer=null; } intPhase='stop'; intRender(); });

    /************** Programs list + calendar **************/
    function buildDaysList(){ const box=$('#daysList'); box.innerHTML=''; PLAN_30.forEach(d=>{
      const card=document.createElement('div'); card.className='workout-item';
      const rounds = d.rounds||(d.day<=15?3:4);
      card.innerHTML = `<div><div class="h2">Jour ${d.day} ¬∑ ${d.title||''}</div><div class="label">${rounds} manches ‚Ä¢ ${d.items.length} exos</div></div><div class="controls"><button class="btn" data-go="${d.day}">Aller</button></div>`;
      card.querySelector('[data-go]')?.addEventListener('click',()=>{ state.currentDay=d.day; state.currentRound=1; updateToday(); persist(); $$('.tab[data-tab]')[0].click(); });
      box.appendChild(card);
    });
    $('#daysCount').textContent = `${PLAN_30.length} jours`;
    }

    function buildCalendar(){
      const cal=$('#calendar'); cal.innerHTML='';
      const dt = new Date(); const y=dt.getFullYear(), m=dt.getMonth();
      const first = new Date(y,m,1); const start = first.getDay()||7;
      const days = new Date(y, m+1, 0).getDate();
      for(let i=1;i<start;i++){ const empty=document.createElement('div'); cal.appendChild(empty); }
      for(let d=1; d<=days; d++){
        const el=document.createElement('div'); el.className='day'; el.textContent=d;
        const key = `d${y}-${m+1}-${d}`;
        if(state.calendar?.[key]==='done'){ el.classList.add('done'); }
        if(state.calendar?.[key]==='off'){ el.classList.add('skipped'); }
        el.addEventListener('click',()=>{
          state.calendar = state.calendar||{};
          const cur = state.calendar[key];
          state.calendar[key] = cur==='done' ? 'off' : cur==='off' ? undefined : 'done';
          if(state.calendar[key]==='done'){ state.totals.sessions++; state.totals.streak++; state.totals.bestStreak = Math.max(state.totals.bestStreak, state.totals.streak); }
          else if(state.calendar[key]==='off'){ state.totals.streak=0; }
          updateStats(); persist(); buildCalendar();
        });
        cal.appendChild(el);
      }
    }

    /************** Stats **************/
    function updateStats(){
      let sum=0; for(const k in state.repsLog){ sum += (state.repsLog[k]||0); }
      state.totals.reps = sum;
      $('#totalReps').textContent = String(sum);
      $('#totalTime').textContent = fmtTime(state.totals.time||0);
      $('#totalSessions').textContent = `${state.totals.sessions||0} s√©ances`;
      $('#bestStreak').textContent = String(state.totals.bestStreak||0);
      $('#streakChip').textContent = `üî• S√©rie: ${state.totals.streak||0}`;
    }

    /************** Import/Export **************/
    $('#exportData').addEventListener('click',()=>{
      const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = Object.assign(document.createElement('a'), {href:url, download:'calisfit-data.json'}); a.click(); URL.revokeObjectURL(url);
    });
    $('#importFile').addEventListener('change', (e)=>{
      const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=()=>{ try{ const data=JSON.parse(r.result); Object.assign(state, data); persist(); init(); }catch(err){ alert('Fichier invalide'); } }; r.readAsText(f);
    });

    /************** Settings **************/
    $('#beepToggle').checked = !!state.settings?.beep; $('#hapticsToggle').checked = !!state.settings?.haptics;
    $('#beepToggle').addEventListener('change', e=>{ state.settings.beep = e.target.checked; persist(); });
    $('#hapticsToggle').addEventListener('change', e=>{ state.settings.haptics = e.target.checked; persist(); });
    $('#resetData').addEventListener('click',()=>{ if(confirm('Tout r√©initialiser ?')){ localStorage.removeItem('calisfit'); location.reload(); } });
    $('#markRestDay').addEventListener('click',()=>{ const dt=new Date(); const key=`d${dt.getFullYear()}-${dt.getMonth()+1}-${dt.getDate()}`; state.calendar=state.calendar||{}; state.calendar[key]='off'; state.totals.streak=0; persist(); buildCalendar(); updateStats(); });

    /************** Notes **************/
    $('#notes').value = state.notes||'';
    $('#saveNotes').addEventListener('click',()=>{ state.notes = $('#notes').value; persist(); haptics(); });

    /************** Duplicate plan to 3 months **************/
    $('#duplicate3m').addEventListener('click',()=>{
      alert('Le plan de 30 jours est pr√™t. R√©p√©tez-le 3 fois (3 cycles) en changeant votre jour courant au fur et √† mesure. Les jours OFF sont d√©j√† inclus.');
    });

    /************** Persistence **************/
    function persist(){ store.save(state); }

    /************** Boot **************/
    function init(){ buildDaysList(); buildCalendar(); updateToday(); updateStats(); $('#restDisplay').textContent='00:00'; }
    init();
  </script>

  <!-- Enregistrement du Service Worker PWA -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js').catch(() => {});
      });
    }
  </script>
</body>
</html>